language: java

jdk:
  - oraclejdk8

sudo: required

services:
  - docker

notifications:
    slack: nci-agency:TvRV22whtaRGflaCPPfv2G1v

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - client/node_modules

before_install:
  - docker run --name mssql-server -v ${PWD}:/hostdata -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=P@ssw0rd" -e "DB_NAME=testAnet" -e "DB_USER=anetUser" -e "DB_USER_PASSWORD=P@ssw0rd" -d -p 1433:1433 ncia/anet-mssql-linux
  - nvm install node
  - nvm use node
  - echo "run.environment(\"DB_DRIVER\",\"sqlserver\")" > localSettings.gradle
  - echo "run.environment(\"ANET_DB_SERVER\",\"localhost\")"  >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_NAME\",\"testAnet\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_USERNAME\",\"anetUser\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_PASSWORD\",\"P@ssw0rd\")" >> localSettings.gradle

#By default travis runs gradle assemble in install. This is too early as we don't want to build yet
install:
  - cd client
  - npm install
  - cd ..

script:
  - cd client
  - npm run build
  - cd ..
  - docker exec -ti -e "DB_NAME=testAnet" -e "DB_USER=anetUser" -e "DB_USER_PASSWORD=P@ssw0rd" mssql-server /opt/waitTillServiceStarted.sh
  - ./gradlew dbMigrate
  - docker exec -ti mssql-server /opt/mssql-tools/bin/sqlcmd -S localhost -U anetUser -P P@ssw0rd -d testAnet -i /hostdata/insertBaseData.sql
  - ./gradlew check

after_script:
  - docker logs mssql-server
