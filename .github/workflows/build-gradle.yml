name: Build ANET

on:
  push:
    branches:
    - '**'
    tags:
    - '**'
  pull_request:
    branches:
    - main

env:
  NODE_OPTIONS: '--max-old-space-size=8192'
  DB_DRIVER: postgresql

jobs:
  build:
    name: Build with Gradle
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: ./.github/actions/build-cache
    - run: ./gradlew check -x test
    - run: ./gradlew prettierCheck
    - run: ./gradlew yarn_run_lint
    - run: ./gradlew jar

  test-init:
    needs: build
    name: Test ANET init
    runs-on: ubuntu-latest

    env:
      ANET_ADMIN_ORG_NAME: "ACME Administrators Inc."
      ANET_ADMIN_POS_NAME: "The ANET admin"
      ANET_ADMIN_FULL_NAME: "DOE, John"
      ANET_ADMIN_DOMAIN_USERNAME: "johndoe"
      ANET_CONFIG: "anet-test.yml"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/build-cache
      - run: ./gradlew -PtestEnv dockerCreateDB dockerStartDB
      - run: |
          echo "testMode: true" |
          cat - anet.yml > ${ANET_CONFIG}
      - run: ./gradlew -PtestEnv dbWait
      # This step should fail:
      - name: Run ANET init on empty database
        id: init-on-empty-db
        run: ./gradlew -PtestEnv dbInit
        continue-on-error: true
      - run: exit 1
        if: ${{ steps.init-on-empty-db.outcome != 'failure' }}
      # This step should succeed:
      - name: Run ANET init on clean database
        id: init-on-clean-db
        run: ./gradlew -PtestEnv dbMigrate dbInit
      # This step should fail:
      - name: Run ANET init on filled database
        id: init-on-filled-db
        run: ./gradlew -PtestEnv dbInit
        continue-on-error: true
      - run: exit 1
        if: ${{ steps.init-on-filled-db.outcome != 'failure' }}

  test-server:
    needs: build
    name: Server tests; ${{ matrix.dictionary }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dictionary: [anet-dictionary.yml, testDictionaries/no-custom-fields.yml]

    env:
      ANET_DICTIONARY_NAME: ${{ matrix.dictionary }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: ./.github/actions/build-cache
    - run: ./gradlew -PtestEnv dockerCreateDB dockerStartDB
    - run: ./gradlew -PtestEnv dockerConfigureKeycloak dockerStartKeycloak
    - run: ./gradlew -PtestEnv dockerCreateFakeSmtpServer dockerStartFakeSmtpServer
    - run: ./gradlew -PtestEnv dbWait dbMigrate dbLoad
    - run: ./gradlew -PtestEnv test jacocoTestReport

  test-client:
    needs: build
    name: Client tests; ${{ matrix.client-tests }}, ${{ matrix.dictionary }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dictionary: [anet-dictionary.yml]
        client-tests: [test-jest, test-wdio, test-wdio-ie, test-e2e]
        include:
          - dictionary: testDictionaries/no-custom-fields.yml
            client-tests: test-wdio-noCF

    env:
      ANET_DICTIONARY_NAME: ${{ matrix.dictionary }}
      CLIENT_TESTS: ${{ matrix.client-tests }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: ./.github/actions/build-cache
    - run: ./gradlew -PtestEnv dockerCreateDB dockerStartDB
    - run: ./gradlew -PtestEnv dockerConfigureKeycloak dockerStartKeycloak
    - run: ./gradlew -PtestEnv dockerCreateFakeSmtpServer dockerStartFakeSmtpServer
    - run: ./gradlew -PtestEnv dbWait dbMigrate dbLoad
    - run: |
        ./gradlew -PtestEnv run &
        sleep 15
    - uses: olegtarasov/get-tag@v2.1.2
      id: tagName
    - name: Set local identifier for BrowserStack
      id: browserstack-local
      run: echo "identifier=github-${GITHUB_RUN_ID}-${DB_DRIVER}-${CLIENT_TESTS}" >> $GITHUB_OUTPUT
    - run: ./gradlew yarn_run_${CLIENT_TESTS}
      env:
        GIT_TAG_NAME: ${{ steps.tagName.outputs.tag }}
        BROWSERSTACK_LOCAL_IDENTIFIER: ${{ steps.browserstack-local.outputs.identifier }}
        BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        BROWSERSTACK_USER: ${{ secrets.BROWSERSTACK_USER }}
    - run: head -1000 logs/clientLog.log
      if: always()

  run-storybook:
    needs: build
    name: Storybook
    runs-on: ubuntu-latest

    env:
      ANET_DICTIONARY_NAME: anet-dictionary.yml

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: ./.github/actions/build-cache
    # check if build process stdout and stderr outputs have 'error:'
    - run: |
        ./gradlew yarn_run_start --console=plain &> dev_error.log &
        sleep 30
        ! grep -i -C 2 "error:" dev_error.log
    - run: |
        ./gradlew yarn_run_storybook --console=plain &> storybook_error.log &
        sleep 60
        ! grep -i -C 2 "error:" storybook_error.log
