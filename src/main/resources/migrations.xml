<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<!-- Type for storing UUIDv4 transparantly -->
	<property name="uuid_type" value="varchar(36)" />
	<!-- Convenience functions to generate UUIDv4 on various databases -->
	<property name="uuid_function" value="lower(newid())" dbms="mssql" />
	<!-- Extension "uuid-ossp" should exist already, see `prepare-psql.sql`: -->
	<property name="uuid_function" value="uuid_generate_v4()" dbms="postgresql" />
	<!-- Not really a UUID but who cares? -->
	<property name="uuid_function" value="lower(hex(randomblob(16)))" dbms="sqlite" />

	<!-- Type for storing long text transparantly -->
	<property name="long_text_type" value="nvarchar(max)" dbms="mssql" />
	<property name="long_text_type" value="text" dbms="postgresql,sqlite" />

	<!-- Use a NONCLUSTERED index only for MSSQL -->
	<property name="non_clustered" value="NONCLUSTERED" dbms="mssql" />
	<property name="non_clustered" value="" dbms="postgresql,sqlite" />

	<!-- Full-text search configuration used by PostgreSQL -->
	<property name="fts_config_name" value="anet" dbms="postgresql" />
	<property name="fts_config" value="'${fts_config_name}'" dbms="postgresql" />
	<!-- Full-text search weights -->
	<property name="fts_high" value="'A'" dbms="postgresql" />
	<property name="fts_low" value="'B'" dbms="postgresql" />

	<!-- For storing the avatar -->
	<property name="blob_type" value="blob" dbms="mssql" />
	<property name="blob_type" value="bytea" dbms="postgresql" />

	<changeSet id="1" author="hpitelka">
		<createTable tableName="people">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(255)" />
			<column name="status" type="int" />
			<column name="emailAddress" type="varchar(255)" />
			<column name="phoneNumber" type="varchar(100)" />
			<column name="rank" type="varchar(255)" />
			<column name="biography" type="text" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="role" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="pendingVerification" type="boolean" defaultValue="false" />
		</createTable>

		<createTable tableName="groups">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(512)" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="groupMemberships">
			<column name="groupId" type="int" />
			<column name="personId" type="int" />
		</createTable>

		<createTable tableName="organizations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)" />
			<column name="parentOrgId" type="int" />

			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="poams" >
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>

			<!-- the 1-2 character version (ie EF-5, or B) -->
			<column name="shortName" type="varchar(100)" />

			<!-- The Longer text ie (Rule of Law) or (Get the MoI to handle hiring of people) -->
			<column name="longName" type="varchar(255)" />

			<!-- What type of POAM this is EF, Sub-EF, Milestone, Action, Sub-Action -->
			<column name="category" type="varchar(255)" />

			<!-- the POAM id of the parent of this POAM. null for top level (ie EF/DA) -->
			<column name="parentPoamId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<createTable tableName="positions">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="code" type="varchar(100)" />
			<column name="name" type="varchar(512)" />
			<column name="organizationId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="currentPersonId" type="int" />
			<column name="locationId" type="int" />
		</createTable>

		<createTable tableName="peoplePositions">
			<column name="positionId" type="int" />
			<column name="personId" type="int" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="positionRelationships" >
			<column name="positionId_a" type="int" />
			<column name="positionId_b" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="deleted" type="boolean" />
		</createTable>

		<createTable tableName="reports">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="locationId" type="int" />
			<column name="intent" type="text" />
			<column name="exsum" type="text" />
			<column name="text" type="text" />
			<column name="nextSteps" type="text" />
			<column name="authorId" type="int" />
			<column name="approvalStepId" type="int" />
			<column name="state" type="int" />
			<column name="engagementDate" type="datetime"/>
			<column name="atmosphere" type="int"/>
			<column name="atmosphereDetails" type="text" />
		</createTable>

		<createTable tableName="reportPeople" >
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="isPrimary" type="boolean" defaultValue="false" />
		</createTable>
		<createTable tableName="reportPoams" >
			<column name="reportId" type="int" />
			<column name="poamId" type="int" />
		</createTable>

		<createTable tableName="comments">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="text" type="text" />
		</createTable>

		<createTable tableName="locations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(500)" />
			<column name="lat" type="float" />
			<column name="lng" type="float" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="2" author="hpitelka">
		<createTable tableName="approvalSteps">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="approverGroupId" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="nextStepId" type="int" />
			<column name="advisorOrganizationId" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="approvalActions">
			<column name="approvalStepId" type="int" />
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="type" type="int" />
		</createTable>
	</changeSet>

	<changeSet id="4" author="hpitelka" runInTransaction="false" >
		<sql dbms="mssql">
			IF NOT EXISTS (SELECT 1 FROM sys.fulltext_catalogs WHERE [name] = 'anet_ft_catalog')
				CREATE FULLTEXT CATALOG anet_ft_catalog AS DEFAULT;
		</sql>
		<!-- Key name of PK_TABLE_NAME is autogenerated by Liquidbase on each table w/ a primary key -->
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails) KEY INDEX PK_REPORTS;
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_PEOPLE;
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_POSITIONS;
			CREATE FULLTEXT INDEX ON organizations(name) KEY INDEX PK_ORGANIZATIONS;
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_LOCATIONS;
			CREATE FULLTEXT INDEX ON poams(longName,shortName) KEY INDEX PK_POAMS;
		</sql>
	</changeSet>

	<!-- Liquidbase uses datetime, but SQLServer recommends using datetime2 instead -->
	<changeSet id="5" author="hpitelka" >
		<sql dbms="mssql">
			ALTER TABLE people ALTER COLUMN createdAt datetime2;
			ALTER TABLE people ALTER COLUMN updatedAt datetime2;
			ALTER TABLE groups ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN updatedAt datetime2;

			ALTER TABLE poams ALTER COLUMN createdAt datetime2;
			ALTER TABLE poams ALTER COLUMN updatedAt datetime2;

			ALTER TABLE positions ALTER COLUMN createdAt datetime2;
			ALTER TABLE positions ALTER COLUMN updatedAt datetime2;

			ALTER TABLE peoplePositions ALTER COLUMN createdAt datetime2;

			ALTER TABLE positionRelationships ALTER COLUMN createdAt datetime2;
			ALTER TABLE positionRelationships ALTER COLUMN updatedAt datetime2;

			ALTER TABLE reports ALTER COLUMN createdAt datetime2;
			ALTER TABLE reports ALTER COLUMN updatedAt datetime2;
			ALTER TABLE reports ALTER COLUMN engagementDate datetime2;

			ALTER TABLE comments ALTER COLUMN createdAt datetime2;
			ALTER TABLE comments ALTER COLUMN updatedAt datetime2;

			ALTER TABLE locations ALTER COLUMN createdAt datetime2;
			ALTER TABLE locations ALTER COLUMN updatedAt datetime2;

			ALTER TABLE approvalActions ALTER COLUMN createdAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="6" author="hpitelka">
		<addColumn tableName="people">
			<column name="domainUsername" type="varchar(500)" />
		</addColumn>
	</changeSet>

	<changeSet id="7" author="hpitelka">
		<sql dbms="mssql">
			<!-- really frustrating that I didn't do the not-null constraint above in changeset 5
			  but I didn't so it's here.  If we ever nuke the database, would be nice to clean this up -->
			ALTER TABLE groups ALTER COLUMN createdAt datetime2 NOT NULL;

			ALTER TABLE organizations ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE organizations ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE people ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE people ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE reports ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE reports ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE poams ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE poams ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE positions ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE positions ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE comments ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE comments ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE locations ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE locations ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE positionRelationships ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE positionRelationships ALTER COLUMN updatedAt datetime2 NOT NULL;
			ALTER TABLE approvalActions ALTER COLUMN createdAt datetime2 NOT NULL;
		</sql>
	</changeSet>

	<changeSet id="8" author="hpitelka" dbms="mssql,postgresql" >
		<!-- Groups -->
		<addUniqueConstraint tableName="groupMemberships" columnNames="groupId, personId" constraintName="uniqueGroupMembership" />
		<addNotNullConstraint tableName="groups" columnName="name" columnDataType="varchar(512)" />
		<addForeignKeyConstraint baseColumnNames="groupId" baseTableName="groupMemberships"
			constraintName="fk_groupMember_group" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="groups" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="groupMemberships"
			constraintName="fk_groupMember_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Approval Steps -->
		<addForeignKeyConstraint baseColumnNames="approverGroupId" baseTableName="approvalSteps"
			constraintName="fk_approvalSteps_group" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="groups" />
		<addForeignKeyConstraint baseColumnNames="advisorOrganizationId" baseTableName="approvalSteps"
			constraintName="fk_approvalSteps_orgId" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<!-- Approval Actions -->
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="approvalActions"
			constraintName="fk_approvalActions_step" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="approvalActions"
			constraintName="fk_approvalActions_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Reports -->
		<addNotNullConstraint tableName="reports" columnName="authorId" columnDataType="int" />
		<addNotNullConstraint tableName="reports" columnName="state" columnDataType="int" />
		<addForeignKeyConstraint baseColumnNames="authorId" baseTableName="reports"
			constraintName="fk_reports_author" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="locationId" baseTableName="reports"
			constraintName="fk_reports_location" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="locations" />
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="reports"
			constraintName="fk_reports_approvalStep" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />

		<!-- Report People -->
		<addUniqueConstraint tableName="reportPeople" columnNames="personId, reportId" constraintName="uniqueReportPerson" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="reportPeople"
			constraintName="fk_reportPeople_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportPeople"
			constraintName="fk_reportPeople_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- Report Poams -->
		<addUniqueConstraint tableName="reportPoams" columnNames="poamId, reportId" constraintName="uniqueReportPoam" />
		<addForeignKeyConstraint baseColumnNames="poamId" baseTableName="reportPoams"
			constraintName="fk_reportPoams_poam" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="poams" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportPoams"
			constraintName="fk_reportPoams_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- Poams -->
		<addForeignKeyConstraint baseColumnNames="parentPoamId" baseTableName="poams"
			constraintName="fk_poams_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="poams" />

		<!-- Locations -->
		<addNotNullConstraint tableName="locations" columnName="name" columnDataType="varchar(500)" />

		<!-- Positions -->
		<addNotNullConstraint tableName="positions" columnName="name" columnDataType="varchar(512)" />
		<addForeignKeyConstraint baseColumnNames="currentPersonId" baseTableName="positions"
			constraintName="fk_positions_currPerson" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="positions"
			constraintName="fk_positions_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
		<addForeignKeyConstraint baseColumnNames="locationId" baseTableName="positions"
			constraintName="fk_positions_location" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="locations" />

		<!-- Organizations -->
		<addForeignKeyConstraint baseColumnNames="parentOrgId" baseTableName="organizations"
			constraintName="fk_organizations_parentOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<!-- Comments -->
		<addForeignKeyConstraint baseColumnNames="authorId" baseTableName="comments"
			constraintName="fk_comments_author" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="comments"
			constraintName="fk_comments_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- People Positions -->
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="peoplePositions"
			constraintName="fk_peoplePositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="peoplePositions"
			constraintName="fk_peoplePositions_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Position Relationships -->
		<addForeignKeyConstraint baseColumnNames="positionId_a" baseTableName="positionRelationships"
			constraintName="fk_positionsRelationships_idA" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
		<addForeignKeyConstraint baseColumnNames="positionId_b" baseTableName="positionRelationships"
			constraintName="fk_positionsRelationships_idB" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="9" author="hpitelka" >
		<createTable tableName="adminSettings">
			<column name="key" type="varchar(255)" />
			<column name="value" type="text" />
		</createTable>
	</changeSet>
	<changeSet id="10" author="hpitelka" dbms="mssql,postgresql" >
		<addUniqueConstraint tableName="adminSettings" columnNames="key" constraintName="adminSettingKey" />
	</changeSet>

	<changeSet id="11" author="hpitelka" >
		<createTable tableName="pendingEmails">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="jobSpec" type="text" />
			<column name="createdAt" type="datetime" />
		</createTable>
		<sql dbms="mssql">
			ALTER TABLE pendingEmails ALTER COLUMN createdAt datetime2 NOT NULL;
		</sql>
	</changeSet>

	<changeSet id="12" author="hpitelka" >
		<addColumn tableName="people">
			<column name="country" type="varchar(500)" />
		</addColumn>
		<addColumn tableName="people">
			<column name="gender" type="varchar(64)" />
		</addColumn>
		<addColumn tableName="people">
			<column name="endOfTourDate" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE people ALTER COLUMN endOfTourDate datetime2;
		</sql>
	</changeSet>

	<changeSet id="13" author="hpitelka" >
		<addColumn tableName="poams">
			<column name="organizationId" type="int" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="advisorOrganizationId" type="int" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="principalOrganizationId" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="14" author="hpitelka"  dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="poams"
			constraintName="fk_poams_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<addForeignKeyConstraint baseColumnNames="advisorOrganizationId" baseTableName="reports"
			constraintName="fk_reports_advisorOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<addForeignKeyConstraint baseColumnNames="principalOrganizationId" baseTableName="reports"
			constraintName="fk_reports_principalOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
	</changeSet>

	<changeSet id="15" author="hpitelka" runInTransaction="false" >
		<addColumn tableName="reports">
			<column name="keyOutcomesSummary" type="text" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="keyOutcomes" type="text" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="nextStepsSummary" type="text" />
		</addColumn>

		<sql dbms="mssql">
			ALTER FULLTEXT INDEX ON reports ADD (keyOutcomesSummary, keyOutcomes, nextStepsSummary)
		</sql>
	</changeSet>

	<changeSet id="16" author="hpitelka" >
		<addColumn tableName="organizations">
			<column name="longName" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="17" author="hpitelka" dbms="mssql,postgresql" >
		<renameColumn
			columnDataType="varchar(255)"
			oldColumnName="name"
			newColumnName="shortName"
			tableName="organizations" />
	</changeSet>

	<changeSet id="18" author="hpitelka" dbms="sqlite" >
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="organizations">
			<column name="shortName" type="varchar(255)" />
		</addColumn>
		<dropColumn tableName="organizations" columnName="name" />
	</changeSet>

	<changeSet id="19" author="hpitelka" >
		<createTable tableName="savedSearches">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(512)" />
			<column name="createdAt" type="datetime" />
			<column name="ownerId" type="int" />
			<column name="objectType" type="int" />
			<column name="query" type="text" />
		</createTable>
	</changeSet>

	<changeSet id="20" author="hpitelka"  dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="ownerId" baseTableName="savedSearches"
			constraintName="fk_savedSearch_owner" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
	</changeSet>

	<changeSet id="21" author="hpitelka" dbms="mssql" runInTransaction="false">
		<sql dbms="mssql">
			DROP FULLTEXT INDEX ON organizations;
			CREATE FULLTEXT INDEX ON organizations(shortName, longName) KEY INDEX PK_ORGANIZATIONS;
		</sql>
	</changeSet>

	<changeSet id="22" author="hpitelka" dbms="mssql,postgresql" >
		<dropForeignKeyConstraint baseTableName="groupMemberships" constraintName="fk_groupMember_group" />
		<dropForeignKeyConstraint baseTableName="groupMemberships" constraintName="fk_groupMember_person" />
		<dropForeignKeyConstraint baseTableName="approvalSteps" constraintName="fk_approvalSteps_group" />
	</changeSet>

	<changeSet id="23" author="hpitelka" >
		<dropColumn columnName="approverGroupId" tableName="approvalSteps" />
		<dropTable tableName="groupMemberships" />
		<dropTable tableName="groups" />
		<createTable tableName="approvers" >
			<column name="approvalStepId" type="int" />
			<column name="positionId" type="int" />
		</createTable>
		<addColumn tableName="approvalSteps" >
			<column name="name" type="varchar(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="24" author="hpitelka" dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="approvers"
			constraintName="fk_approvers_step" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="approvers"
			constraintName="fk_approvers_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="25" author="hpitelka"  >
		<sql dbms="mssql">
			ALTER FULLTEXT INDEX ON reports DROP (keyOutcomesSummary, nextStepsSummary)
		</sql>
		<dropColumn tableName="reports" columnName="keyOutcomesSummary" />
		<dropColumn tableName="reports" columnName="nextStepsSummary" />
	</changeSet>

	<changeSet id="26" author="hpitelka" >
		<addColumn tableName="reports" >
			<column name="cancelledReason" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="27" author="hpitelka" >
		<addColumn tableName="reports">
			<column name="releasedAt" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE reports ALTER COLUMN releasedAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="28" author="hpitelka" >
		<addColumn tableName="positions" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<!-- Found out that varchar and text don't support Unicode, so changing to nvarchar and ntext
		Then found out that MSSQL is dropping support for text/ntext in favor of nvarchar(max)
		And you can't modify columns that are in a fulltext index... so have to re-build those.
	-->
	<changeSet id="29" author="hpitelka" runInTransaction="false" >
		<sql dbms="mssql">
			DROP FULLTEXT INDEX ON people;
			ALTER TABLE people ALTER COLUMN name nvarchar(255);
			ALTER TABLE people ALTER COLUMN biography nvarchar(max);
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_PEOPLE;
			ALTER TABLE people ALTER COLUMN domainUsername nvarchar(512);

			DROP FULLTEXT INDEX on organizations;
			ALTER TABLE organizations ALTER COLUMN longName nvarchar(255);
			ALTER TABLE organizations ALTER COLUMN shortName nvarchar(255);
			CREATE FULLTEXT INDEX ON organizations(longName, shortName) KEY INDEX PK_ORGANIZATIONS;

			DROP FULLTEXT INDEX ON poams;
			ALTER TABLE poams ALTER COLUMN shortName nvarchar(255);
			ALTER TABLE poams ALTER COLUMN longName nvarchar(max);
			CREATE FULLTEXT INDEX ON poams(longName,shortName) KEY INDEX PK_POAMS;

			DROP FULLTEXT INDEX ON positions;
			ALTER TABLE positions ALTER COLUMN code nvarchar(100);
			ALTER TABLE positions ALTER COLUMN name nvarchar(512);
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_POSITIONS;

			DROP FULLTEXT INDEX ON reports;
			ALTER TABLE reports ALTER COLUMN intent nvarchar(max);
			ALTER TABLE reports ALTER COLUMN exsum nvarchar(max);
			ALTER TABLE reports ALTER COLUMN text nvarchar(max);
			ALTER TABLE reports ALTER COLUMN nextSteps nvarchar(max);
			ALTER TABLE reports ALTER COLUMN keyOutcomes nvarchar(max);
			ALTER TABLE reports ALTER COLUMN atmosphereDetails nvarchar(max);
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails, keyOutcomes) KEY INDEX PK_REPORTS;

			ALTER TABLE comments ALTER COLUMN text nvarchar(max);

			DROP FULLTEXT INDEX ON locations;
			ALTER TABLE locations ALTER COLUMN name nvarchar(512);
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_LOCATIONS;

			ALTER TABLE approvalSteps ALTER COLUMN name nvarchar(255);

			ALTER TABLE adminSettings ALTER COLUMN value nvarchar(max);

			ALTER TABLE pendingEmails ALTER COLUMN jobSpec nvarchar(max);

			ALTER TABLE savedSearches ALTER COLUMN name nvarchar(512);
			ALTER TABLE savedSearches ALTER COLUMN query nvarchar(max);
		</sql>
	</changeSet>

	<!-- partial unique index syntax varies by database (if available) -->
	<changeSet id="30" author="hpitelka" dbms="mssql" >
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX UniqueCurrentPersonInPosition ON positions (currentPersonId) WHERE currentPersonId IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="30p" author="bwarfield" dbms="postgresql,sqlite" >
		<comment>Create a unique index for "positions.currentPersonId", excluding nulls.</comment>
		<sql>
			CREATE UNIQUE INDEX "UniqueCurrentPersonInPosition" ON positions ("currentPersonId") WHERE "currentPersonId" IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		</rollback>
	</changeSet>

	<changeSet id="31" author="hpitelka" dbms="mssql" >
		<sql dbms="mssql">
			ALTER FULLTEXT CATALOG anet_ft_catalog REBUILD WITH ACCENT_SENSITIVITY = OFF
		</sql>
	</changeSet>

	<changeSet id="32" author="hpitelka" >
		<!-- this syntax works in SQL Server and SQLite, but not postgresql. Since we already have
		     to add a catch-up migration, restricting this to mssql only (which could cause problems
			 for anybody with a long-running installation using sqlite, but that seems like an unlikely
			 contingency).
		-->
		<sql dbms="mssql">
			INSERT INTO adminSettings ([key], value) VALUES ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', '14');
		</sql>
	</changeSet>

	<changeSet id="33" author="hpitelka" >
		<addColumn tableName="poams" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<!-- partial unique index syntax varies by database (if available) -->
	<changeSet id="34" author="hpitelka" dbms="mssql" >
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX UniquePositionCodes ON positions (code) WHERE code IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="34p" author="bwarfield" dbms="postgresql,sqlite">
		<comment>Create a unique index for "positions.currentPersonId", excluding nulls.</comment>
		<sql>
			CREATE UNIQUE INDEX "UniquePositionCodes" ON positions(code) WHERE code IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		</rollback>
	</changeSet>

	<changeSet id="35" author="evdhoudt" dbms="mssql" >
		<sql>
			INSERT INTO adminSettings ([key], value) VALUES ('EXTERNAL_DOCUMENTATION_LINK_URL', '');
		</sql>
	</changeSet>

	<changeSet id="add_tags" author="gjvoosten">
		<createTable tableName="tags">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="nvarchar(100)">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="nvarchar(512)" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_report_tags" author="gjvoosten">
		<createTable tableName="reportTags">
			<column name="reportId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="tagId" type="int">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_report_tags_constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="reportTags" columnNames="reportId, tagId" constraintName="uniqueReportTag" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportTags"
			constraintName="fk_reportTags_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />
		<addForeignKeyConstraint baseColumnNames="tagId" baseTableName="reportTags"
			constraintName="fk_reportTags_tag" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tags" />
	</changeSet>

	<changeSet id="add-banner-text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_TEXT" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_TEXT'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_TEXT" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_TEXT'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-level" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_LEVEL" />
			<column name="value" value="notice" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_LEVEL'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-visibility" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_VISIBILITY" />
			<column name="value" value="1" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_VISIBILITY'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add_external_documentation_link_text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="EXTERNAL_DOCUMENTATION_LINK_TEXT" />
			<column name="value" value="External documentation" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'EXTERNAL_DOCUMENTATION_LINK_URL'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add_tags_fulltext_index" author="maradragan" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON tags(name, description) KEY INDEX PK_TAGS;
		</sql>
		<rollback>
			DROP FULLTEXT INDEX ON tags;
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_identificationCode" author="gjvoosten">
		<addColumn tableName="organizations">
			<column name="identificationCode" type="nvarchar(100)" />
		</addColumn>
	</changeSet>

	<!-- separate migrations for SQL Server and other DBMS systems -->
	<changeSet id="add_organizations_identificationCode_constraints" author="gjvoosten" dbms="mssql">
		<!-- Use SQL because we want to allow NULLs while still requiring non-NULL and non-empty columns to be unique -->
		<comment>Add a partial unique index to force non-empty organization codes to be unique.</comment>
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX uniqueOrganizationIdentificationCode
			ON organizations ( identificationCode )
			WHERE identificationCode IS NOT NULL
			AND identificationCode != '';
		</sql>
		<rollback>
			DROP INDEX uniqueOrganizationIdentificationCode ON organizations;
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="add_organizations_identificationCode_constraints_pg" author="bwarfield" dbms="postgresql,sqlite">
		<comment>Add a partial unique index to force non-empty organization codes to be unique.</comment>
		<!-- Use SQL because we want to allow NULLs while still requiring non-NULL and non-empty columns to be unique -->
		<sql>
			CREATE UNIQUE INDEX "uniqueOrganizationIdentificationCode"
			ON organizations ( "identificationCode" )
			WHERE "identificationCode" IS NOT NULL
			AND "identificationCode" != '';
		</sql>
		<rollback>
			<dropIndex tableName="organizations" indexName="uniqueOrganizationIdentificationCode" />
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_identificationCode_to_fulltext_index" author="gjvoosten" dbms="mssql">
		<sql>
			ALTER FULLTEXT INDEX ON organizations ADD ( identificationCode );
		</sql>
		<rollback>
			ALTER FULLTEXT INDEX ON organizations DROP ( identificationCode );
		</rollback>
	</changeSet>

	<changeSet id="add_reports_sensitive_information" author="gjvoosten" dbms="mssql">
		<createTable tableName="reportsSensitiveInformation">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="text" type="nvarchar(max)" />
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<!-- a better way to do this would be to have a single migration using a modifySql
	     tag: http://www.liquibase.org/documentation/modify_sql.html (but that would change the
		 checksum, so we can't do it with an already-run migration) -->
	<changeSet id="add_reports_sensitive_information_no_nvarchar" author="bwarfield" dbms="postgresql,sqlite">
		<createTable tableName="reportsSensitiveInformation">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="text" type="text" />
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_reports_sensitive_information_constraints" author="gjvoosten" dbms="mssql,postgresql">
    	<!-- Add unique constraint because we want to enforce a one-to-one relationship between reports and reportsSensitiveInformation -->
		<addUniqueConstraint tableName="reportsSensitiveInformation" columnNames="reportId" constraintName="uniqueReport" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportsSensitiveInformation"
			constraintName="fk_reportsSensitiveInformation_report" onDelete="CASCADE" onUpdate="CASCADE"
			referencedColumnNames="id" referencedTableName="reports" />
	</changeSet>

	<changeSet id="add_positions_authorized" author="gjvoosten">
		<addColumn tableName="positions">
			<column name="authorized" type="boolean" defaultValue="false">
				<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="renamePoams-to-Tasks" author="evdhoudt" dbms="mssql,postgresql">
		<!-- Tasks -->
		<renameTable
			newTableName="tasks"
			oldTableName="poams" />
		<renameColumn
			columnDataType="int"
			oldColumnName="parentPoamId"
			newColumnName="parentTaskId"
			tableName="tasks" />

		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_poams_parent"/>
		<addForeignKeyConstraint baseColumnNames="parentTaskId" baseTableName="tasks"
			constraintName="fk_tasks_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />
		<rollback>
			<!-- sadly, 'dropforeignkeyconstraint' does not have an auto-rollback, so we have to do a manual rollback for everything -->
			<renameColumn
				columnDataType="int"
				newColumnName="parentPoamId"
				oldColumnName="parentTaskId"
				tableName="tasks" />
			<renameTable
				newTableName="poams"
				oldTableName="tasks" />
			<dropForeignKeyConstraint baseTableName="poams" constraintName="fk_tasks_parent"/>
			<addForeignKeyConstraint baseColumnNames="parentPoamId" baseTableName="poams"
				constraintName="fk_poams_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
				referencedColumnNames="id" referencedTableName="poams" />

		</rollback>
	</changeSet>

	<changeSet id="renameReportPoams-to-ReportTasks" author="evdhoudt" dbms="mssql,postgresql">
		<!-- Report Tasks -->
		<renameTable
			newTableName="reportTasks"
			oldTableName="reportPoams" />
		<renameColumn
			columnDataType="int"
			oldColumnName="poamId"
			newColumnName="taskId"
			tableName="reportTasks" />
	</changeSet>

	<changeSet id="renamePoams-to-Tasks-sqlite-combined-tables" author="bwarfield" dbms="sqlite">
		<comment>Rename poams and taskPoams, and add new columns.</comment>
		<!-- Tasks -->
		<renameTable
			newTableName="tasks"
			oldTableName="poams" />
		<!-- reportTasks -->
		<renameTable
			newTableName="reportTasks"
			oldTableName="reportPoams" />
	</changeSet>

	<changeSet id="renamePoams-to-Tasks-sqlite-combined-columns" author="bwarfield" dbms="sqlite">
		<comment>Create and populate new task ID columns, but leave the old ones in place because sqlite does not support dropping columns.</comment>
		<sql>
			ALTER TABLE tasks add column parentTaskId int;
			ALTER TABLE reportTasks add column taskId int;
			UPDATE tasks set parentTaskId = parentPoamId;
			UPDATE reportTasks set taskId = poamId;
		</sql>
		<rollback>
			UPDATE tasks set parentPoamId = parentTaskId;
			UPDATE reportTasks set poamId = taskId;
		</rollback>
	</changeSet>

	<changeSet id="renameConstraints-Poams-to-Tasks" author="evdhoudt" dbms="mssql,postgresql">
		<dropUniqueConstraint tableName="reportTasks" constraintName="uniqueReportPoam"/>
		<addUniqueConstraint tableName="reportTasks" columnNames="taskId, reportId" constraintName="uniqueReportTask" />

		<dropForeignKeyConstraint baseTableName="reportTasks" constraintName="fk_reportPoams_poam"/>
		<addForeignKeyConstraint baseColumnNames="taskId" baseTableName="reportTasks"
			constraintName="fk_reportTasks_poam" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />

		<dropForeignKeyConstraint baseTableName="reportTasks" constraintName="fk_reportPoams_report"/>
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportTasks"
			constraintName="fk_reportTasks_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_poams_org"/>
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="tasks"
			constraintName="fk_tasks_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
	</changeSet>

	<changeSet id="add-extra-fields-to-Tasks" author="evdhoudt">
		<addColumn tableName="tasks">
			<column name="projectedCompletion" type="datetime" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="plannedCompletion" type="datetime" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="customField" type="text" />
		</addColumn>
		<addColumn tableName="tasks" >
			<column name="customFieldEnum" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="36" author="bwarfield" dbms="postgresql,sqlite">
		<comment>This is a repeat of migrations 32 and 35, with a more generic syntax.</comment>
		<sql>
			INSERT INTO "adminSettings" ("key", "value") VALUES ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', '14');
			INSERT INTO "adminSettings" ("key", "value") VALUES ('EXTERNAL_DOCUMENTATION_LINK_URL', '');
		</sql>
		<rollback>
			DELETE FROM "adminSettings"
			WHERE "key" in ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', 'EXTERNAL_DOCUMENTATION_LINK_URL')
		</rollback>
	</changeSet>

	<changeSet id="add_authorization_groups" author="maradragan">
		<createTable tableName="authorizationGroups">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="nvarchar(100)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="nvarchar(512)" />
			<column name="status" type="int" defaultValue="0">
				<constraints nullable="false"/>
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_authorization_group_positions" author="maradragan">
		<createTable tableName="authorizationGroupPositions">
			<column name="authorizationGroupId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="positionId" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_authorization_group_positions_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="authorizationGroupPositions" columnNames="authorizationGroupId, positionId" constraintName="uniqueAuthorizationGroupPositions" />
		<addForeignKeyConstraint baseColumnNames="authorizationGroupId" baseTableName="authorizationGroupPositions"
			constraintName="fk_authorizationGroupPositions_authorizationGroup" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="authorizationGroups" />
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="authorizationGroupPositions"
			constraintName="fk_authorizationGroupPositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="add_report_authorization_groups" author="maradragan">
		<createTable tableName="reportAuthorizationGroups">
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="authorizationGroupId" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_report_authorization_groups_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="reportAuthorizationGroups" columnNames="reportId, authorizationGroupId" constraintName="uniqueReportAuthorizationGroup" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportAuthorizationGroups"
			constraintName="fk_reportAuthorizationGroups_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />
		<addForeignKeyConstraint baseColumnNames="authorizationGroupId" baseTableName="reportAuthorizationGroups"
			constraintName="fk_reportAuthorizationGroups_authorizationGroup" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="authorizationGroups" />
	</changeSet>

	<changeSet id="add_authorizationGroups_fulltext_index" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON authorizationGroups(name, description) KEY INDEX PK_AUTHORIZATIONGROUPS;
		</sql>
		<rollback>
			DROP FULLTEXT INDEX ON authorizationGroups;
		</rollback>
	</changeSet>

	<changeSet id="migrated_authorized_positions" author="gjvoosten" dbms="mssql">
		<sql>
			INSERT INTO authorizationGroups (name, description, status, createdAt, updatedAt)
				SELECT
					CONCAT('Authorized positions for ', o.shortName),
					CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']'),
					0,
					CURRENT_TIMESTAMP,
					CURRENT_TIMESTAMP
				FROM organizations o
				WHERE EXISTS (
					SELECT p.id
					FROM positions p
					WHERE p.organizationId = o.id
					AND p.authorized = 1
				)
			;

			INSERT INTO authorizationGroupPositions (authorizationGroupId, positionId)
				SELECT DISTINCT ag.id, p.id
				FROM authorizationGroups ag,
				positions p
				JOIN organizations o ON o.id = p.organizationId
				WHERE ag.description = CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']')
				AND p.authorized = 1
			;

			INSERT INTO reportAuthorizationGroups (reportId, authorizationGroupId)
				SELECT DISTINCT r.id, ag.id
				FROM reports r
				JOIN organizations o ON o.id = r.advisorOrganizationId
				JOIN reportsSensitiveInformation rsi ON rsi.reportId = r.id,
				authorizationGroups ag
				WHERE ag.description = CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']')
			;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop_positions_authorized" author="gjvoosten" dbms="mssql,postgresql">
	    <!-- Some magic to make sure any auto-generated database constraints are dropped -->
		<dropNotNullConstraint tableName="positions" columnName="authorized" columnDataType="boolean" />
		<dropDefaultValue tableName="positions" columnName="authorized" columnDataType="boolean" />
		<!-- Then drop the column itself -->
		<dropColumn tableName="positions" columnName="authorized" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="update-extra-fields-to-Tasks" author="evdhoudt" dbms="mssql">
		<modifyDataType columnName="customField" newDataType="nvarchar(max)" tableName="tasks" />
		<modifyDataType columnName="customFieldEnum" newDataType="nvarchar(max)" tableName="tasks" />
	</changeSet>

	<changeSet id="add_tasks_customField_to_fulltext_index" author="evdhoudt" dbms="mssql" runInTransaction="false">
		<sql>
			ALTER FULLTEXT INDEX ON tasks ADD ( customField );
		</sql>
		<rollback>
			ALTER FULLTEXT INDEX ON tasks DROP ( customField );
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_status" author="gjvoosten" >
		<addColumn tableName="organizations" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add_locations_status" author="gjvoosten" >
		<addColumn tableName="locations" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-field-enum-2-to-Tasks" author="maradragan" dbms="mssql">
		<addColumn tableName="tasks" >
			<column name="customFieldEnum2" type="nvarchar(max)" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-field-enum-2-to-Tasks-no-mssql" author="maradragan" dbms="postgresql,sqlite">
		<addColumn tableName="tasks" >
			<column name="customFieldEnum2" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="rename-custom-field-enum-in-tasks" author="maradragan" dbms="mssql,postgresql">
		<renameColumn
			columnDataType="nvarchar(max)"
			oldColumnName="customFieldEnum"
			newColumnName="customFieldEnum1"
			tableName="tasks" />
	</changeSet>

	<changeSet id="rename-custom-field-enum-in-tasks-sqlite" author="maradragan" dbms="sqlite">
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="tasks">
			<column name="customFieldEnum1" type="text" />
		</addColumn>
		<dropColumn tableName="tasks" columnName="customFieldEnum" />
	</changeSet>

	<changeSet id="migrate_duplicate_savedSearches" author="gjvoosten" dbms="mssql">
		<sql>
			UPDATE dups
			SET name = name + ' (' + cast(NEWID() as varchar(40)) + ')'
			FROM (
			  SELECT
			    name,
			    ROW_NUMBER() OVER (PARTITION BY ownerId, name ORDER BY name) AS r
			  FROM savedSearches
			) dups
			WHERE r > 1
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add_unique_savedSearches_constraint" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="savedSearches" columnNames="ownerId, name" constraintName="uniqueOwnerIdName" />
	</changeSet>

	<changeSet id="rename-parent-task-in-tasks" author="maradragan" dbms="mssql,postgresql">
		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_tasks_parent"/>
		<renameColumn
			columnDataType="int"
			oldColumnName="parentTaskId"
			newColumnName="customFieldRef1Id"
			tableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="customFieldRef1Id" baseTableName="tasks"
			constraintName="fk_tasks_customFieldRef1Id" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />
		<rollback>
			<!-- sadly, 'dropforeignkeyconstraint' does not have an auto-rollback, so we have to do a manual rollback for everything -->
			<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_tasks_customFieldRef1Id"/>
			<renameColumn
				columnDataType="int"
				newColumnName="parentTaskId"
				oldColumnName="customFieldRef1Id"
				tableName="tasks" />
			<addForeignKeyConstraint baseColumnNames="parentTaskId" baseTableName="tasks"
				constraintName="fk_tasks_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
				referencedColumnNames="id" referencedTableName="tasks" />
		</rollback>
	</changeSet>

	<changeSet id="rename-parent-task-in-tasks-sqlite" author="maradragan" dbms="sqlite">
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="tasks">
			<column name="customFieldRef1Id" type="int" />
		</addColumn>
		<sql>
			UPDATE tasks set customFieldRef1Id = parentTaskId;
		</sql>
		<dropColumn tableName="tasks" columnName="parentTaskId" />
		<rollback>
			<addColumn tableName="tasks">
				<column name="parentTaskId" type="int" />
			</addColumn>
			<sql>
				UPDATE tasks set parentTaskId = customFieldRef1Id;
			</sql>
			<dropColumn tableName="tasks" columnName="customFieldRef1" />
		</rollback>
	</changeSet>

	<changeSet id="cleanup-map-layers-from-adminSettings" author="VassilIordanov" dbms="mssql">
		<delete tableName="adminSettings">
			<where>[key] = 'MAP_LAYERS'</where>
		</delete>
	</changeSet>

	<changeSet id="add_unique_tasks_shortName_constraint" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="tasks" columnNames="shortName" constraintName="UQ_TaskShortName" />
	</changeSet>

	<changeSet id="add-uuid-primaryKey-columns" author="gjvoosten">
		<addColumn tableName="approvalSteps">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroups">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="locations">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="organizations">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="people">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportsSensitiveInformation">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="savedSearches">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tags">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-foreignKey-columns" author="gjvoosten">
		<addColumn tableName="approvalActions">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalActions">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalActions">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalSteps">
			<column name="advisorOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalSteps">
			<column name="nextStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvers">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvers">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroupPositions">
			<column name="authorizationGroupUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroupPositions">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="authorUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="organizations">
			<column name="parentOrgUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="peoplePositions">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="peoplePositions">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positionRelationships">
			<column name="positionUuid_a" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positionRelationships">
			<column name="positionUuid_b" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="currentPersonUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="locationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="organizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportAuthorizationGroups">
			<column name="authorizationGroupUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportAuthorizationGroups">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportPeople">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportPeople">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="advisorOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="authorUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="locationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="principalOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportsSensitiveInformation">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTags">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTags">
			<column name="tagUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTasks">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTasks">
			<column name="taskUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="savedSearches">
			<column name="ownerUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="customFieldRef1Uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="organizationUuid" type="${uuid_type}" />
		</addColumn>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="fill-uuid-primaryKey-columns" author="gjvoosten">
		<!--
			If on postgresql, make sure to enable uuid generation before running this changeset:
				CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
		-->
		<!-- Generate new uuid's for all tables -->
		<sql>
			UPDATE "approvalSteps" SET uuid = ${uuid_function};
			UPDATE "authorizationGroups" SET uuid = ${uuid_function};
			UPDATE comments SET uuid = ${uuid_function};
			UPDATE locations SET uuid = ${uuid_function};
			UPDATE organizations SET uuid = ${uuid_function};
			UPDATE people SET uuid = ${uuid_function};
			UPDATE positions SET uuid = ${uuid_function};
			UPDATE reports SET uuid = ${uuid_function};
			UPDATE "reportsSensitiveInformation" SET uuid = ${uuid_function};
			UPDATE "savedSearches" SET uuid = ${uuid_function};
			UPDATE tags SET uuid = ${uuid_function};
			UPDATE tasks SET uuid = ${uuid_function};
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="fill-uuid-foreignKey-columns" author="gjvoosten">
		<!-- Fill uuid references for all tables -->
		<sql>
			UPDATE "adminSettings" SET value = (
				SELECT uuid FROM organizations
				WHERE organizations.id = CAST(value AS int)
			)
			WHERE "key" = 'DEFAULT_APPROVAL_ORGANIZATION';
		</sql>
		<sql>
			UPDATE "approvalActions" SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = "approvalActions"."approvalStepId"
			);
			UPDATE "approvalActions" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "approvalActions"."personId"
			);
			UPDATE "approvalActions" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "approvalActions"."reportId"
			);
			UPDATE "approvalSteps" SET "advisorOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = "approvalSteps"."advisorOrganizationId"
			);
			UPDATE "approvalSteps" SET "nextStepUuid" = (
				SELECT a2.uuid FROM "approvalSteps" a2
				WHERE a2.id = "approvalSteps"."nextStepId"
			);
			UPDATE approvers SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = approvers."approvalStepId"
			);
			UPDATE approvers SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = approvers."positionId"
			);
			UPDATE "authorizationGroupPositions" SET "authorizationGroupUuid" = (
				SELECT uuid FROM "authorizationGroups"
				WHERE "authorizationGroups".id = "authorizationGroupPositions"."authorizationGroupId"
			);
			UPDATE "authorizationGroupPositions" SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = "authorizationGroupPositions"."positionId"
			);
			UPDATE comments SET "authorUuid" = (
				SELECT uuid FROM people
				WHERE people.id = comments."authorId"
			);
			UPDATE comments SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = comments."reportId"
			);
			UPDATE organizations SET "parentOrgUuid" = (
				SELECT o2.uuid FROM organizations o2
				WHERE o2.id = organizations."parentOrgId"
			);
			UPDATE "peoplePositions" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "peoplePositions"."personId"
			);
			UPDATE "peoplePositions" SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = "peoplePositions"."positionId"
			);
			UPDATE "positionRelationships" SET "positionUuid_a" = (
				SELECT uuid FROM positions
				WHERE positions.id = "positionRelationships"."positionId_a"
			);
			UPDATE "positionRelationships" SET "positionUuid_b" = (
				SELECT uuid FROM positions
				WHERE positions.id = "positionRelationships"."positionId_b"
			);
			UPDATE positions SET "currentPersonUuid" = (
				SELECT uuid FROM people
				WHERE people.id = positions."currentPersonId"
			);
			UPDATE positions SET "locationUuid" = (
				SELECT uuid FROM locations
				WHERE locations.id = positions."locationId"
			);
			UPDATE positions SET "organizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = positions."organizationId"
			);
			UPDATE "reportAuthorizationGroups" SET "authorizationGroupUuid" = (
				SELECT uuid FROM "authorizationGroups"
				WHERE "authorizationGroups".id = "reportAuthorizationGroups"."authorizationGroupId"
			);
			UPDATE "reportAuthorizationGroups" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportAuthorizationGroups"."reportId"
			);
			UPDATE "reportPeople" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "reportPeople"."personId"
			);
			UPDATE "reportPeople" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportPeople"."reportId"
			);
			UPDATE reports SET "advisorOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = reports."advisorOrganizationId"
			);
			UPDATE reports SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = reports."approvalStepId"
			);
			UPDATE reports SET "authorUuid" = (
				SELECT uuid FROM people
				WHERE people.id = reports."authorId"
			);
			UPDATE reports SET "locationUuid" = (
				SELECT uuid FROM locations
				WHERE locations.id = reports."locationId"
			);
			UPDATE reports SET "principalOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = reports."principalOrganizationId"
			);
			UPDATE "reportsSensitiveInformation" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportsSensitiveInformation"."reportId"
			);
			UPDATE "reportTags" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportTags"."reportId"
			);
			UPDATE "reportTags" SET "tagUuid" = (
				SELECT uuid FROM tags
				WHERE tags.id = "reportTags"."tagId"
			);
			UPDATE "reportTasks" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportTasks"."reportId"
			);
			UPDATE "reportTasks" SET "taskUuid" = (
				SELECT uuid FROM tasks
				WHERE tasks.id = "reportTasks"."taskId"
			);
			UPDATE "savedSearches" SET "ownerUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "savedSearches"."ownerId"
			);
			UPDATE tasks SET "customFieldRef1Uuid" = (
				SELECT t2.uuid FROM tasks t2
				WHERE t2.id = tasks."customFieldRef1Id"
			);
			UPDATE tasks SET "organizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = tasks."organizationId"
			);
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-fullText-indexes" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			DROP FULLTEXT INDEX ON authorizationGroups;
			DROP FULLTEXT INDEX ON locations;
			DROP FULLTEXT INDEX ON people;
			DROP FULLTEXT INDEX ON positions;
			DROP FULLTEXT INDEX ON reports;
			DROP FULLTEXT INDEX ON tags;
			DROP FULLTEXT INDEX ON tasks;
			DROP FULLTEXT INDEX on organizations;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-unique-indexes" author="gjvoosten">
		<dropIndex tableName="organizations" indexName="uniqueOrganizationIdentificationCode" />
		<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-foreignKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropForeignKeyConstraint
			baseTableName="approvalActions" constraintName="fk_approvalActions_step" />
		<dropForeignKeyConstraint
			baseTableName="approvalActions" constraintName="fk_approvalActions_person" />

		<dropForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="fk_approvalSteps_orgId" />

		<dropForeignKeyConstraint
			baseTableName="approvers" constraintName="fk_approvers_step" />
		<dropForeignKeyConstraint
			baseTableName="approvers" constraintName="fk_approvers_position" />

		<dropForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="fk_authorizationGroupPositions_authorizationGroup" />
		<dropForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="fk_authorizationGroupPositions_position" />

		<dropForeignKeyConstraint
			baseTableName="comments" constraintName="fk_comments_author" />
		<dropForeignKeyConstraint
			baseTableName="comments" constraintName="fk_comments_report" />

		<dropForeignKeyConstraint
			baseTableName="organizations" constraintName="fk_organizations_parentOrg" />

		<dropForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="fk_peoplePositions_person" />
		<dropForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="fk_peoplePositions_position" />

		<dropForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="fk_positionsRelationships_idA" />
		<dropForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="fk_positionsRelationships_idB" />

		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_currPerson" />
		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_location" />
		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_org" />

		<dropForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="fk_reportAuthorizationGroups_authorizationGroup" />
		<dropForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="fk_reportAuthorizationGroups_report" />

		<dropForeignKeyConstraint
			baseTableName="reportPeople" constraintName="fk_reportPeople_person" />
		<dropForeignKeyConstraint
			baseTableName="reportPeople" constraintName="fk_reportPeople_report" />

		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_advisorOrg" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_approvalStep" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_author" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_location" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_principalOrg" />

		<dropForeignKeyConstraint
			baseTableName="reportsSensitiveInformation" constraintName="fk_reportsSensitiveInformation_report" />

		<dropForeignKeyConstraint
			baseTableName="reportTags" constraintName="fk_reportTags_report" />
		<dropForeignKeyConstraint
			baseTableName="reportTags" constraintName="fk_reportTags_tag" />

		<dropForeignKeyConstraint
			baseTableName="reportTasks" constraintName="fk_reportTasks_poam" />
		<dropForeignKeyConstraint
			baseTableName="reportTasks" constraintName="fk_reportTasks_report" />

		<dropForeignKeyConstraint
			baseTableName="savedSearches" constraintName="fk_savedSearch_owner" />

		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="fk_tasks_org"/>
		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="fk_tasks_customFieldRef1Id"/>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-unique-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropUniqueConstraint
			tableName="authorizationGroupPositions" constraintName="uniqueAuthorizationGroupPositions" />
		<dropUniqueConstraint
			tableName="reportAuthorizationGroups" constraintName="uniqueReportAuthorizationGroup" />
		<dropUniqueConstraint
			tableName="reportPeople" constraintName="uniqueReportPerson" />
		<dropUniqueConstraint
			tableName="reportTags" constraintName="uniqueReportTag" />
		<dropUniqueConstraint
			tableName="reportTasks" constraintName="uniqueReportTask" />
		<dropUniqueConstraint
			tableName="reportsSensitiveInformation" constraintName="uniqueReport" />
		<dropUniqueConstraint
			tableName="savedSearches" constraintName="uniqueOwnerIdName" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-primaryKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropPrimaryKey
			tableName="approvalSteps" />
		<dropPrimaryKey
			tableName="authorizationGroups" />
		<dropPrimaryKey
			tableName="comments" />
		<dropPrimaryKey
			tableName="locations" />
		<dropPrimaryKey
			tableName="organizations" />
		<dropPrimaryKey
			tableName="people" />
		<dropPrimaryKey
			tableName="positions" />
		<dropPrimaryKey
			tableName="reports" />
		<dropPrimaryKey
			tableName="reportsSensitiveInformation" />
		<dropPrimaryKey
			tableName="savedSearches" />
		<dropPrimaryKey
			tableName="tags" />
		<dropPrimaryKey
			tableName="tasks" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-notNull-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<!-- only for foreign keys; primary keys have IDENTITY so cannot be null -->
		<dropNotNullConstraint
			tableName="approvalSteps" columnName="advisorOrganizationId" columnDataType="int"  />
		<dropNotNullConstraint
			tableName="authorizationGroupPositions" columnName="authorizationGroupId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="authorizationGroupPositions" columnName="positionId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="reportId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="authorizationGroupId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportTags" columnName="reportId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportTags" columnName="tagId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reports" columnName="authorId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="reportId" columnDataType="int" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-notNull-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<!-- primary keys -->
		<addNotNullConstraint
			tableName="approvalSteps" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="authorizationGroups" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="comments" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="locations" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="organizations" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="people" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="positions" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reports" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="savedSearches" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="tags" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="tasks" columnName="uuid" columnDataType="${uuid_type}" />
		<!-- foreign keys -->
		<addNotNullConstraint
			tableName="approvalSteps" columnName="advisorOrganizationUuid" columnDataType="${uuid_type}"  />
		<addNotNullConstraint
			tableName="authorizationGroupPositions" columnName="authorizationGroupUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="authorizationGroupPositions" columnName="positionUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="reportUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="authorizationGroupUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportTags" columnName="reportUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportTags" columnName="tagUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reports" columnName="authorUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="reportUuid" columnDataType="${uuid_type}" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-primaryKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addPrimaryKey
			tableName="approvalSteps" constraintName="PK_approvalSteps" columnNames="uuid" />
		<addPrimaryKey
			tableName="authorizationGroups" constraintName="PK_authorizationGroups" columnNames="uuid" />
		<addPrimaryKey
			tableName="comments" constraintName="PK_comments" columnNames="uuid" />
		<addPrimaryKey
			tableName="locations" constraintName="PK_locations" columnNames="uuid" />
		<addPrimaryKey
			tableName="organizations" constraintName="PK_organizations" columnNames="uuid" />
		<addPrimaryKey
			tableName="people" constraintName="PK_people" columnNames="uuid" />
		<addPrimaryKey
			tableName="positions" constraintName="PK_positions" columnNames="uuid" />
		<addPrimaryKey
			tableName="reports" constraintName="PK_reports" columnNames="uuid" />
		<addPrimaryKey
			tableName="reportsSensitiveInformation" constraintName="PK_reportsSensitiveInformation" columnNames="uuid" />
		<addPrimaryKey
			tableName="savedSearches" constraintName="PK_savedSearches" columnNames="uuid" />
		<addPrimaryKey
			tableName="tags" constraintName="PK_tags" columnNames="uuid" />
		<addPrimaryKey
			tableName="tasks" constraintName="PK_tasks" columnNames="uuid" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-unique-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint
			tableName="authorizationGroupPositions" constraintName="UQ_AuthorizationGroupPositions" columnNames="authorizationGroupUuid, positionUuid" />
		<addUniqueConstraint
			tableName="reportAuthorizationGroups" constraintName="UQ_ReportAuthorizationGroup" columnNames="reportUuid, authorizationGroupUuid" />
		<addUniqueConstraint
			tableName="reportPeople" constraintName="UQ_ReportPerson" columnNames="personUuid, reportUuid" />
		<addUniqueConstraint
			tableName="reportTags" constraintName="UQ_ReportTag" columnNames="reportUuid, tagUuid" />
		<addUniqueConstraint
			tableName="reportTasks" constraintName="UQ_ReportTask" columnNames="taskUuid, reportUuid" />
		<addUniqueConstraint
			tableName="reportsSensitiveInformation" constraintName="UQ_Report" columnNames="reportUuid" />
		<addUniqueConstraint
			tableName="savedSearches" constraintName="UQ_OwnerUuidName" columnNames="ownerUuid, name" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-foreignKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_step" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- FK constraint was missing before -->
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_organization" baseColumnNames="advisorOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- FK constraint was missing before -->
		<addForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_nextStep" baseColumnNames="nextStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="approvers" constraintName="FK_approvers_step" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="approvers" constraintName="FK_approvers_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="FK_authorizationGroupPositions_authorizationGroup" baseColumnNames="authorizationGroupUuid"
			referencedTableName="authorizationGroups" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="FK_authorizationGroupPositions_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="comments" constraintName="FK_comments_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="comments" constraintName="FK_comments_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="organizations" constraintName="FK_organizations_parentOrg" baseColumnNames="parentOrgUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="FK_peoplePositions_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="FK_peoplePositions_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="FK_positionsRelationships_positionA" baseColumnNames="positionUuid_a"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="FK_positionsRelationships_positionB" baseColumnNames="positionUuid_b"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_currPerson" baseColumnNames="currentPersonUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_location" baseColumnNames="locationUuid"
			referencedTableName="locations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_org" baseColumnNames="organizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="FK_reportAuthorizationGroups_authorizationGroup" baseColumnNames="authorizationGroupUuid"
			referencedTableName="authorizationGroups" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="FK_reportAuthorizationGroups_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportPeople" constraintName="FK_reportPeople_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportPeople" constraintName="FK_reportPeople_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_advisorOrg" baseColumnNames="advisorOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_approvalStep" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_location" baseColumnNames="locationUuid"
			referencedTableName="locations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_principalOrg" baseColumnNames="principalOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportsSensitiveInformation" constraintName="FK_reportsSensitiveInformation_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<addForeignKeyConstraint
			baseTableName="reportTags" constraintName="FK_reportTags_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportTags" constraintName="FK_reportTags_tag" baseColumnNames="tagUuid"
			referencedTableName="tags" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportTasks" constraintName="FK_reportTasks_task" baseColumnNames="taskUuid"
			referencedTableName="tasks" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportTasks" constraintName="FK_reportTasks_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="savedSearches" constraintName="FK_savedSearch_owner" baseColumnNames="ownerUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_organization" baseColumnNames="organizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_customFieldRef1" baseColumnNames="customFieldRef1Uuid"
			referencedTableName="tasks" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-unique-indexes" author="gjvoosten">
		<sql>
			CREATE UNIQUE ${non_clustered} INDEX "UQ_OrganizationIdentificationCode"
			ON organizations ( "identificationCode" )
			WHERE "identificationCode" IS NOT NULL
			AND "identificationCode" != '';

			CREATE UNIQUE ${non_clustered} INDEX "UQ_CurrentPersonInPosition"
			ON positions ("currentPersonUuid")
			WHERE "currentPersonUuid" IS NOT NULL;

			CREATE UNIQUE ${non_clustered} INDEX "UQ_PositionCodes"
			ON positions (code)
			WHERE code IS NOT NULL;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-fullText-indexes" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON authorizationGroups(name, description) KEY INDEX PK_authorizationGroups;
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_locations;
			CREATE FULLTEXT INDEX ON organizations(longName, shortName, identificationCode) KEY INDEX PK_organizations;
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_people;
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_positions;
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails, keyOutcomes) KEY INDEX PK_reports;
			CREATE FULLTEXT INDEX ON tags(name, description) KEY INDEX PK_tags;
			CREATE FULLTEXT INDEX ON tasks(longName, shortName, customField) KEY INDEX PK_tasks;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-foreignKey-columns" author="gjvoosten">
		<dropColumn tableName="approvalActions" columnName="approvalStepId" />
		<dropColumn tableName="approvalActions" columnName="personId" />
		<dropColumn tableName="approvalActions" columnName="reportId" />
		<dropColumn tableName="approvalSteps" columnName="advisorOrganizationId" />
		<dropColumn tableName="approvalSteps" columnName="nextStepId" />
		<dropColumn tableName="approvers" columnName="approvalStepId" />
		<dropColumn tableName="approvers" columnName="positionId" />
		<dropColumn tableName="authorizationGroupPositions" columnName="authorizationGroupId" />
		<dropColumn tableName="authorizationGroupPositions" columnName="positionId" />
		<dropColumn tableName="comments" columnName="authorId" />
		<dropColumn tableName="comments" columnName="reportId" />
		<dropColumn tableName="organizations" columnName="parentOrgId" />
		<dropColumn tableName="peoplePositions" columnName="personId" />
		<dropColumn tableName="peoplePositions" columnName="positionId" />
		<dropColumn tableName="positionRelationships" columnName="positionId_a" />
		<dropColumn tableName="positionRelationships" columnName="positionId_b" />
		<dropColumn tableName="positions" columnName="currentPersonId" />
		<dropColumn tableName="positions" columnName="locationId" />
		<dropColumn tableName="positions" columnName="organizationId" />
		<dropColumn tableName="reportAuthorizationGroups" columnName="authorizationGroupId" />
		<dropColumn tableName="reportAuthorizationGroups" columnName="reportId" />
		<dropColumn tableName="reportPeople" columnName="personId" />
		<dropColumn tableName="reportPeople" columnName="reportId" />
		<dropColumn tableName="reports" columnName="advisorOrganizationId" />
		<dropColumn tableName="reports" columnName="approvalStepId" />
		<dropColumn tableName="reports" columnName="authorId" />
		<dropColumn tableName="reports" columnName="locationId" />
		<dropColumn tableName="reports" columnName="principalOrganizationId" />
		<dropColumn tableName="reportsSensitiveInformation" columnName="reportId" />
		<dropColumn tableName="reportTags" columnName="reportId" />
		<dropColumn tableName="reportTags" columnName="tagId" />
		<dropColumn tableName="reportTasks" columnName="reportId" />
		<dropColumn tableName="reportTasks" columnName="taskId" />
		<dropColumn tableName="savedSearches" columnName="ownerId" />
		<dropColumn tableName="tasks" columnName="customFieldRef1Id" />
		<dropColumn tableName="tasks" columnName="organizationId" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="update-uuid-savedSearches" author="gjvoosten">
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			-- Add JSON fields for the new uuid's
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeeUuid', (SELECT uuid FROM people WHERE id=JSON_VALUE(query, '$.attendeeId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeePositionUuid', (SELECT uuid FROM positions WHERE id=JSON_VALUE(query, '$.attendeePositionId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorUuid', (SELECT uuid FROM people WHERE id=JSON_VALUE(query, '$.authorId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorPositionUuid', (SELECT uuid FROM positions WHERE id=JSON_VALUE(query, '$.authorPositionId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.locationUuid', (SELECT uuid FROM locations WHERE id=JSON_VALUE(query, '$.locationId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.orgUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.orgId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.organizationUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.organizationId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.responsibleOrgId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.tagUuid', (SELECT uuid FROM tags WHERE id=JSON_VALUE(query, '$.tagId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskUuid', (SELECT uuid FROM tasks WHERE id=JSON_VALUE(query, '$.taskId')));
			-- Remove JSON fields for the old id's
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeeId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeePositionId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorPositionId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.locationId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.orgId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.organizationId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.tagId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskId', NULL);
		</sql>
		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
			-- Add JSON fields for the new uuid's
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{attendeeUuid}', TO_JSONB(p.uuid), true)
				FROM people p WHERE p.id=(s.query::json->>'attendeeId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{attendeePositionUuid}', TO_JSONB(p.uuid), true)
				FROM positions p WHERE p.id=(s.query::json->>'attendeePositionId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{authorUuid}', TO_JSONB(p.uuid), true)
				FROM people p WHERE p.id=(s.query::json->>'authorId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{authorPositionUuid}', TO_JSONB(p.uuid), true)
				FROM positions p WHERE p.id=(s.query::json->>'authorPositionId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{locationUuid}', TO_JSONB(l.uuid), true)
				FROM locations l WHERE l.id=(s.query::json->>'locationId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{orgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'orgId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{orgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'organizationId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{responsibleOrgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'responsibleOrgId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{tagUuid}', TO_JSONB(t.uuid), true)
				FROM tags t WHERE t.id=(s.query::json->>'tagId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{taskUuid}', TO_JSONB(t.uuid), true)
				FROM tasks t WHERE t.id=(s.query::json->>'taskId')::int;
			-- Remove JSON fields for the old id's
			UPDATE "savedSearches" SET query=query::jsonb #- '{attendeeId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{attendeePositionId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{authorId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{authorPositionId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{locationId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{orgId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{organizationId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{responsibleOrgId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{tagId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{taskId}';
		</sql>
		<!-- No JSON manipulation in SQLite: -->
		<sql dbms="sqlite">
			DELETE FROM "savedSearches";
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-reports-legacyId-column" author="gjvoosten">
		<!-- Create a new legacy id column for reports and fill it with the old id -->
		<addColumn tableName="reports">
			<column name="legacyId" type="int" />
		</addColumn>
		<sql dbms="mssql">
		    UPDATE reports SET legacyId=id;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-reports-legacyId-column-2" author="gjvoosten">
		<!-- correct syntax -->
		<sql dbms="postgresql,sqlite">
		    UPDATE reports SET "legacyId"=id;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-primaryKey-columns" author="gjvoosten">
		<dropColumn tableName="approvalSteps" columnName="id" />
		<dropColumn tableName="authorizationGroups" columnName="id" />
		<dropColumn tableName="comments" columnName="id" />
		<dropColumn tableName="locations" columnName="id" />
		<dropColumn tableName="organizations" columnName="id" />
		<dropColumn tableName="people" columnName="id" />
		<dropColumn tableName="positions" columnName="id" />
		<dropColumn tableName="reports" columnName="id" />
		<dropColumn tableName="reportsSensitiveInformation" columnName="id" />
		<dropColumn tableName="savedSearches" columnName="id" />
		<dropColumn tableName="tags" columnName="id" />
		<dropColumn tableName="tasks" columnName="id" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add_notes" author="gjvoosten">
		<createTable tableName="notes">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="text" type="${long_text_type}" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="notes" constraintName="FK_notes_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<createTable tableName="noteRelatedObjects">
			<column name="noteUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint
			baseTableName="noteRelatedObjects" constraintName="FK_noteRelatedObjects_note" baseColumnNames="noteUuid"
			referencedTableName="notes" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
	</changeSet>

	<changeSet id="renameApprovalActions-to-ReportActions-sqlite-combined-tables" author="maradragan" dbms="mssql,postgresql">
		<comment>Rename approvalActions table to reportActions.</comment>
		<!-- reportActions -->
		<renameTable
			newTableName="reportActions"
			oldTableName="approvalActions" />
		<rollback>
			<renameTable
				newTableName="approvalActions"
				oldTableName="reportActions" />
		</rollback>
	</changeSet>

	<changeSet id="migrate_submit_and_publish_action" author="maradragan" dbms="mssql">
		<comment>Add submit and publish report actions for existing reports.</comment>
		<sql>
			INSERT INTO reportActions (reportUuid, createdAt, type)
				SELECT
					uuid, releasedAt, 3
				FROM reports
				WHERE state = 2
			;
			INSERT INTO reportActions (reportUuid, createdAt, personUuid, type)
				SELECT ra.reportUuid, DATEADD(SECOND, -1, ra.createdAt), r.authorUuid, 2
				FROM (
					SELECT
					reportUuid, MIN(createdAt) as createdAt
					FROM reportActions
					GROUP BY reportUuid ) ra,
				reports r
				WHERE
					ra.reportUuid = r.uuid
			;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-assessment-to-Tasks" author="VassilIordanov">
		<addColumn tableName="tasks">
			<column name="assessment" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-reports-duration-column" author="gjvoosten">
		<addColumn tableName="reports">
			<column name="duration" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="add-notes-type-column" author="gjvoosten">
		<!-- Create a new type column for notes and fill it with the the default value of 0 -->
		<addColumn tableName="notes">
			<column name="type" type="int" defaultValue="0">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add-assessment-to-Tasks" author="VassilIordanov">
		<addColumn tableName="tasks">
			<column name="assessment" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="migrate-tasks-assessments" author="gjvoosten" dbms="mssql">
		<!-- Column tasks.assessment will never have existed in PostgreSQL or SQLite -->
		<createTable tableName="tmpTasksAssessments">
			<column name="uuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="authorUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="text" type="${long_text_type}" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
		<!-- Requires at least SQL Server 2016: -->
		<sql>
			INSERT INTO PEOPLE (uuid, name, status, role, createdAt, updatedAt)
			    VALUES (${uuid_function}, 'ANET Importer', 1, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

			INSERT INTO tmpTasksAssessments (uuid, authorUuid, taskUuid, text)
				SELECT ${uuid_function},
					(SELECT uuid FROM people WHERE name = 'ANET Importer' AND status = 1 AND role = 0),
					tasks.uuid,
					JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY('{"oldValue":null,"newValue":null}', '$.text', tasks.assessment), '$.changedField', 'customFieldEnum1'), 'strict $.oldValue', tasks.customFieldEnum1), 'strict $.newValue', tasks.customFieldEnum1)
				FROM tasks
				WHERE NOT (tasks.assessment IS NULL OR tasks.assessment = '');

			INSERT INTO notes (uuid, authorUuid, type, text, createdAt, updatedAt)
				SELECT uuid, authorUuid, 1, text, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
				FROM tmpTasksAssessments;

			INSERT INTO noteRelatedObjects (noteUuid, relatedObjectType, relatedObjectUuid)
				SELECT uuid, 'tasks', taskUuid
				FROM tmpTasksAssessments;
		</sql>
		<dropTable tableName="tmpTasksAssessments" />
	</changeSet>

	<changeSet id="drop-assessment-from-Tasks" author="gjvoosten">
		<dropColumn tableName="tasks" columnName="assessment" />
	</changeSet>

	<changeSet id="add_task_responsible_positions" author="maradragan">
		<createTable tableName="taskResponsiblePositions">
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="positionUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_task_positions_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="taskResponsiblePositions" columnNames="taskUuid, positionUuid" constraintName="uniquetaskResponsiblePositions" />
		<addForeignKeyConstraint baseColumnNames="taskUuid" baseTableName="taskResponsiblePositions"
			constraintName="fk_taskResponsiblePositions_task" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="positionUuid" baseTableName="taskResponsiblePositions"
			constraintName="fk_taskResponsiblePositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="positions" />
	</changeSet>

	<changeSet id="add-foreignKey-indexes" author="gjvoosten">
		<createIndex
			indexName="IDX_approvalSteps_advisorOrganizationUuid" tableName="approvalSteps">
			<column name="advisorOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvalSteps_nextStepUuid" tableName="approvalSteps">
			<column name="nextStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvers_approvalStepUuid" tableName="approvers">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvers_positionUuid" tableName="approvers">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroupPositions_authorizationGroupUuid" tableName="authorizationGroupPositions">
			<column name="authorizationGroupUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroupPositions_positionUuid" tableName="authorizationGroupPositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_comments_authorUuid" tableName="comments">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_comments_reportUuid" tableName="comments">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_noteRelatedObjects_noteUuid" tableName="noteRelatedObjects">
			<column name="noteUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_notes_authorUuid" tableName="notes">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_parentOrgUuid" tableName="organizations">
			<column name="parentOrgUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_peoplePositions_personUuid" tableName="peoplePositions">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_peoplePositions_positionUuid" tableName="peoplePositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positionRelationships_positionUuid_a" tableName="positionRelationships">
			<column name="positionUuid_a"/>
		</createIndex>
		<createIndex
			indexName="IDX_positionRelationships_positionUuid_b" tableName="positionRelationships">
			<column name="positionUuid_b"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_currentPersonUuid" tableName="positions">
			<column name="currentPersonUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_locationUuid" tableName="positions">
			<column name="locationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_organizationUuid" tableName="positions">
			<column name="organizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_approvalStepUuid" tableName="reportActions">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_personUuid" tableName="reportActions">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_reportUuid" tableName="reportActions">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportAuthorizationGroups_authorizationGroupUuid" tableName="reportAuthorizationGroups">
			<column name="authorizationGroupUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportAuthorizationGroups_reportUuid" tableName="reportAuthorizationGroups">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportPeople_personUuid" tableName="reportPeople">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportPeople_reportUuid" tableName="reportPeople">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTags_reportUuid" tableName="reportTags">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTags_tagUuid" tableName="reportTags">
			<column name="tagUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTasks_reportUuid" tableName="reportTasks">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTasks_taskUuid" tableName="reportTasks">
			<column name="taskUuid"/>
		</createIndex>
		<!-- reportsSensitiveInformation.reportUuid already has a unique constraint/index -->
		<createIndex
			indexName="IDX_reports_advisorOrganizationUuid" tableName="reports">
			<column name="advisorOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_approvalStepUuid" tableName="reports">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_authorUuid" tableName="reports">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_locationUuid" tableName="reports">
			<column name="locationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_principalOrganizationUuid" tableName="reports">
			<column name="principalOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_savedSearches_ownerUuid" tableName="savedSearches">
			<column name="ownerUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskResponsiblePositions_positionUuid" tableName="taskResponsiblePositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskResponsiblePositions_taskUuid" tableName="taskResponsiblePositions">
			<column name="taskUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_customFieldRef1Uuid" tableName="tasks">
			<column name="customFieldRef1Uuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_organizationUuid" tableName="tasks">
			<column name="organizationUuid"/>
		</createIndex>
	</changeSet>

	<changeSet id="add-orderBy-indexes" author="gjvoosten">
		<createIndex
			indexName="IDX_authorizationGroups_createdAt" tableName="authorizationGroups">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroups_name" tableName="authorizationGroups">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_locations_createdAt" tableName="locations">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_locations_name" tableName="locations">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_createdAt" tableName="organizations">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_identificationCode" tableName="organizations">
			<column name="identificationCode"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_longName" tableName="organizations">
			<column name="longName"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_shortName" tableName="organizations">
			<column name="shortName"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_type" tableName="organizations">
			<column name="type"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_createdAt" tableName="people">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_name" tableName="people">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_rank" tableName="people">
			<column name="rank"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_code" tableName="positions">
			<column name="code"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_createdAt" tableName="positions">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_name" tableName="positions">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_createdAt" tableName="reports">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_engagementDate" tableName="reports">
			<column name="engagementDate"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_releasedAt" tableName="reports">
			<column name="releasedAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_updatedAt" tableName="reports">
			<column name="updatedAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_tags_createdAt" tableName="tags">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_tags_name" tableName="tags">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_category" tableName="tasks">
			<column name="category"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_createdAt" tableName="tasks">
			<column name="createdAt"/>
		</createIndex>
		<!-- tasks.shortName already has a unique constraint/index -->
	</changeSet>

	<changeSet id="add-avatars-to-People" author="jose-west">
		<addColumn tableName="people">
			<column name="avatar" type="blob"/>
		</addColumn>
	</changeSet>

	<changeSet id="add-approvalSteps-type-column" author="maradragan">
		<!-- Create a new type column for approval steps and fill it for the existing approval steps -->
		<addColumn tableName="approvalSteps">
			<column name="type" type="int" />
		</addColumn>
		<sql>
			UPDATE "approvalSteps" SET type=1;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-approvalSteps-type-notnull-constraint" author="maradragan" dbms="mssql,postgresql">
		<addNotNullConstraint
			columnDataType="int"
			columnName="type"
			tableName="approvalSteps" />
	</changeSet>

	<changeSet id="move_future_to_draft" author="maradragan">
		<sql>
			UPDATE reports SET state=0 WHERE state=5;
		</sql>
		<rollback>
			<sql>
				UPDATE reports SET state=5 WHERE "engagementDate" > CURRENT_TIMESTAMP;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-endedAt-to-peoplePositions" author="mdragan">
		<addColumn tableName="peoplePositions">
			<column name="endedAt" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE peoplePositions ALTER COLUMN endedAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="fill-endedAt-peoplePositions-column" author="mdragan">
		<comment>Populate the new endedAt column of the peoplePositions table.</comment>
		<sql dbms="mssql">
			UPDATE "peoplePositions" SET "endedAt" = (
				SELECT TOP(1) "createdAt"
				FROM "peoplePositions" next
				WHERE
					next."positionUuid" = "peoplePositions"."positionUuid" AND
					next."createdAt" > "peoplePositions"."createdAt"
				ORDER BY next."createdAt"
			);
		</sql>
		<sql dbms="postgresql">
			UPDATE "peoplePositions" SET "endedAt" = (
				SELECT "createdAt"
				FROM "peoplePositions" next
				WHERE
					next."positionUuid" = "peoplePositions"."positionUuid" AND
					next."createdAt" > "peoplePositions"."createdAt"
				ORDER BY next."createdAt"
				LIMIT 1
			);
		</sql>
		<rollback>
			UPDATE "peoplePositions" set "endedAt" = NULL;
		</rollback>
	</changeSet>

	<changeSet id="alter-fulltext-stoplist" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<!--
		  Most columns in the full-text index (except for the reports columns,
		  and people.biography) do not contain English text; don't use a stoplist
		  for these. Note that we can have only one full-text index per table, so
		  people.biography no longer has a stoplist with this changeSet.
		-->
		<sql>
			ALTER FULLTEXT INDEX ON authorizationGroups SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON locations SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON organizations SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON people SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON positions SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON tags SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON tasks SET STOPLIST = OFF;
			ALTER FULLTEXT CATALOG anet_ft_catalog REBUILD WITH ACCENT_SENSITIVITY = OFF;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-people-code" author="gjvoosten">
		<addColumn tableName="people">
			<column name="code" type="nvarchar(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="add_task_responsible_organizations" author="gjvoosten">
		<!-- Add new m2m table -->
		<createTable tableName="taskTaskedOrganizations">
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="organizationUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- Add FK constraints and indexes -->
		<addForeignKeyConstraint baseColumnNames="taskUuid" baseTableName="taskTaskedOrganizations"
			constraintName="FK_taskTaskedOrganizations_task" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="organizationUuid" baseTableName="taskTaskedOrganizations"
			constraintName="FK_taskTaskedOrganizations_organization" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="organizations" />
		<createIndex
			indexName="IDX_taskTaskedOrganizations_taskUuid" tableName="taskTaskedOrganizations">
			<column name="taskUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskTaskedOrganizations_organizationUuid" tableName="taskTaskedOrganizations">
			<column name="organizationUuid"/>
		</createIndex>

		<!-- Migrate saved searches -->
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskedOrgUuid', JSON_VALUE(query, '$.responsibleOrgUuid'));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', NULL);
		</sql>
		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
			UPDATE "savedSearches" SET query=JSONB_SET(query::jsonb, '{taskedOrgUuid}', query::jsonb->'responsibleOrgUuid', true);
			UPDATE "savedSearches" SET query=query::jsonb #- '{responsibleOrgUuid}';
		</sql>

		<!-- Migrate task responsible organizations -->
		<sql>
			INSERT INTO "taskTaskedOrganizations" ( "taskUuid", "organizationUuid")
				SELECT uuid, "organizationUuid" FROM tasks
				WHERE "organizationUuid" IS NOT NULL;
		</sql>

		<!-- Drop old index and FK constraint -->
		<dropIndex
			indexName="IDX_tasks_organizationUuid" tableName="tasks"/>
		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_organization"/>

		<!-- Finally, drop old column -->
		<dropColumn tableName="tasks" columnName="organizationUuid"/>

		<rollback>
			<!-- Recreate old column -->
			<addColumn tableName="tasks">
				<column name="organizationUuid" type="${uuid_type}" />
			</addColumn>

			<!-- Recreate old FK constraint and index -->
			<addForeignKeyConstraint
				baseTableName="tasks" constraintName="FK_tasks_organization" baseColumnNames="organizationUuid"
				referencedTableName="organizations" referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION" />
			<createIndex
				indexName="IDX_tasks_organizationUuid" tableName="tasks">
				<column name="organizationUuid"/>
			</createIndex>

			<!-- Migrate back task responsible organizations; pick the first one (there might be more) -->
			<sql dbms="mssql">
				UPDATE tasks
				SET "organizationUuid" = (
					SELECT TOP(1) "organizationUuid" FROM "taskTaskedOrganizations"
					WHERE "taskUuid" = tasks.uuid
				);
			</sql>
			<sql dbms="postgresql">
				UPDATE tasks
				SET "organizationUuid" = (
					SELECT "organizationUuid" FROM "taskTaskedOrganizations"
					WHERE "taskUuid" = tasks.uuid
					LIMIT 1
				);
			</sql>

			<!-- Migrate back saved searches -->
			<!-- Requires at least SQL Server 2016: -->
			<sql dbms="mssql">
				UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', JSON_VALUE(query, '$.taskedOrgUuid'));
				UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskedOrgUuid', NULL);
			</sql>
			<!-- Requires at least PostgreSQL 9.5: -->
			<sql dbms="postgresql">
				UPDATE "savedSearches" SET query=JSONB_SET(query::jsonb, '{responsibleOrgUuid}', query::jsonb->'taskedOrgUuid', true);
				UPDATE "savedSearches" SET query=query::jsonb #- '{taskedOrgUuid}';
			</sql>

			<!-- Finally, drop new m2m table (also drops FK constraints and indexes) -->
			<dropTable tableName="taskTaskedOrganizations" />
		</rollback>
	</changeSet>

	<changeSet id="add-postgresql-fulltext" author="gjvoosten" dbms="postgresql">
		<sql>
			<!-- Create text search configuration -->
			DROP TEXT SEARCH CONFIGURATION IF EXISTS ${fts_config_name};
			CREATE TEXT SEARCH CONFIGURATION ${fts_config_name} ( COPY = pg_catalog.english );
			ALTER TEXT SEARCH CONFIGURATION ${fts_config_name} ALTER MAPPING FOR hword, hword_part, word WITH unaccent, english_stem;

			<!-- Add generated full-text columns -->
			ALTER TABLE "authorizationGroups"
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".description, '')), ${fts_low})
				) STORED;

			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(organizations."identificationCode", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(organizations."shortName", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE notes
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(notes.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(people.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people.code, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."domainUsername", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."emailAddress", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."phoneNumber", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people.biography, '')), ${fts_low})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(positions.code, '')), ${fts_high})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE tags
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tags.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(tags.description, '')), ${fts_low})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tasks."shortName", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Create full-text materialized views and indexes -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_authorizationGroups"(uuid, full_text) AS
				SELECT
					"authorizationGroups".uuid,
					"authorizationGroups".full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM "authorizationGroups"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'authorizationGroups'
					AND "noteRelatedObjects"."relatedObjectUuid" = "authorizationGroups".uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY "authorizationGroups".uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_authorizationGroups_uuid" ON "mv_fts_authorizationGroups"(uuid);
			CREATE INDEX "FT_mv_fts_authorizationGroups" ON "mv_fts_authorizationGroups" USING gin(full_text);
			CREATE INDEX "TR_authorizationGroups_uuid" ON "mv_fts_authorizationGroups" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
				SELECT
					reports.uuid,
					reports.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM reports
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
					AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY reports.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tags(uuid, full_text) AS
				SELECT
					tags.uuid,
					tags.full_text
				FROM tags
				GROUP BY tags.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tags" ON mv_fts_tags(uuid);
			CREATE INDEX "FT_mv_fts_tags" ON mv_fts_tags USING gin(full_text);
			CREATE INDEX "TR_tags_uuid" ON mv_fts_tags USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
				SELECT
					tasks.uuid,
					tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM tasks
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
					AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
		<rollback>
			<sql>
				<!-- Drop full-text materialized views (incl. indexes) -->
				DROP MATERIALIZED VIEW "mv_fts_authorizationGroups";
				DROP MATERIALIZED VIEW mv_fts_locations;
				DROP MATERIALIZED VIEW mv_fts_organizations;
				DROP MATERIALIZED VIEW mv_fts_people;
				DROP MATERIALIZED VIEW mv_fts_positions;
				DROP MATERIALIZED VIEW mv_fts_reports;
				DROP MATERIALIZED VIEW mv_fts_tags;
				DROP MATERIALIZED VIEW mv_fts_tasks;

				<!-- Drop generated full-text columns -->
				ALTER TABLE "authorizationGroups" DROP COLUMN full_text;
				ALTER TABLE locations DROP COLUMN full_text;
				ALTER TABLE organizations DROP COLUMN full_text;
				ALTER TABLE notes DROP COLUMN full_text;
				ALTER TABLE people DROP COLUMN full_text;
				ALTER TABLE positions DROP COLUMN full_text;
				ALTER TABLE reports DROP COLUMN full_text;
				ALTER TABLE tags DROP COLUMN full_text;
				ALTER TABLE tasks DROP COLUMN full_text;

				<!-- Drop text search configuration -->
				DROP TEXT SEARCH CONFIGURATION ${fts_config_name};
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-custom-fields-to-reports" author="maradragan">
		<addColumn tableName="reports">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-fields-to-people" author="maradragan">
		<addColumn tableName="people">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-fields-to-tasks" author="maradragan">
		<addColumn tableName="tasks">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="drop-FK_approvalSteps_organization" author="gjvoosten" dbms="mssql,postgresql">
		<dropForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_organization" />
	</changeSet>

	<changeSet id="drop-IDX_approvalSteps_advisorOrganizationUuid" author="gjvoosten">
		<dropIndex
			tableName="approvalSteps" indexName="IDX_approvalSteps_advisorOrganizationUuid" />
	</changeSet>

	<changeSet id="rename-approvalSteps-advisorOrganizationUuid" author="gjvoosten">
		 <renameColumn
			 tableName="approvalSteps"
			 oldColumnName="advisorOrganizationUuid"
			 newColumnName="relatedObjectUuid"
			 columnDataType="${uuid_type}" />
	 </changeSet>

	<changeSet id="add-IDX_approvalSteps_relatedObjectUuid" author="gjvoosten">
		<createIndex
			tableName="approvalSteps" indexName="IDX_approvalSteps_relatedObjectUuid">
			<column name="relatedObjectUuid" />
		</createIndex>
	</changeSet>

	<changeSet id="change-avatar-type" author="gjvoosten">
		<!-- This temporarily needs about twice the storage space for all avatars -->
		<addColumn tableName="people">
			<column name="b64_avatar" type="${long_text_type}" />
		</addColumn>
		<sql dbms="postgresql">
			UPDATE people SET b64_avatar = encode(lo_get(avatar), 'escape') WHERE avatar IS NOT NULL;
			SELECT lo_unlink(oid) FROM pg_largeobject_metadata;
		</sql>
		<sql dbms="mssql">
			UPDATE people SET b64_avatar = cast(avatar as varchar(max)) WHERE avatar IS NOT NULL;
		</sql>
		<dropColumn tableName="people" columnName="avatar" />
		<addColumn tableName="people">
			<column name="new_avatar" type="${blob_type}" />
		</addColumn>
		<sql dbms="postgresql">
			UPDATE people SET new_avatar = decode(b64_avatar, 'base64') WHERE b64_avatar IS NOT NULL;
		</sql>
		<sql dbms="mssql">
			UPDATE people SET new_avatar = cast(N'' AS xml).value('xs:base64Binary(sql:column("people.b64_avatar"))', 'varbinary(max)') WHERE b64_avatar IS NOT NULL;
		</sql>
		<dropColumn tableName="people" columnName="b64_avatar" />
		<renameColumn
			columnDataType="${blob_type}"
			oldColumnName="new_avatar"
			newColumnName="avatar"
			tableName="people" />
	</changeSet>

	<changeSet id="clean-postgresql-large-objects" author="gjvoosten" dbms="postgresql" runInTransaction="false">
		<sql>
			VACUUM FULL ANALYZE pg_largeobject;
		</sql>
	</changeSet>

	<changeSet id="add-approvalSteps-restrictedApproval" author="gjvoosten">
		<addColumn tableName="approvalSteps">
			<column name="restrictedApproval" type="boolean" defaultValue="false" />
		</addColumn>
	</changeSet>

	<changeSet id="alter-postgresql-fulltext" author="gjvoosten" dbms="postgresql">
		<sql>
			<!-- Drop full-text materialized views (incl. indexes) -->
			DROP MATERIALIZED VIEW "mv_fts_authorizationGroups";
			DROP MATERIALIZED VIEW mv_fts_locations;
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions;
			DROP MATERIALIZED VIEW mv_fts_reports;
			DROP MATERIALIZED VIEW mv_fts_tags;
			DROP MATERIALIZED VIEW mv_fts_tasks;

			<!-- Drop generated full-text columns -->
			ALTER TABLE "authorizationGroups" DROP COLUMN full_text;
			ALTER TABLE locations DROP COLUMN full_text;
			ALTER TABLE organizations DROP COLUMN full_text;
			ALTER TABLE notes DROP COLUMN full_text;
			ALTER TABLE people DROP COLUMN full_text;
			ALTER TABLE positions DROP COLUMN full_text;
			ALTER TABLE reports DROP COLUMN full_text;
			ALTER TABLE tags DROP COLUMN full_text;
			ALTER TABLE tasks DROP COLUMN full_text;

			<!-- Re-add generated full-text columns;
			     use 'anet' config only for columns containing English text,
			     use 'simple' config for all columns -->
			ALTER TABLE "authorizationGroups"
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".name, ''))
						  || to_tsvector('simple', coalesce("authorizationGroups".name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".description, ''))
						  || to_tsvector('simple', coalesce("authorizationGroups".description, '')), ${fts_low})
				) STORED;

			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
						  || to_tsvector('simple', coalesce(locations.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
						  || to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE notes
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(notes.text, ''))
						  || to_tsvector('simple', coalesce(notes.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."emailAddress", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
						  || to_tsvector('simple', coalesce(people.biography, '')), ${fts_low})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(positions.code, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, ''))
						  || to_tsvector('simple', coalesce(positions.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, ''))
						  || to_tsvector('simple', coalesce(reports.intent, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", ''))
						  || to_tsvector('simple', coalesce(reports."keyOutcomes", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", ''))
						  || to_tsvector('simple', coalesce(reports."nextSteps", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports.text, ''))
						  || to_tsvector('simple', coalesce(reports.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE tags
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tags.name, ''))
						  || to_tsvector('simple', coalesce(tags.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tags.description, ''))
						  || to_tsvector('simple', coalesce(tags.description, '')), ${fts_low})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
						  || to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Re-create full-text materialized views and indexes -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_authorizationGroups"(uuid, full_text) AS
				SELECT
					"authorizationGroups".uuid,
					"authorizationGroups".full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM "authorizationGroups"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'authorizationGroups'
					AND "noteRelatedObjects"."relatedObjectUuid" = "authorizationGroups".uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY "authorizationGroups".uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_authorizationGroups_uuid" ON "mv_fts_authorizationGroups"(uuid);
			CREATE INDEX "FT_mv_fts_authorizationGroups" ON "mv_fts_authorizationGroups" USING gin(full_text);
			CREATE INDEX "TR_authorizationGroups_uuid" ON "mv_fts_authorizationGroups" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
				SELECT
					reports.uuid,
					reports.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM reports
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
					AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY reports.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tags(uuid, full_text) AS
				SELECT
					tags.uuid,
					tags.full_text
				FROM tags
				GROUP BY tags.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tags" ON mv_fts_tags(uuid);
			CREATE INDEX "FT_mv_fts_tags" ON mv_fts_tags USING gin(full_text);
			CREATE INDEX "TR_tags_uuid" ON mv_fts_tags USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
				SELECT
					tasks.uuid,
					tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM tasks
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
					AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="update-task-assessment-questions" author="gjvoosten">
		<!-- Note: the demo data has at most 3 assessment definitions for any one task
		     and field installations have at most 2, so only update the first 3. -->

		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
		<![CDATA[
			-- change all &#34; to " inside 'questions'
			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[0].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[0].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[0].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[0].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[0].questions') LIKE '%&#34;%';

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[1].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[1].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[1].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[1].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[1].questions') LIKE '%&#34;%';

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[2].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[2].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[2].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[2].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[2].questions') LIKE '%&#34;%';

			-- change all 'questions' from string to JSON
			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[0].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[0].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[0].questions') IS NOT NULL;

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[1].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[1].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[1].questions') IS NOT NULL;

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[2].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[2].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[2].questions') IS NOT NULL;
		]]>
		</sql>

		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
		<![CDATA[
			-- create convenience function
			CREATE OR REPLACE FUNCTION is_valid_json(p_json text)
				RETURNS boolean
			AS
			'
			BEGIN
				IF p_json IS NULL THEN
					RETURN NULL;
				ELSE
					RETURN (p_json::json IS NOT NULL);
				END IF;
			EXCEPTION
				WHEN OTHERS THEN
					RETURN FALSE;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			-- change all &#34; to " inside 'questions'
			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 0, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 0, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 0, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 0, questions}' LIKE '%&#34;%';

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 1, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 1, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 1, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 1, questions}' LIKE '%&#34;%';

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 2, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 2, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 2, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 2, questions}' LIKE '%&#34;%';

			-- change all 'questions' from string to JSON
			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 0, questions}', ("customFields"::jsonb#>>'{assessments, 0, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 0, questions}') IS TRUE;

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 1, questions}', ("customFields"::jsonb#>>'{assessments, 1, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 1, questions}') IS TRUE;

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 2, questions}', ("customFields"::jsonb#>>'{assessments, 2, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 2, questions}') IS TRUE;

			-- drop convenience function
			DROP FUNCTION IF EXISTS is_valid_json;
		]]>
		</sql>

		<!-- Rolling back is not useful -->
	</changeSet>

</databaseChangeLog>
