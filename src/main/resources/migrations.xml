<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

	<!-- Type for storing UUIDv4 transparantly -->
	<property name="uuid_type" value="varchar(36)" />
	<!-- Convenience functions to generate UUIDv4 on various databases -->
	<property name="uuid_function" value="lower(newid())" dbms="mssql" />
	<!-- Extension "uuid-ossp" should exist already, see `prepare-psql.sql`: -->
	<property name="uuid_function" value="uuid_generate_v4()" dbms="postgresql" />
	<!-- Not really a UUID but who cares? -->
	<property name="uuid_function" value="lower(hex(randomblob(16)))" dbms="sqlite" />

	<!-- Type for storing long text transparantly -->
	<property name="long_text_type" value="nvarchar(max)" dbms="mssql" />
	<property name="long_text_type" value="text" dbms="postgresql,sqlite" />

	<!-- Use a NONCLUSTERED index only for MSSQL -->
	<property name="non_clustered" value="NONCLUSTERED" dbms="mssql" />
	<property name="non_clustered" value="" dbms="postgresql,sqlite" />

	<!-- Full-text search configuration used by PostgreSQL -->
	<property name="fts_config_name" value="anet" dbms="postgresql" />
	<property name="fts_config" value="'${fts_config_name}'" dbms="postgresql" />
	<!-- Full-text search weights -->
	<property name="fts_high" value="'A'" dbms="postgresql" />
	<property name="fts_low" value="'B'" dbms="postgresql" />
	<property name="fts_lower" value="'C'" dbms="postgresql" />
	<property name="fts_lowest" value="'D'" dbms="postgresql" />

	<!-- For storing the avatar -->
	<property name="blob_type" value="blob" dbms="mssql" />
	<property name="blob_type" value="bytea" dbms="postgresql" />

	<!-- For updating old-style ANET links to new urn: format -->
	<property name="oldAnetLink" value="(&lt;a href=\\?&quot;)https?://[^/]*/(reports|people|organizations|positions|locations|tasks)/([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})(\\?&quot;[^&gt;]*&gt;&lt;/a&gt;)" />
	<property name="newAnetLink" value="\1urn:anet:\2:\3\4" />

	<changeSet id="1" author="hpitelka">
		<createTable tableName="people">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(255)" />
			<column name="status" type="int" />
			<column name="emailAddress" type="varchar(255)" />
			<column name="phoneNumber" type="varchar(100)" />
			<column name="rank" type="varchar(255)" />
			<column name="biography" type="text" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="role" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="pendingVerification" type="boolean" defaultValue="false" />
		</createTable>

		<createTable tableName="groups">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(512)" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="groupMemberships">
			<column name="groupId" type="int" />
			<column name="personId" type="int" />
		</createTable>

		<createTable tableName="organizations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)" />
			<column name="parentOrgId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="poams" >
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>

			<!-- the 1-2 character version (ie EF-5, or B) -->
			<column name="shortName" type="varchar(100)" />

			<!-- The Longer text ie (Rule of Law) or (Get the MoI to handle hiring of people) -->
			<column name="longName" type="varchar(255)" />

			<!-- What type of POAM this is EF, Sub-EF, Milestone, Action, Sub-Action -->
			<column name="category" type="varchar(255)" />

			<!-- the POAM id of the parent of this POAM. null for top level (ie EF/DA) -->
			<column name="parentPoamId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<createTable tableName="positions">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="code" type="varchar(100)" />
			<column name="name" type="varchar(512)" />
			<column name="organizationId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="type" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="currentPersonId" type="int" />
			<column name="locationId" type="int" />
		</createTable>

		<createTable tableName="peoplePositions">
			<column name="positionId" type="int" />
			<column name="personId" type="int" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<createTable tableName="positionRelationships" >
			<column name="positionId_a" type="int" />
			<column name="positionId_b" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="deleted" type="boolean" />
		</createTable>

		<createTable tableName="reports">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="locationId" type="int" />
			<column name="intent" type="text" />
			<column name="exsum" type="text" />
			<column name="text" type="text" />
			<column name="nextSteps" type="text" />
			<column name="authorId" type="int" />
			<column name="approvalStepId" type="int" />
			<column name="state" type="int" />
			<column name="engagementDate" type="datetime"/>
			<column name="atmosphere" type="int"/>
			<column name="atmosphereDetails" type="text" />
		</createTable>

		<createTable tableName="reportPeople" >
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="isPrimary" type="boolean" defaultValue="false" />
		</createTable>
		<createTable tableName="reportPoams" >
			<column name="reportId" type="int" />
			<column name="poamId" type="int" />
		</createTable>

		<createTable tableName="comments">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
			<column name="text" type="text" />
		</createTable>

		<createTable tableName="locations">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(500)" />
			<column name="lat" type="float" />
			<column name="lng" type="float" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="2" author="hpitelka">
		<createTable tableName="approvalSteps">
			<column name="id" type="int" autoIncrement="true" >
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="approverGroupId" type="int" >
				<constraints nullable="false"/>
			</column>
			<column name="nextStepId" type="int" />
			<column name="advisorOrganizationId" type="int" >
				<constraints nullable="false" />
			</column>
		</createTable>

		<createTable tableName="approvalActions">
			<column name="approvalStepId" type="int" />
			<column name="personId" type="int" />
			<column name="reportId" type="int" />
			<column name="createdAt" type="datetime" />
			<column name="type" type="int" />
		</createTable>
	</changeSet>

	<changeSet id="4" author="hpitelka" runInTransaction="false" >
		<sql dbms="mssql">
			IF NOT EXISTS (SELECT 1 FROM sys.fulltext_catalogs WHERE [name] = 'anet_ft_catalog')
				CREATE FULLTEXT CATALOG anet_ft_catalog AS DEFAULT;
		</sql>
		<!-- Key name of PK_TABLE_NAME is autogenerated by Liquidbase on each table w/ a primary key -->
		<sql dbms="mssql">
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails) KEY INDEX PK_REPORTS;
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_PEOPLE;
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_POSITIONS;
			CREATE FULLTEXT INDEX ON organizations(name) KEY INDEX PK_ORGANIZATIONS;
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_LOCATIONS;
			CREATE FULLTEXT INDEX ON poams(longName,shortName) KEY INDEX PK_POAMS;
		</sql>
	</changeSet>

	<!-- Liquidbase uses datetime, but SQLServer recommends using datetime2 instead -->
	<changeSet id="5" author="hpitelka" >
		<sql dbms="mssql">
			ALTER TABLE people ALTER COLUMN createdAt datetime2;
			ALTER TABLE people ALTER COLUMN updatedAt datetime2;
			ALTER TABLE groups ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN createdAt datetime2;
			ALTER TABLE organizations ALTER COLUMN updatedAt datetime2;

			ALTER TABLE poams ALTER COLUMN createdAt datetime2;
			ALTER TABLE poams ALTER COLUMN updatedAt datetime2;

			ALTER TABLE positions ALTER COLUMN createdAt datetime2;
			ALTER TABLE positions ALTER COLUMN updatedAt datetime2;

			ALTER TABLE peoplePositions ALTER COLUMN createdAt datetime2;

			ALTER TABLE positionRelationships ALTER COLUMN createdAt datetime2;
			ALTER TABLE positionRelationships ALTER COLUMN updatedAt datetime2;

			ALTER TABLE reports ALTER COLUMN createdAt datetime2;
			ALTER TABLE reports ALTER COLUMN updatedAt datetime2;
			ALTER TABLE reports ALTER COLUMN engagementDate datetime2;

			ALTER TABLE comments ALTER COLUMN createdAt datetime2;
			ALTER TABLE comments ALTER COLUMN updatedAt datetime2;

			ALTER TABLE locations ALTER COLUMN createdAt datetime2;
			ALTER TABLE locations ALTER COLUMN updatedAt datetime2;

			ALTER TABLE approvalActions ALTER COLUMN createdAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="6" author="hpitelka">
		<addColumn tableName="people">
			<column name="domainUsername" type="varchar(500)" />
		</addColumn>
	</changeSet>

	<changeSet id="7" author="hpitelka">
		<sql dbms="mssql">
			<!-- really frustrating that I didn't do the not-null constraint above in changeset 5
			  but I didn't so it's here.  If we ever nuke the database, would be nice to clean this up -->
			ALTER TABLE groups ALTER COLUMN createdAt datetime2 NOT NULL;

			ALTER TABLE organizations ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE organizations ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE people ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE people ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE reports ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE reports ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE poams ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE poams ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE positions ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE positions ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE comments ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE comments ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE locations ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE locations ALTER COLUMN updatedAt datetime2 NOT NULL;

			ALTER TABLE positionRelationships ALTER COLUMN createdAt datetime2 NOT NULL;
			ALTER TABLE positionRelationships ALTER COLUMN updatedAt datetime2 NOT NULL;
			ALTER TABLE approvalActions ALTER COLUMN createdAt datetime2 NOT NULL;
		</sql>
	</changeSet>

	<changeSet id="8" author="hpitelka" dbms="mssql,postgresql" >
		<!-- Groups -->
		<addUniqueConstraint tableName="groupMemberships" columnNames="groupId, personId" constraintName="uniqueGroupMembership" />
		<addNotNullConstraint tableName="groups" columnName="name" columnDataType="varchar(512)" />
		<addForeignKeyConstraint baseColumnNames="groupId" baseTableName="groupMemberships"
			constraintName="fk_groupMember_group" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="groups" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="groupMemberships"
			constraintName="fk_groupMember_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Approval Steps -->
		<addForeignKeyConstraint baseColumnNames="approverGroupId" baseTableName="approvalSteps"
			constraintName="fk_approvalSteps_group" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="groups" />
		<addForeignKeyConstraint baseColumnNames="advisorOrganizationId" baseTableName="approvalSteps"
			constraintName="fk_approvalSteps_orgId" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<!-- Approval Actions -->
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="approvalActions"
			constraintName="fk_approvalActions_step" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="approvalActions"
			constraintName="fk_approvalActions_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Reports -->
		<addNotNullConstraint tableName="reports" columnName="authorId" columnDataType="int" />
		<addNotNullConstraint tableName="reports" columnName="state" columnDataType="int" />
		<addForeignKeyConstraint baseColumnNames="authorId" baseTableName="reports"
			constraintName="fk_reports_author" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="locationId" baseTableName="reports"
			constraintName="fk_reports_location" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="locations" />
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="reports"
			constraintName="fk_reports_approvalStep" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />

		<!-- Report People -->
		<addUniqueConstraint tableName="reportPeople" columnNames="personId, reportId" constraintName="uniqueReportPerson" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="reportPeople"
			constraintName="fk_reportPeople_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportPeople"
			constraintName="fk_reportPeople_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- Report Poams -->
		<addUniqueConstraint tableName="reportPoams" columnNames="poamId, reportId" constraintName="uniqueReportPoam" />
		<addForeignKeyConstraint baseColumnNames="poamId" baseTableName="reportPoams"
			constraintName="fk_reportPoams_poam" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="poams" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportPoams"
			constraintName="fk_reportPoams_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- Poams -->
		<addForeignKeyConstraint baseColumnNames="parentPoamId" baseTableName="poams"
			constraintName="fk_poams_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="poams" />

		<!-- Locations -->
		<addNotNullConstraint tableName="locations" columnName="name" columnDataType="varchar(500)" />

		<!-- Positions -->
		<addNotNullConstraint tableName="positions" columnName="name" columnDataType="varchar(512)" />
		<addForeignKeyConstraint baseColumnNames="currentPersonId" baseTableName="positions"
			constraintName="fk_positions_currPerson" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="positions"
			constraintName="fk_positions_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
		<addForeignKeyConstraint baseColumnNames="locationId" baseTableName="positions"
			constraintName="fk_positions_location" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="locations" />

		<!-- Organizations -->
		<addForeignKeyConstraint baseColumnNames="parentOrgId" baseTableName="organizations"
			constraintName="fk_organizations_parentOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<!-- Comments -->
		<addForeignKeyConstraint baseColumnNames="authorId" baseTableName="comments"
			constraintName="fk_comments_author" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="comments"
			constraintName="fk_comments_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<!-- People Positions -->
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="peoplePositions"
			constraintName="fk_peoplePositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
		<addForeignKeyConstraint baseColumnNames="personId" baseTableName="peoplePositions"
			constraintName="fk_peoplePositions_person" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />

		<!-- Position Relationships -->
		<addForeignKeyConstraint baseColumnNames="positionId_a" baseTableName="positionRelationships"
			constraintName="fk_positionsRelationships_idA" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
		<addForeignKeyConstraint baseColumnNames="positionId_b" baseTableName="positionRelationships"
			constraintName="fk_positionsRelationships_idB" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="9" author="hpitelka" >
		<createTable tableName="adminSettings">
			<column name="key" type="varchar(255)" />
			<column name="value" type="text" />
		</createTable>
	</changeSet>
	<changeSet id="10" author="hpitelka" dbms="mssql,postgresql" >
		<addUniqueConstraint tableName="adminSettings" columnNames="key" constraintName="adminSettingKey" />
	</changeSet>

	<changeSet id="11" author="hpitelka" >
		<createTable tableName="pendingEmails">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="jobSpec" type="text" />
			<column name="createdAt" type="datetime" />
		</createTable>
		<sql dbms="mssql">
			ALTER TABLE pendingEmails ALTER COLUMN createdAt datetime2 NOT NULL;
		</sql>
	</changeSet>

	<changeSet id="12" author="hpitelka" >
		<addColumn tableName="people">
			<column name="country" type="varchar(500)" />
		</addColumn>
		<addColumn tableName="people">
			<column name="gender" type="varchar(64)" />
		</addColumn>
		<addColumn tableName="people">
			<column name="endOfTourDate" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE people ALTER COLUMN endOfTourDate datetime2;
		</sql>
	</changeSet>

	<changeSet id="13" author="hpitelka" >
		<addColumn tableName="poams">
			<column name="organizationId" type="int" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="advisorOrganizationId" type="int" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="principalOrganizationId" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="14" author="hpitelka"  dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="poams"
			constraintName="fk_poams_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<addForeignKeyConstraint baseColumnNames="advisorOrganizationId" baseTableName="reports"
			constraintName="fk_reports_advisorOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />

		<addForeignKeyConstraint baseColumnNames="principalOrganizationId" baseTableName="reports"
			constraintName="fk_reports_principalOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
	</changeSet>

	<changeSet id="15" author="hpitelka" runInTransaction="false" >
		<addColumn tableName="reports">
			<column name="keyOutcomesSummary" type="text" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="keyOutcomes" type="text" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="nextStepsSummary" type="text" />
		</addColumn>

		<sql dbms="mssql">
			ALTER FULLTEXT INDEX ON reports ADD (keyOutcomesSummary, keyOutcomes, nextStepsSummary)
		</sql>
	</changeSet>

	<changeSet id="16" author="hpitelka" >
		<addColumn tableName="organizations">
			<column name="longName" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="17" author="hpitelka" dbms="mssql,postgresql" >
		<renameColumn
			columnDataType="varchar(255)"
			oldColumnName="name"
			newColumnName="shortName"
			tableName="organizations" />
	</changeSet>

	<changeSet id="18" author="hpitelka" dbms="sqlite" >
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="organizations">
			<column name="shortName" type="varchar(255)" />
		</addColumn>
		<dropColumn tableName="organizations" columnName="name" />
	</changeSet>

	<changeSet id="19" author="hpitelka" >
		<createTable tableName="savedSearches">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="varchar(512)" />
			<column name="createdAt" type="datetime" />
			<column name="ownerId" type="int" />
			<column name="objectType" type="int" />
			<column name="query" type="text" />
		</createTable>
	</changeSet>

	<changeSet id="20" author="hpitelka"  dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="ownerId" baseTableName="savedSearches"
			constraintName="fk_savedSearch_owner" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="people" />
	</changeSet>

	<changeSet id="21" author="hpitelka" dbms="mssql" runInTransaction="false">
		<sql dbms="mssql">
			DROP FULLTEXT INDEX ON organizations;
			CREATE FULLTEXT INDEX ON organizations(shortName, longName) KEY INDEX PK_ORGANIZATIONS;
		</sql>
	</changeSet>

	<changeSet id="22" author="hpitelka" dbms="mssql,postgresql" >
		<dropForeignKeyConstraint baseTableName="groupMemberships" constraintName="fk_groupMember_group" />
		<dropForeignKeyConstraint baseTableName="groupMemberships" constraintName="fk_groupMember_person" />
		<dropForeignKeyConstraint baseTableName="approvalSteps" constraintName="fk_approvalSteps_group" />
	</changeSet>

	<changeSet id="23" author="hpitelka" >
		<dropColumn columnName="approverGroupId" tableName="approvalSteps" />
		<dropTable tableName="groupMemberships" />
		<dropTable tableName="groups" />
		<createTable tableName="approvers" >
			<column name="approvalStepId" type="int" />
			<column name="positionId" type="int" />
		</createTable>
		<addColumn tableName="approvalSteps" >
			<column name="name" type="varchar(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="24" author="hpitelka" dbms="mssql,postgresql" >
		<addForeignKeyConstraint baseColumnNames="approvalStepId" baseTableName="approvers"
			constraintName="fk_approvers_step" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="approvalSteps" />
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="approvers"
			constraintName="fk_approvers_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="25" author="hpitelka"  >
		<sql dbms="mssql">
			ALTER FULLTEXT INDEX ON reports DROP (keyOutcomesSummary, nextStepsSummary)
		</sql>
		<dropColumn tableName="reports" columnName="keyOutcomesSummary" />
		<dropColumn tableName="reports" columnName="nextStepsSummary" />
	</changeSet>

	<changeSet id="26" author="hpitelka" >
		<addColumn tableName="reports" >
			<column name="cancelledReason" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="27" author="hpitelka" >
		<addColumn tableName="reports">
			<column name="releasedAt" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE reports ALTER COLUMN releasedAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="28" author="hpitelka" >
		<addColumn tableName="positions" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<!-- Found out that varchar and text don't support Unicode, so changing to nvarchar and ntext
		Then found out that MSSQL is dropping support for text/ntext in favor of nvarchar(max)
		And you can't modify columns that are in a fulltext index... so have to re-build those.
	-->
	<changeSet id="29" author="hpitelka" runInTransaction="false" >
		<sql dbms="mssql">
			DROP FULLTEXT INDEX ON people;
			ALTER TABLE people ALTER COLUMN name nvarchar(255);
			ALTER TABLE people ALTER COLUMN biography nvarchar(max);
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_PEOPLE;
			ALTER TABLE people ALTER COLUMN domainUsername nvarchar(512);

			DROP FULLTEXT INDEX on organizations;
			ALTER TABLE organizations ALTER COLUMN longName nvarchar(255);
			ALTER TABLE organizations ALTER COLUMN shortName nvarchar(255);
			CREATE FULLTEXT INDEX ON organizations(longName, shortName) KEY INDEX PK_ORGANIZATIONS;

			DROP FULLTEXT INDEX ON poams;
			ALTER TABLE poams ALTER COLUMN shortName nvarchar(255);
			ALTER TABLE poams ALTER COLUMN longName nvarchar(max);
			CREATE FULLTEXT INDEX ON poams(longName,shortName) KEY INDEX PK_POAMS;

			DROP FULLTEXT INDEX ON positions;
			ALTER TABLE positions ALTER COLUMN code nvarchar(100);
			ALTER TABLE positions ALTER COLUMN name nvarchar(512);
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_POSITIONS;

			DROP FULLTEXT INDEX ON reports;
			ALTER TABLE reports ALTER COLUMN intent nvarchar(max);
			ALTER TABLE reports ALTER COLUMN exsum nvarchar(max);
			ALTER TABLE reports ALTER COLUMN text nvarchar(max);
			ALTER TABLE reports ALTER COLUMN nextSteps nvarchar(max);
			ALTER TABLE reports ALTER COLUMN keyOutcomes nvarchar(max);
			ALTER TABLE reports ALTER COLUMN atmosphereDetails nvarchar(max);
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails, keyOutcomes) KEY INDEX PK_REPORTS;

			ALTER TABLE comments ALTER COLUMN text nvarchar(max);

			DROP FULLTEXT INDEX ON locations;
			ALTER TABLE locations ALTER COLUMN name nvarchar(512);
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_LOCATIONS;

			ALTER TABLE approvalSteps ALTER COLUMN name nvarchar(255);

			ALTER TABLE adminSettings ALTER COLUMN value nvarchar(max);

			ALTER TABLE pendingEmails ALTER COLUMN jobSpec nvarchar(max);

			ALTER TABLE savedSearches ALTER COLUMN name nvarchar(512);
			ALTER TABLE savedSearches ALTER COLUMN query nvarchar(max);
		</sql>
	</changeSet>

	<!-- partial unique index syntax varies by database (if available) -->
	<changeSet id="30" author="hpitelka" dbms="mssql" >
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX UniqueCurrentPersonInPosition ON positions (currentPersonId) WHERE currentPersonId IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="30p" author="bwarfield" dbms="postgresql,sqlite" >
		<comment>Create a unique index for "positions.currentPersonId", excluding nulls.</comment>
		<sql>
			CREATE UNIQUE INDEX "UniqueCurrentPersonInPosition" ON positions ("currentPersonId") WHERE "currentPersonId" IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		</rollback>
	</changeSet>

	<changeSet id="31" author="hpitelka" dbms="mssql" >
		<sql dbms="mssql">
			ALTER FULLTEXT CATALOG anet_ft_catalog REBUILD WITH ACCENT_SENSITIVITY = OFF
		</sql>
	</changeSet>

	<changeSet id="32" author="hpitelka" >
		<!-- this syntax works in SQL Server and SQLite, but not postgresql. Since we already have
		     to add a catch-up migration, restricting this to mssql only (which could cause problems
			 for anybody with a long-running installation using sqlite, but that seems like an unlikely
			 contingency).
		-->
		<sql dbms="mssql">
			INSERT INTO adminSettings ([key], value) VALUES ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', '14');
		</sql>
	</changeSet>

	<changeSet id="33" author="hpitelka" >
		<addColumn tableName="poams" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<!-- partial unique index syntax varies by database (if available) -->
	<changeSet id="34" author="hpitelka" dbms="mssql" >
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX UniquePositionCodes ON positions (code) WHERE code IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="34p" author="bwarfield" dbms="postgresql,sqlite">
		<comment>Create a unique index for "positions.currentPersonId", excluding nulls.</comment>
		<sql>
			CREATE UNIQUE INDEX "UniquePositionCodes" ON positions(code) WHERE code IS NOT NULL;
		</sql>
		<rollback>
			<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		</rollback>
	</changeSet>

	<changeSet id="35" author="evdhoudt" dbms="mssql" >
		<sql>
			INSERT INTO adminSettings ([key], value) VALUES ('EXTERNAL_DOCUMENTATION_LINK_URL', '');
		</sql>
	</changeSet>

	<changeSet id="add_tags" author="gjvoosten">
		<createTable tableName="tags">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="name" type="nvarchar(100)">
				<constraints nullable="false"/>
			</column>
			<column name="description" type="nvarchar(512)" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_report_tags" author="gjvoosten">
		<createTable tableName="reportTags">
			<column name="reportId" type="int">
				<constraints nullable="false"/>
			</column>
			<column name="tagId" type="int">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_report_tags_constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="reportTags" columnNames="reportId, tagId" constraintName="uniqueReportTag" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportTags"
			constraintName="fk_reportTags_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />
		<addForeignKeyConstraint baseColumnNames="tagId" baseTableName="reportTags"
			constraintName="fk_reportTags_tag" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tags" />
	</changeSet>

	<changeSet id="add-banner-text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_TEXT" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_TEXT'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_TEXT" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_TEXT'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-level" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_LEVEL" />
			<column name="value" value="notice" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_LEVEL'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add-banner-visibility" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="GENERAL_BANNER_VISIBILITY" />
			<column name="value" value="1" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'GENERAL_BANNER_VISIBILITY'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add_external_documentation_link_text" author="evdhoudt" dbms="mssql">
		<insert tableName="adminSettings">
			<column name="key" value="EXTERNAL_DOCUMENTATION_LINK_TEXT" />
			<column name="value" value="External documentation" />
		</insert>
		<rollback>
			<delete tableName="adminSettings">
				<where>[key] = 'EXTERNAL_DOCUMENTATION_LINK_URL'</where>
			</delete>
		</rollback>
	</changeSet>

	<changeSet id="add_tags_fulltext_index" author="maradragan" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON tags(name, description) KEY INDEX PK_TAGS;
		</sql>
		<rollback>
			DROP FULLTEXT INDEX ON tags;
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_identificationCode" author="gjvoosten">
		<addColumn tableName="organizations">
			<column name="identificationCode" type="nvarchar(100)" />
		</addColumn>
	</changeSet>

	<!-- separate migrations for SQL Server and other DBMS systems -->
	<changeSet id="add_organizations_identificationCode_constraints" author="gjvoosten" dbms="mssql">
		<!-- Use SQL because we want to allow NULLs while still requiring non-NULL and non-empty columns to be unique -->
		<comment>Add a partial unique index to force non-empty organization codes to be unique.</comment>
		<sql>
			CREATE UNIQUE NONCLUSTERED INDEX uniqueOrganizationIdentificationCode
			ON organizations ( identificationCode )
			WHERE identificationCode IS NOT NULL
			AND identificationCode != '';
		</sql>
		<rollback>
			DROP INDEX uniqueOrganizationIdentificationCode ON organizations;
		</rollback>
	</changeSet>
	<!-- this works for at least: "postgresql,sqlite" -->
	<changeSet id="add_organizations_identificationCode_constraints_pg" author="bwarfield" dbms="postgresql,sqlite">
		<comment>Add a partial unique index to force non-empty organization codes to be unique.</comment>
		<!-- Use SQL because we want to allow NULLs while still requiring non-NULL and non-empty columns to be unique -->
		<sql>
			CREATE UNIQUE INDEX "uniqueOrganizationIdentificationCode"
			ON organizations ( "identificationCode" )
			WHERE "identificationCode" IS NOT NULL
			AND "identificationCode" != '';
		</sql>
		<rollback>
			<dropIndex tableName="organizations" indexName="uniqueOrganizationIdentificationCode" />
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_identificationCode_to_fulltext_index" author="gjvoosten" dbms="mssql">
		<sql>
			ALTER FULLTEXT INDEX ON organizations ADD ( identificationCode );
		</sql>
		<rollback>
			ALTER FULLTEXT INDEX ON organizations DROP ( identificationCode );
		</rollback>
	</changeSet>

	<changeSet id="add_reports_sensitive_information" author="gjvoosten" dbms="mssql">
		<createTable tableName="reportsSensitiveInformation">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="text" type="nvarchar(max)" />
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<!-- a better way to do this would be to have a single migration using a modifySql
	     tag: http://www.liquibase.org/documentation/modify_sql.html (but that would change the
		 checksum, so we can't do it with an already-run migration) -->
	<changeSet id="add_reports_sensitive_information_no_nvarchar" author="bwarfield" dbms="postgresql,sqlite">
		<createTable tableName="reportsSensitiveInformation">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="text" type="text" />
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_reports_sensitive_information_constraints" author="gjvoosten" dbms="mssql,postgresql">
    	<!-- Add unique constraint because we want to enforce a one-to-one relationship between reports and reportsSensitiveInformation -->
		<addUniqueConstraint tableName="reportsSensitiveInformation" columnNames="reportId" constraintName="uniqueReport" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportsSensitiveInformation"
			constraintName="fk_reportsSensitiveInformation_report" onDelete="CASCADE" onUpdate="CASCADE"
			referencedColumnNames="id" referencedTableName="reports" />
	</changeSet>

	<changeSet id="add_positions_authorized" author="gjvoosten">
		<addColumn tableName="positions">
			<column name="authorized" type="boolean" defaultValue="false">
				<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="renamePoams-to-Tasks" author="evdhoudt" dbms="mssql,postgresql">
		<!-- Tasks -->
		<renameTable
			newTableName="tasks"
			oldTableName="poams" />
		<renameColumn
			columnDataType="int"
			oldColumnName="parentPoamId"
			newColumnName="parentTaskId"
			tableName="tasks" />

		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_poams_parent"/>
		<addForeignKeyConstraint baseColumnNames="parentTaskId" baseTableName="tasks"
			constraintName="fk_tasks_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />
		<rollback>
			<!-- sadly, 'dropforeignkeyconstraint' does not have an auto-rollback, so we have to do a manual rollback for everything -->
			<renameColumn
				columnDataType="int"
				newColumnName="parentPoamId"
				oldColumnName="parentTaskId"
				tableName="tasks" />
			<renameTable
				newTableName="poams"
				oldTableName="tasks" />
			<dropForeignKeyConstraint baseTableName="poams" constraintName="fk_tasks_parent"/>
			<addForeignKeyConstraint baseColumnNames="parentPoamId" baseTableName="poams"
				constraintName="fk_poams_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
				referencedColumnNames="id" referencedTableName="poams" />

		</rollback>
	</changeSet>

	<changeSet id="renameReportPoams-to-ReportTasks" author="evdhoudt" dbms="mssql,postgresql">
		<!-- Report Tasks -->
		<renameTable
			newTableName="reportTasks"
			oldTableName="reportPoams" />
		<renameColumn
			columnDataType="int"
			oldColumnName="poamId"
			newColumnName="taskId"
			tableName="reportTasks" />
	</changeSet>

	<changeSet id="renamePoams-to-Tasks-sqlite-combined-tables" author="bwarfield" dbms="sqlite">
		<comment>Rename poams and taskPoams, and add new columns.</comment>
		<!-- Tasks -->
		<renameTable
			newTableName="tasks"
			oldTableName="poams" />
		<!-- reportTasks -->
		<renameTable
			newTableName="reportTasks"
			oldTableName="reportPoams" />
	</changeSet>

	<changeSet id="renamePoams-to-Tasks-sqlite-combined-columns" author="bwarfield" dbms="sqlite">
		<comment>Create and populate new task ID columns, but leave the old ones in place because sqlite does not support dropping columns.</comment>
		<sql>
			ALTER TABLE tasks add column parentTaskId int;
			ALTER TABLE reportTasks add column taskId int;
			UPDATE tasks set parentTaskId = parentPoamId;
			UPDATE reportTasks set taskId = poamId;
		</sql>
		<rollback>
			UPDATE tasks set parentPoamId = parentTaskId;
			UPDATE reportTasks set poamId = taskId;
		</rollback>
	</changeSet>

	<changeSet id="renameConstraints-Poams-to-Tasks" author="evdhoudt" dbms="mssql,postgresql">
		<dropUniqueConstraint tableName="reportTasks" constraintName="uniqueReportPoam"/>
		<addUniqueConstraint tableName="reportTasks" columnNames="taskId, reportId" constraintName="uniqueReportTask" />

		<dropForeignKeyConstraint baseTableName="reportTasks" constraintName="fk_reportPoams_poam"/>
		<addForeignKeyConstraint baseColumnNames="taskId" baseTableName="reportTasks"
			constraintName="fk_reportTasks_poam" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />

		<dropForeignKeyConstraint baseTableName="reportTasks" constraintName="fk_reportPoams_report"/>
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportTasks"
			constraintName="fk_reportTasks_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />

		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_poams_org"/>
		<addForeignKeyConstraint baseColumnNames="organizationId" baseTableName="tasks"
			constraintName="fk_tasks_org" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="organizations" />
	</changeSet>

	<changeSet id="add-extra-fields-to-Tasks" author="evdhoudt">
		<addColumn tableName="tasks">
			<column name="projectedCompletion" type="datetime" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="plannedCompletion" type="datetime" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="customField" type="text" />
		</addColumn>
		<addColumn tableName="tasks" >
			<column name="customFieldEnum" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="36" author="bwarfield" dbms="postgresql,sqlite">
		<comment>This is a repeat of migrations 32 and 35, with a more generic syntax.</comment>
		<sql>
			INSERT INTO "adminSettings" ("key", "value") VALUES ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', '14');
			INSERT INTO "adminSettings" ("key", "value") VALUES ('EXTERNAL_DOCUMENTATION_LINK_URL', '');
		</sql>
		<rollback>
			DELETE FROM "adminSettings"
			WHERE "key" in ('DAILY_ROLLUP_MAX_REPORT_AGE_DAYS', 'EXTERNAL_DOCUMENTATION_LINK_URL')
		</rollback>
	</changeSet>

	<changeSet id="add_authorization_groups" author="maradragan">
		<createTable tableName="authorizationGroups">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="nvarchar(100)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="nvarchar(512)" />
			<column name="status" type="int" defaultValue="0">
				<constraints nullable="false"/>
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add_authorization_group_positions" author="maradragan">
		<createTable tableName="authorizationGroupPositions">
			<column name="authorizationGroupId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="positionId" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_authorization_group_positions_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="authorizationGroupPositions" columnNames="authorizationGroupId, positionId" constraintName="uniqueAuthorizationGroupPositions" />
		<addForeignKeyConstraint baseColumnNames="authorizationGroupId" baseTableName="authorizationGroupPositions"
			constraintName="fk_authorizationGroupPositions_authorizationGroup" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="authorizationGroups" />
		<addForeignKeyConstraint baseColumnNames="positionId" baseTableName="authorizationGroupPositions"
			constraintName="fk_authorizationGroupPositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="positions" />
	</changeSet>

	<changeSet id="add_report_authorization_groups" author="maradragan">
		<createTable tableName="reportAuthorizationGroups">
			<column name="reportId" type="int">
				<constraints nullable="false" />
			</column>
			<column name="authorizationGroupId" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_report_authorization_groups_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="reportAuthorizationGroups" columnNames="reportId, authorizationGroupId" constraintName="uniqueReportAuthorizationGroup" />
		<addForeignKeyConstraint baseColumnNames="reportId" baseTableName="reportAuthorizationGroups"
			constraintName="fk_reportAuthorizationGroups_report" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="reports" />
		<addForeignKeyConstraint baseColumnNames="authorizationGroupId" baseTableName="reportAuthorizationGroups"
			constraintName="fk_reportAuthorizationGroups_authorizationGroup" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="authorizationGroups" />
	</changeSet>

	<changeSet id="add_authorizationGroups_fulltext_index" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON authorizationGroups(name, description) KEY INDEX PK_AUTHORIZATIONGROUPS;
		</sql>
		<rollback>
			DROP FULLTEXT INDEX ON authorizationGroups;
		</rollback>
	</changeSet>

	<changeSet id="migrated_authorized_positions" author="gjvoosten" dbms="mssql">
		<sql>
			INSERT INTO authorizationGroups (name, description, status, createdAt, updatedAt)
				SELECT
					CONCAT('Authorized positions for ', o.shortName),
					CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']'),
					0,
					CURRENT_TIMESTAMP,
					CURRENT_TIMESTAMP
				FROM organizations o
				WHERE EXISTS (
					SELECT p.id
					FROM positions p
					WHERE p.organizationId = o.id
					AND p.authorized = 1
				)
			;

			INSERT INTO authorizationGroupPositions (authorizationGroupId, positionId)
				SELECT DISTINCT ag.id, p.id
				FROM authorizationGroups ag,
				positions p
				JOIN organizations o ON o.id = p.organizationId
				WHERE ag.description = CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']')
				AND p.authorized = 1
			;

			INSERT INTO reportAuthorizationGroups (reportId, authorizationGroupId)
				SELECT DISTINCT r.id, ag.id
				FROM reports r
				JOIN organizations o ON o.id = r.advisorOrganizationId
				JOIN reportsSensitiveInformation rsi ON rsi.reportId = r.id,
				authorizationGroups ag
				WHERE ag.description = CONCAT('Automatically migrated authorized positions for ', o.shortName, ' [', o.id, ']')
			;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop_positions_authorized" author="gjvoosten" dbms="mssql,postgresql">
	    <!-- Some magic to make sure any auto-generated database constraints are dropped -->
		<dropNotNullConstraint tableName="positions" columnName="authorized" columnDataType="boolean" />
		<dropDefaultValue tableName="positions" columnName="authorized" columnDataType="boolean" />
		<!-- Then drop the column itself -->
		<dropColumn tableName="positions" columnName="authorized" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="update-extra-fields-to-Tasks" author="evdhoudt" dbms="mssql">
		<modifyDataType columnName="customField" newDataType="nvarchar(max)" tableName="tasks" />
		<modifyDataType columnName="customFieldEnum" newDataType="nvarchar(max)" tableName="tasks" />
	</changeSet>

	<changeSet id="add_tasks_customField_to_fulltext_index" author="evdhoudt" dbms="mssql" runInTransaction="false">
		<sql>
			ALTER FULLTEXT INDEX ON tasks ADD ( customField );
		</sql>
		<rollback>
			ALTER FULLTEXT INDEX ON tasks DROP ( customField );
		</rollback>
	</changeSet>

	<changeSet id="add_organizations_status" author="gjvoosten" >
		<addColumn tableName="organizations" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add_locations_status" author="gjvoosten" >
		<addColumn tableName="locations" >
			<column name="status" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-field-enum-2-to-Tasks" author="maradragan" dbms="mssql">
		<addColumn tableName="tasks" >
			<column name="customFieldEnum2" type="nvarchar(max)" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-field-enum-2-to-Tasks-no-mssql" author="maradragan" dbms="postgresql,sqlite">
		<addColumn tableName="tasks" >
			<column name="customFieldEnum2" type="text" />
		</addColumn>
	</changeSet>

	<changeSet id="rename-custom-field-enum-in-tasks" author="maradragan" dbms="mssql,postgresql">
		<renameColumn
			columnDataType="nvarchar(max)"
			oldColumnName="customFieldEnum"
			newColumnName="customFieldEnum1"
			tableName="tasks" />
	</changeSet>

	<changeSet id="rename-custom-field-enum-in-tasks-sqlite" author="maradragan" dbms="sqlite">
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="tasks">
			<column name="customFieldEnum1" type="text" />
		</addColumn>
		<dropColumn tableName="tasks" columnName="customFieldEnum" />
	</changeSet>

	<changeSet id="migrate_duplicate_savedSearches" author="gjvoosten" dbms="mssql">
		<sql>
			UPDATE dups
			SET name = name + ' (' + cast(NEWID() as varchar(40)) + ')'
			FROM (
			  SELECT
			    name,
			    ROW_NUMBER() OVER (PARTITION BY ownerId, name ORDER BY name) AS r
			  FROM savedSearches
			) dups
			WHERE r > 1
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add_unique_savedSearches_constraint" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="savedSearches" columnNames="ownerId, name" constraintName="uniqueOwnerIdName" />
	</changeSet>

	<changeSet id="rename-parent-task-in-tasks" author="maradragan" dbms="mssql,postgresql">
		<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_tasks_parent"/>
		<renameColumn
			columnDataType="int"
			oldColumnName="parentTaskId"
			newColumnName="customFieldRef1Id"
			tableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="customFieldRef1Id" baseTableName="tasks"
			constraintName="fk_tasks_customFieldRef1Id" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="tasks" />
		<rollback>
			<!-- sadly, 'dropforeignkeyconstraint' does not have an auto-rollback, so we have to do a manual rollback for everything -->
			<dropForeignKeyConstraint baseTableName="tasks" constraintName="fk_tasks_customFieldRef1Id"/>
			<renameColumn
				columnDataType="int"
				newColumnName="parentTaskId"
				oldColumnName="customFieldRef1Id"
				tableName="tasks" />
			<addForeignKeyConstraint baseColumnNames="parentTaskId" baseTableName="tasks"
				constraintName="fk_tasks_parent" onDelete="NO ACTION" onUpdate="NO ACTION"
				referencedColumnNames="id" referencedTableName="tasks" />
		</rollback>
	</changeSet>

	<changeSet id="rename-parent-task-in-tasks-sqlite" author="maradragan" dbms="sqlite">
		<!-- sqlite doesn't support rename column, so drop and add a new column -->
		<addColumn tableName="tasks">
			<column name="customFieldRef1Id" type="int" />
		</addColumn>
		<sql>
			UPDATE tasks set customFieldRef1Id = parentTaskId;
		</sql>
		<dropColumn tableName="tasks" columnName="parentTaskId" />
		<rollback>
			<addColumn tableName="tasks">
				<column name="parentTaskId" type="int" />
			</addColumn>
			<sql>
				UPDATE tasks set parentTaskId = customFieldRef1Id;
			</sql>
			<dropColumn tableName="tasks" columnName="customFieldRef1" />
		</rollback>
	</changeSet>

	<changeSet id="cleanup-map-layers-from-adminSettings" author="VassilIordanov" dbms="mssql">
		<delete tableName="adminSettings">
			<where>[key] = 'MAP_LAYERS'</where>
		</delete>
	</changeSet>

	<changeSet id="add_unique_tasks_shortName_constraint" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="tasks" columnNames="shortName" constraintName="UQ_TaskShortName" />
	</changeSet>

	<changeSet id="add-uuid-primaryKey-columns" author="gjvoosten">
		<addColumn tableName="approvalSteps">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroups">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="locations">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="organizations">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="people">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportsSensitiveInformation">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="savedSearches">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tags">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="uuid" type="${uuid_type}" />
		</addColumn>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-foreignKey-columns" author="gjvoosten">
		<addColumn tableName="approvalActions">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalActions">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalActions">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalSteps">
			<column name="advisorOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvalSteps">
			<column name="nextStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvers">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="approvers">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroupPositions">
			<column name="authorizationGroupUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="authorizationGroupPositions">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="authorUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="comments">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="organizations">
			<column name="parentOrgUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="peoplePositions">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="peoplePositions">
			<column name="positionUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positionRelationships">
			<column name="positionUuid_a" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positionRelationships">
			<column name="positionUuid_b" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="currentPersonUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="locationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="positions">
			<column name="organizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportAuthorizationGroups">
			<column name="authorizationGroupUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportAuthorizationGroups">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportPeople">
			<column name="personUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportPeople">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="advisorOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="approvalStepUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="authorUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="locationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reports">
			<column name="principalOrganizationUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportsSensitiveInformation">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTags">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTags">
			<column name="tagUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTasks">
			<column name="reportUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="reportTasks">
			<column name="taskUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="savedSearches">
			<column name="ownerUuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="customFieldRef1Uuid" type="${uuid_type}" />
		</addColumn>
		<addColumn tableName="tasks">
			<column name="organizationUuid" type="${uuid_type}" />
		</addColumn>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="fill-uuid-primaryKey-columns" author="gjvoosten">
		<!--
			If on postgresql, make sure to enable uuid generation before running this changeset:
				CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
		-->
		<!-- Generate new uuid's for all tables -->
		<sql>
			UPDATE "approvalSteps" SET uuid = ${uuid_function};
			UPDATE "authorizationGroups" SET uuid = ${uuid_function};
			UPDATE comments SET uuid = ${uuid_function};
			UPDATE locations SET uuid = ${uuid_function};
			UPDATE organizations SET uuid = ${uuid_function};
			UPDATE people SET uuid = ${uuid_function};
			UPDATE positions SET uuid = ${uuid_function};
			UPDATE reports SET uuid = ${uuid_function};
			UPDATE "reportsSensitiveInformation" SET uuid = ${uuid_function};
			UPDATE "savedSearches" SET uuid = ${uuid_function};
			UPDATE tags SET uuid = ${uuid_function};
			UPDATE tasks SET uuid = ${uuid_function};
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="fill-uuid-foreignKey-columns" author="gjvoosten">
		<!-- Fill uuid references for all tables -->
		<sql>
			UPDATE "adminSettings" SET value = (
				SELECT uuid FROM organizations
				WHERE organizations.id = CAST(value AS int)
			)
			WHERE "key" = 'DEFAULT_APPROVAL_ORGANIZATION';
		</sql>
		<sql>
			UPDATE "approvalActions" SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = "approvalActions"."approvalStepId"
			);
			UPDATE "approvalActions" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "approvalActions"."personId"
			);
			UPDATE "approvalActions" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "approvalActions"."reportId"
			);
			UPDATE "approvalSteps" SET "advisorOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = "approvalSteps"."advisorOrganizationId"
			);
			UPDATE "approvalSteps" SET "nextStepUuid" = (
				SELECT a2.uuid FROM "approvalSteps" a2
				WHERE a2.id = "approvalSteps"."nextStepId"
			);
			UPDATE approvers SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = approvers."approvalStepId"
			);
			UPDATE approvers SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = approvers."positionId"
			);
			UPDATE "authorizationGroupPositions" SET "authorizationGroupUuid" = (
				SELECT uuid FROM "authorizationGroups"
				WHERE "authorizationGroups".id = "authorizationGroupPositions"."authorizationGroupId"
			);
			UPDATE "authorizationGroupPositions" SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = "authorizationGroupPositions"."positionId"
			);
			UPDATE comments SET "authorUuid" = (
				SELECT uuid FROM people
				WHERE people.id = comments."authorId"
			);
			UPDATE comments SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = comments."reportId"
			);
			UPDATE organizations SET "parentOrgUuid" = (
				SELECT o2.uuid FROM organizations o2
				WHERE o2.id = organizations."parentOrgId"
			);
			UPDATE "peoplePositions" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "peoplePositions"."personId"
			);
			UPDATE "peoplePositions" SET "positionUuid" = (
				SELECT uuid FROM positions
				WHERE positions.id = "peoplePositions"."positionId"
			);
			UPDATE "positionRelationships" SET "positionUuid_a" = (
				SELECT uuid FROM positions
				WHERE positions.id = "positionRelationships"."positionId_a"
			);
			UPDATE "positionRelationships" SET "positionUuid_b" = (
				SELECT uuid FROM positions
				WHERE positions.id = "positionRelationships"."positionId_b"
			);
			UPDATE positions SET "currentPersonUuid" = (
				SELECT uuid FROM people
				WHERE people.id = positions."currentPersonId"
			);
			UPDATE positions SET "locationUuid" = (
				SELECT uuid FROM locations
				WHERE locations.id = positions."locationId"
			);
			UPDATE positions SET "organizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = positions."organizationId"
			);
			UPDATE "reportAuthorizationGroups" SET "authorizationGroupUuid" = (
				SELECT uuid FROM "authorizationGroups"
				WHERE "authorizationGroups".id = "reportAuthorizationGroups"."authorizationGroupId"
			);
			UPDATE "reportAuthorizationGroups" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportAuthorizationGroups"."reportId"
			);
			UPDATE "reportPeople" SET "personUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "reportPeople"."personId"
			);
			UPDATE "reportPeople" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportPeople"."reportId"
			);
			UPDATE reports SET "advisorOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = reports."advisorOrganizationId"
			);
			UPDATE reports SET "approvalStepUuid" = (
				SELECT uuid FROM "approvalSteps"
				WHERE "approvalSteps".id = reports."approvalStepId"
			);
			UPDATE reports SET "authorUuid" = (
				SELECT uuid FROM people
				WHERE people.id = reports."authorId"
			);
			UPDATE reports SET "locationUuid" = (
				SELECT uuid FROM locations
				WHERE locations.id = reports."locationId"
			);
			UPDATE reports SET "principalOrganizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = reports."principalOrganizationId"
			);
			UPDATE "reportsSensitiveInformation" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportsSensitiveInformation"."reportId"
			);
			UPDATE "reportTags" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportTags"."reportId"
			);
			UPDATE "reportTags" SET "tagUuid" = (
				SELECT uuid FROM tags
				WHERE tags.id = "reportTags"."tagId"
			);
			UPDATE "reportTasks" SET "reportUuid" = (
				SELECT uuid FROM reports
				WHERE reports.id = "reportTasks"."reportId"
			);
			UPDATE "reportTasks" SET "taskUuid" = (
				SELECT uuid FROM tasks
				WHERE tasks.id = "reportTasks"."taskId"
			);
			UPDATE "savedSearches" SET "ownerUuid" = (
				SELECT uuid FROM people
				WHERE people.id = "savedSearches"."ownerId"
			);
			UPDATE tasks SET "customFieldRef1Uuid" = (
				SELECT t2.uuid FROM tasks t2
				WHERE t2.id = tasks."customFieldRef1Id"
			);
			UPDATE tasks SET "organizationUuid" = (
				SELECT uuid FROM organizations
				WHERE organizations.id = tasks."organizationId"
			);
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-fullText-indexes" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			DROP FULLTEXT INDEX ON authorizationGroups;
			DROP FULLTEXT INDEX ON locations;
			DROP FULLTEXT INDEX ON people;
			DROP FULLTEXT INDEX ON positions;
			DROP FULLTEXT INDEX ON reports;
			DROP FULLTEXT INDEX ON tags;
			DROP FULLTEXT INDEX ON tasks;
			DROP FULLTEXT INDEX on organizations;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-unique-indexes" author="gjvoosten">
		<dropIndex tableName="organizations" indexName="uniqueOrganizationIdentificationCode" />
		<dropIndex tableName="positions" indexName="UniqueCurrentPersonInPosition" />
		<dropIndex tableName="positions" indexName="UniquePositionCodes" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-foreignKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropForeignKeyConstraint
			baseTableName="approvalActions" constraintName="fk_approvalActions_step" />
		<dropForeignKeyConstraint
			baseTableName="approvalActions" constraintName="fk_approvalActions_person" />

		<dropForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="fk_approvalSteps_orgId" />

		<dropForeignKeyConstraint
			baseTableName="approvers" constraintName="fk_approvers_step" />
		<dropForeignKeyConstraint
			baseTableName="approvers" constraintName="fk_approvers_position" />

		<dropForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="fk_authorizationGroupPositions_authorizationGroup" />
		<dropForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="fk_authorizationGroupPositions_position" />

		<dropForeignKeyConstraint
			baseTableName="comments" constraintName="fk_comments_author" />
		<dropForeignKeyConstraint
			baseTableName="comments" constraintName="fk_comments_report" />

		<dropForeignKeyConstraint
			baseTableName="organizations" constraintName="fk_organizations_parentOrg" />

		<dropForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="fk_peoplePositions_person" />
		<dropForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="fk_peoplePositions_position" />

		<dropForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="fk_positionsRelationships_idA" />
		<dropForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="fk_positionsRelationships_idB" />

		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_currPerson" />
		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_location" />
		<dropForeignKeyConstraint
			baseTableName="positions" constraintName="fk_positions_org" />

		<dropForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="fk_reportAuthorizationGroups_authorizationGroup" />
		<dropForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="fk_reportAuthorizationGroups_report" />

		<dropForeignKeyConstraint
			baseTableName="reportPeople" constraintName="fk_reportPeople_person" />
		<dropForeignKeyConstraint
			baseTableName="reportPeople" constraintName="fk_reportPeople_report" />

		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_advisorOrg" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_approvalStep" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_author" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_location" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="fk_reports_principalOrg" />

		<dropForeignKeyConstraint
			baseTableName="reportsSensitiveInformation" constraintName="fk_reportsSensitiveInformation_report" />

		<dropForeignKeyConstraint
			baseTableName="reportTags" constraintName="fk_reportTags_report" />
		<dropForeignKeyConstraint
			baseTableName="reportTags" constraintName="fk_reportTags_tag" />

		<dropForeignKeyConstraint
			baseTableName="reportTasks" constraintName="fk_reportTasks_poam" />
		<dropForeignKeyConstraint
			baseTableName="reportTasks" constraintName="fk_reportTasks_report" />

		<dropForeignKeyConstraint
			baseTableName="savedSearches" constraintName="fk_savedSearch_owner" />

		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="fk_tasks_org"/>
		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="fk_tasks_customFieldRef1Id"/>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-unique-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropUniqueConstraint
			tableName="authorizationGroupPositions" constraintName="uniqueAuthorizationGroupPositions" />
		<dropUniqueConstraint
			tableName="reportAuthorizationGroups" constraintName="uniqueReportAuthorizationGroup" />
		<dropUniqueConstraint
			tableName="reportPeople" constraintName="uniqueReportPerson" />
		<dropUniqueConstraint
			tableName="reportTags" constraintName="uniqueReportTag" />
		<dropUniqueConstraint
			tableName="reportTasks" constraintName="uniqueReportTask" />
		<dropUniqueConstraint
			tableName="reportsSensitiveInformation" constraintName="uniqueReport" />
		<dropUniqueConstraint
			tableName="savedSearches" constraintName="uniqueOwnerIdName" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-primaryKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<dropPrimaryKey
			tableName="approvalSteps" />
		<dropPrimaryKey
			tableName="authorizationGroups" />
		<dropPrimaryKey
			tableName="comments" />
		<dropPrimaryKey
			tableName="locations" />
		<dropPrimaryKey
			tableName="organizations" />
		<dropPrimaryKey
			tableName="people" />
		<dropPrimaryKey
			tableName="positions" />
		<dropPrimaryKey
			tableName="reports" />
		<dropPrimaryKey
			tableName="reportsSensitiveInformation" />
		<dropPrimaryKey
			tableName="savedSearches" />
		<dropPrimaryKey
			tableName="tags" />
		<dropPrimaryKey
			tableName="tasks" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-notNull-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<!-- only for foreign keys; primary keys have IDENTITY so cannot be null -->
		<dropNotNullConstraint
			tableName="approvalSteps" columnName="advisorOrganizationId" columnDataType="int"  />
		<dropNotNullConstraint
			tableName="authorizationGroupPositions" columnName="authorizationGroupId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="authorizationGroupPositions" columnName="positionId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="reportId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="authorizationGroupId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportTags" columnName="reportId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportTags" columnName="tagId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reports" columnName="authorId" columnDataType="int" />
		<dropNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="reportId" columnDataType="int" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-notNull-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<!-- primary keys -->
		<addNotNullConstraint
			tableName="approvalSteps" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="authorizationGroups" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="comments" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="locations" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="organizations" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="people" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="positions" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reports" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="savedSearches" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="tags" columnName="uuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="tasks" columnName="uuid" columnDataType="${uuid_type}" />
		<!-- foreign keys -->
		<addNotNullConstraint
			tableName="approvalSteps" columnName="advisorOrganizationUuid" columnDataType="${uuid_type}"  />
		<addNotNullConstraint
			tableName="authorizationGroupPositions" columnName="authorizationGroupUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="authorizationGroupPositions" columnName="positionUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="reportUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportAuthorizationGroups" columnName="authorizationGroupUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportTags" columnName="reportUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportTags" columnName="tagUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reports" columnName="authorUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint
			tableName="reportsSensitiveInformation" columnName="reportUuid" columnDataType="${uuid_type}" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-primaryKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addPrimaryKey
			tableName="approvalSteps" constraintName="PK_approvalSteps" columnNames="uuid" />
		<addPrimaryKey
			tableName="authorizationGroups" constraintName="PK_authorizationGroups" columnNames="uuid" />
		<addPrimaryKey
			tableName="comments" constraintName="PK_comments" columnNames="uuid" />
		<addPrimaryKey
			tableName="locations" constraintName="PK_locations" columnNames="uuid" />
		<addPrimaryKey
			tableName="organizations" constraintName="PK_organizations" columnNames="uuid" />
		<addPrimaryKey
			tableName="people" constraintName="PK_people" columnNames="uuid" />
		<addPrimaryKey
			tableName="positions" constraintName="PK_positions" columnNames="uuid" />
		<addPrimaryKey
			tableName="reports" constraintName="PK_reports" columnNames="uuid" />
		<addPrimaryKey
			tableName="reportsSensitiveInformation" constraintName="PK_reportsSensitiveInformation" columnNames="uuid" />
		<addPrimaryKey
			tableName="savedSearches" constraintName="PK_savedSearches" columnNames="uuid" />
		<addPrimaryKey
			tableName="tags" constraintName="PK_tags" columnNames="uuid" />
		<addPrimaryKey
			tableName="tasks" constraintName="PK_tasks" columnNames="uuid" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-unique-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint
			tableName="authorizationGroupPositions" constraintName="UQ_AuthorizationGroupPositions" columnNames="authorizationGroupUuid, positionUuid" />
		<addUniqueConstraint
			tableName="reportAuthorizationGroups" constraintName="UQ_ReportAuthorizationGroup" columnNames="reportUuid, authorizationGroupUuid" />
		<addUniqueConstraint
			tableName="reportPeople" constraintName="UQ_ReportPerson" columnNames="personUuid, reportUuid" />
		<addUniqueConstraint
			tableName="reportTags" constraintName="UQ_ReportTag" columnNames="reportUuid, tagUuid" />
		<addUniqueConstraint
			tableName="reportTasks" constraintName="UQ_ReportTask" columnNames="taskUuid, reportUuid" />
		<addUniqueConstraint
			tableName="reportsSensitiveInformation" constraintName="UQ_Report" columnNames="reportUuid" />
		<addUniqueConstraint
			tableName="savedSearches" constraintName="UQ_OwnerUuidName" columnNames="ownerUuid, name" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-foreignKey-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_step" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- FK constraint was missing before -->
		<addForeignKeyConstraint
			baseTableName="approvalActions" constraintName="FK_approvalActions_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_organization" baseColumnNames="advisorOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- FK constraint was missing before -->
		<addForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_nextStep" baseColumnNames="nextStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="approvers" constraintName="FK_approvers_step" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="approvers" constraintName="FK_approvers_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="FK_authorizationGroupPositions_authorizationGroup" baseColumnNames="authorizationGroupUuid"
			referencedTableName="authorizationGroups" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="authorizationGroupPositions" constraintName="FK_authorizationGroupPositions_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="comments" constraintName="FK_comments_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="comments" constraintName="FK_comments_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="organizations" constraintName="FK_organizations_parentOrg" baseColumnNames="parentOrgUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="FK_peoplePositions_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="peoplePositions" constraintName="FK_peoplePositions_position" baseColumnNames="positionUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="FK_positionsRelationships_positionA" baseColumnNames="positionUuid_a"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positionRelationships" constraintName="FK_positionsRelationships_positionB" baseColumnNames="positionUuid_b"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_currPerson" baseColumnNames="currentPersonUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_location" baseColumnNames="locationUuid"
			referencedTableName="locations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="positions" constraintName="FK_positions_org" baseColumnNames="organizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="FK_reportAuthorizationGroups_authorizationGroup" baseColumnNames="authorizationGroupUuid"
			referencedTableName="authorizationGroups" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportAuthorizationGroups" constraintName="FK_reportAuthorizationGroups_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportPeople" constraintName="FK_reportPeople_person" baseColumnNames="personUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportPeople" constraintName="FK_reportPeople_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_advisorOrg" baseColumnNames="advisorOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_approvalStep" baseColumnNames="approvalStepUuid"
			referencedTableName="approvalSteps" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_location" baseColumnNames="locationUuid"
			referencedTableName="locations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_principalOrg" baseColumnNames="principalOrganizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportsSensitiveInformation" constraintName="FK_reportsSensitiveInformation_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="CASCADE" />

		<addForeignKeyConstraint
			baseTableName="reportTags" constraintName="FK_reportTags_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportTags" constraintName="FK_reportTags_tag" baseColumnNames="tagUuid"
			referencedTableName="tags" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="reportTasks" constraintName="FK_reportTasks_task" baseColumnNames="taskUuid"
			referencedTableName="tasks" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="reportTasks" constraintName="FK_reportTasks_report" baseColumnNames="reportUuid"
			referencedTableName="reports" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="savedSearches" constraintName="FK_savedSearch_owner" baseColumnNames="ownerUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<addForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_organization" baseColumnNames="organizationUuid"
			referencedTableName="organizations" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_customFieldRef1" baseColumnNames="customFieldRef1Uuid"
			referencedTableName="tasks" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-unique-indexes" author="gjvoosten">
		<sql>
			CREATE UNIQUE ${non_clustered} INDEX "UQ_OrganizationIdentificationCode"
			ON organizations ( "identificationCode" )
			WHERE "identificationCode" IS NOT NULL
			AND "identificationCode" != '';

			CREATE UNIQUE ${non_clustered} INDEX "UQ_CurrentPersonInPosition"
			ON positions ("currentPersonUuid")
			WHERE "currentPersonUuid" IS NOT NULL;

			CREATE UNIQUE ${non_clustered} INDEX "UQ_PositionCodes"
			ON positions (code)
			WHERE code IS NOT NULL;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-uuid-fullText-indexes" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<sql>
			CREATE FULLTEXT INDEX ON authorizationGroups(name, description) KEY INDEX PK_authorizationGroups;
			CREATE FULLTEXT INDEX ON locations(name) KEY INDEX PK_locations;
			CREATE FULLTEXT INDEX ON organizations(longName, shortName, identificationCode) KEY INDEX PK_organizations;
			CREATE FULLTEXT INDEX ON people(name, emailAddress, biography) KEY INDEX PK_people;
			CREATE FULLTEXT INDEX ON positions(name, code) KEY INDEX PK_positions;
			CREATE FULLTEXT INDEX ON reports(text, nextSteps, intent, atmosphereDetails, keyOutcomes) KEY INDEX PK_reports;
			CREATE FULLTEXT INDEX ON tags(name, description) KEY INDEX PK_tags;
			CREATE FULLTEXT INDEX ON tasks(longName, shortName, customField) KEY INDEX PK_tasks;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-foreignKey-columns" author="gjvoosten">
		<dropColumn tableName="approvalActions" columnName="approvalStepId" />
		<dropColumn tableName="approvalActions" columnName="personId" />
		<dropColumn tableName="approvalActions" columnName="reportId" />
		<dropColumn tableName="approvalSteps" columnName="advisorOrganizationId" />
		<dropColumn tableName="approvalSteps" columnName="nextStepId" />
		<dropColumn tableName="approvers" columnName="approvalStepId" />
		<dropColumn tableName="approvers" columnName="positionId" />
		<dropColumn tableName="authorizationGroupPositions" columnName="authorizationGroupId" />
		<dropColumn tableName="authorizationGroupPositions" columnName="positionId" />
		<dropColumn tableName="comments" columnName="authorId" />
		<dropColumn tableName="comments" columnName="reportId" />
		<dropColumn tableName="organizations" columnName="parentOrgId" />
		<dropColumn tableName="peoplePositions" columnName="personId" />
		<dropColumn tableName="peoplePositions" columnName="positionId" />
		<dropColumn tableName="positionRelationships" columnName="positionId_a" />
		<dropColumn tableName="positionRelationships" columnName="positionId_b" />
		<dropColumn tableName="positions" columnName="currentPersonId" />
		<dropColumn tableName="positions" columnName="locationId" />
		<dropColumn tableName="positions" columnName="organizationId" />
		<dropColumn tableName="reportAuthorizationGroups" columnName="authorizationGroupId" />
		<dropColumn tableName="reportAuthorizationGroups" columnName="reportId" />
		<dropColumn tableName="reportPeople" columnName="personId" />
		<dropColumn tableName="reportPeople" columnName="reportId" />
		<dropColumn tableName="reports" columnName="advisorOrganizationId" />
		<dropColumn tableName="reports" columnName="approvalStepId" />
		<dropColumn tableName="reports" columnName="authorId" />
		<dropColumn tableName="reports" columnName="locationId" />
		<dropColumn tableName="reports" columnName="principalOrganizationId" />
		<dropColumn tableName="reportsSensitiveInformation" columnName="reportId" />
		<dropColumn tableName="reportTags" columnName="reportId" />
		<dropColumn tableName="reportTags" columnName="tagId" />
		<dropColumn tableName="reportTasks" columnName="reportId" />
		<dropColumn tableName="reportTasks" columnName="taskId" />
		<dropColumn tableName="savedSearches" columnName="ownerId" />
		<dropColumn tableName="tasks" columnName="customFieldRef1Id" />
		<dropColumn tableName="tasks" columnName="organizationId" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="update-uuid-savedSearches" author="gjvoosten">
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			-- Add JSON fields for the new uuid's
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeeUuid', (SELECT uuid FROM people WHERE id=JSON_VALUE(query, '$.attendeeId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeePositionUuid', (SELECT uuid FROM positions WHERE id=JSON_VALUE(query, '$.attendeePositionId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorUuid', (SELECT uuid FROM people WHERE id=JSON_VALUE(query, '$.authorId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorPositionUuid', (SELECT uuid FROM positions WHERE id=JSON_VALUE(query, '$.authorPositionId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.locationUuid', (SELECT uuid FROM locations WHERE id=JSON_VALUE(query, '$.locationId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.orgUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.orgId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.organizationUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.organizationId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', (SELECT uuid FROM organizations WHERE id=JSON_VALUE(query, '$.responsibleOrgId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.tagUuid', (SELECT uuid FROM tags WHERE id=JSON_VALUE(query, '$.tagId')));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskUuid', (SELECT uuid FROM tasks WHERE id=JSON_VALUE(query, '$.taskId')));
			-- Remove JSON fields for the old id's
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeeId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.attendeePositionId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.authorPositionId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.locationId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.orgId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.organizationId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.tagId', NULL);
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskId', NULL);
		</sql>
		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
			-- Add JSON fields for the new uuid's
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{attendeeUuid}', TO_JSONB(p.uuid), true)
				FROM people p WHERE p.id=(s.query::json->>'attendeeId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{attendeePositionUuid}', TO_JSONB(p.uuid), true)
				FROM positions p WHERE p.id=(s.query::json->>'attendeePositionId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{authorUuid}', TO_JSONB(p.uuid), true)
				FROM people p WHERE p.id=(s.query::json->>'authorId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{authorPositionUuid}', TO_JSONB(p.uuid), true)
				FROM positions p WHERE p.id=(s.query::json->>'authorPositionId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{locationUuid}', TO_JSONB(l.uuid), true)
				FROM locations l WHERE l.id=(s.query::json->>'locationId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{orgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'orgId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{orgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'organizationId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{responsibleOrgUuid}', TO_JSONB(o.uuid), true)
				FROM organizations o WHERE o.id=(s.query::json->>'responsibleOrgId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{tagUuid}', TO_JSONB(t.uuid), true)
				FROM tags t WHERE t.id=(s.query::json->>'tagId')::int;
			UPDATE "savedSearches" s SET query=JSONB_SET(query::jsonb, '{taskUuid}', TO_JSONB(t.uuid), true)
				FROM tasks t WHERE t.id=(s.query::json->>'taskId')::int;
			-- Remove JSON fields for the old id's
			UPDATE "savedSearches" SET query=query::jsonb #- '{attendeeId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{attendeePositionId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{authorId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{authorPositionId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{locationId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{orgId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{organizationId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{responsibleOrgId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{tagId}';
			UPDATE "savedSearches" SET query=query::jsonb #- '{taskId}';
		</sql>
		<!-- No JSON manipulation in SQLite: -->
		<sql dbms="sqlite">
			DELETE FROM "savedSearches";
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-reports-legacyId-column" author="gjvoosten">
		<!-- Create a new legacy id column for reports and fill it with the old id -->
		<addColumn tableName="reports">
			<column name="legacyId" type="int" />
		</addColumn>
		<sql dbms="mssql">
		    UPDATE reports SET legacyId=id;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-reports-legacyId-column-2" author="gjvoosten">
		<!-- correct syntax -->
		<sql dbms="postgresql,sqlite">
		    UPDATE reports SET "legacyId"=id;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="drop-id-primaryKey-columns" author="gjvoosten">
		<dropColumn tableName="approvalSteps" columnName="id" />
		<dropColumn tableName="authorizationGroups" columnName="id" />
		<dropColumn tableName="comments" columnName="id" />
		<dropColumn tableName="locations" columnName="id" />
		<dropColumn tableName="organizations" columnName="id" />
		<dropColumn tableName="people" columnName="id" />
		<dropColumn tableName="positions" columnName="id" />
		<dropColumn tableName="reports" columnName="id" />
		<dropColumn tableName="reportsSensitiveInformation" columnName="id" />
		<dropColumn tableName="savedSearches" columnName="id" />
		<dropColumn tableName="tags" columnName="id" />
		<dropColumn tableName="tasks" columnName="id" />
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add_notes" author="gjvoosten">
		<createTable tableName="notes">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="text" type="${long_text_type}" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="notes" constraintName="FK_notes_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<createTable tableName="noteRelatedObjects">
			<column name="noteUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint
			baseTableName="noteRelatedObjects" constraintName="FK_noteRelatedObjects_note" baseColumnNames="noteUuid"
			referencedTableName="notes" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
	</changeSet>

	<changeSet id="renameApprovalActions-to-ReportActions-sqlite-combined-tables" author="maradragan" dbms="mssql,postgresql">
		<comment>Rename approvalActions table to reportActions.</comment>
		<!-- reportActions -->
		<renameTable
			newTableName="reportActions"
			oldTableName="approvalActions" />
		<rollback>
			<renameTable
				newTableName="approvalActions"
				oldTableName="reportActions" />
		</rollback>
	</changeSet>

	<changeSet id="migrate_submit_and_publish_action" author="maradragan" dbms="mssql">
		<comment>Add submit and publish report actions for existing reports.</comment>
		<sql>
			INSERT INTO reportActions (reportUuid, createdAt, type)
				SELECT
					uuid, releasedAt, 3
				FROM reports
				WHERE state = 2
			;
			INSERT INTO reportActions (reportUuid, createdAt, personUuid, type)
				SELECT ra.reportUuid, DATEADD(SECOND, -1, ra.createdAt), r.authorUuid, 2
				FROM (
					SELECT
					reportUuid, MIN(createdAt) as createdAt
					FROM reportActions
					GROUP BY reportUuid ) ra,
				reports r
				WHERE
					ra.reportUuid = r.uuid
			;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-assessment-to-Tasks" author="VassilIordanov">
		<addColumn tableName="tasks">
			<column name="assessment" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-reports-duration-column" author="gjvoosten">
		<addColumn tableName="reports">
			<column name="duration" type="int" />
		</addColumn>
	</changeSet>

	<changeSet id="add-notes-type-column" author="gjvoosten">
		<!-- Create a new type column for notes and fill it with the the default value of 0 -->
		<addColumn tableName="notes">
			<column name="type" type="int" defaultValue="0">
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="migrate-tasks-assessments" author="gjvoosten" dbms="mssql">
		<!-- Column tasks.assessment will never have existed in PostgreSQL or SQLite -->
		<createTable tableName="tmpTasksAssessments">
			<column name="uuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="authorUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="text" type="${long_text_type}" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
		<!-- Requires at least SQL Server 2016: -->
		<sql>
			INSERT INTO PEOPLE (uuid, name, status, role, createdAt, updatedAt)
			    VALUES (${uuid_function}, 'ANET Importer', 1, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);

			INSERT INTO tmpTasksAssessments (uuid, authorUuid, taskUuid, text)
				SELECT ${uuid_function},
					(SELECT uuid FROM people WHERE name = 'ANET Importer' AND status = 1 AND role = 0),
					tasks.uuid,
					JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(JSON_MODIFY('{"oldValue":null,"newValue":null}', '$.text', tasks.assessment), '$.changedField', 'customFieldEnum1'), 'strict $.oldValue', tasks.customFieldEnum1), 'strict $.newValue', tasks.customFieldEnum1)
				FROM tasks
				WHERE NOT (tasks.assessment IS NULL OR tasks.assessment = '');

			INSERT INTO notes (uuid, authorUuid, type, text, createdAt, updatedAt)
				SELECT uuid, authorUuid, 1, text, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
				FROM tmpTasksAssessments;

			INSERT INTO noteRelatedObjects (noteUuid, relatedObjectType, relatedObjectUuid)
				SELECT uuid, 'tasks', taskUuid
				FROM tmpTasksAssessments;
		</sql>
		<dropTable tableName="tmpTasksAssessments" />
	</changeSet>

	<changeSet id="drop-assessment-from-Tasks" author="gjvoosten">
		<dropColumn tableName="tasks" columnName="assessment" />
	</changeSet>

	<changeSet id="add_task_responsible_positions" author="maradragan">
		<createTable tableName="taskResponsiblePositions">
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="positionUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="add_task_positions_constraints" author="maradragan" dbms="mssql,postgresql">
		<addUniqueConstraint tableName="taskResponsiblePositions" columnNames="taskUuid, positionUuid" constraintName="uniquetaskResponsiblePositions" />
		<addForeignKeyConstraint baseColumnNames="taskUuid" baseTableName="taskResponsiblePositions"
			constraintName="fk_taskResponsiblePositions_task" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="positionUuid" baseTableName="taskResponsiblePositions"
			constraintName="fk_taskResponsiblePositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="positions" />
	</changeSet>

	<changeSet id="add-foreignKey-indexes" author="gjvoosten">
		<createIndex
			indexName="IDX_approvalSteps_advisorOrganizationUuid" tableName="approvalSteps">
			<column name="advisorOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvalSteps_nextStepUuid" tableName="approvalSteps">
			<column name="nextStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvers_approvalStepUuid" tableName="approvers">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_approvers_positionUuid" tableName="approvers">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroupPositions_authorizationGroupUuid" tableName="authorizationGroupPositions">
			<column name="authorizationGroupUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroupPositions_positionUuid" tableName="authorizationGroupPositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_comments_authorUuid" tableName="comments">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_comments_reportUuid" tableName="comments">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_noteRelatedObjects_noteUuid" tableName="noteRelatedObjects">
			<column name="noteUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_notes_authorUuid" tableName="notes">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_parentOrgUuid" tableName="organizations">
			<column name="parentOrgUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_peoplePositions_personUuid" tableName="peoplePositions">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_peoplePositions_positionUuid" tableName="peoplePositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positionRelationships_positionUuid_a" tableName="positionRelationships">
			<column name="positionUuid_a"/>
		</createIndex>
		<createIndex
			indexName="IDX_positionRelationships_positionUuid_b" tableName="positionRelationships">
			<column name="positionUuid_b"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_currentPersonUuid" tableName="positions">
			<column name="currentPersonUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_locationUuid" tableName="positions">
			<column name="locationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_organizationUuid" tableName="positions">
			<column name="organizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_approvalStepUuid" tableName="reportActions">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_personUuid" tableName="reportActions">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportActions_reportUuid" tableName="reportActions">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportAuthorizationGroups_authorizationGroupUuid" tableName="reportAuthorizationGroups">
			<column name="authorizationGroupUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportAuthorizationGroups_reportUuid" tableName="reportAuthorizationGroups">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportPeople_personUuid" tableName="reportPeople">
			<column name="personUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportPeople_reportUuid" tableName="reportPeople">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTags_reportUuid" tableName="reportTags">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTags_tagUuid" tableName="reportTags">
			<column name="tagUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTasks_reportUuid" tableName="reportTasks">
			<column name="reportUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reportTasks_taskUuid" tableName="reportTasks">
			<column name="taskUuid"/>
		</createIndex>
		<!-- reportsSensitiveInformation.reportUuid already has a unique constraint/index -->
		<createIndex
			indexName="IDX_reports_advisorOrganizationUuid" tableName="reports">
			<column name="advisorOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_approvalStepUuid" tableName="reports">
			<column name="approvalStepUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_authorUuid" tableName="reports">
			<column name="authorUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_locationUuid" tableName="reports">
			<column name="locationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_principalOrganizationUuid" tableName="reports">
			<column name="principalOrganizationUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_savedSearches_ownerUuid" tableName="savedSearches">
			<column name="ownerUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskResponsiblePositions_positionUuid" tableName="taskResponsiblePositions">
			<column name="positionUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskResponsiblePositions_taskUuid" tableName="taskResponsiblePositions">
			<column name="taskUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_customFieldRef1Uuid" tableName="tasks">
			<column name="customFieldRef1Uuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_organizationUuid" tableName="tasks">
			<column name="organizationUuid"/>
		</createIndex>
	</changeSet>

	<changeSet id="add-orderBy-indexes" author="gjvoosten">
		<createIndex
			indexName="IDX_authorizationGroups_createdAt" tableName="authorizationGroups">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroups_name" tableName="authorizationGroups">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_locations_createdAt" tableName="locations">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_locations_name" tableName="locations">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_createdAt" tableName="organizations">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_identificationCode" tableName="organizations">
			<column name="identificationCode"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_longName" tableName="organizations">
			<column name="longName"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_shortName" tableName="organizations">
			<column name="shortName"/>
		</createIndex>
		<createIndex
			indexName="IDX_organizations_type" tableName="organizations">
			<column name="type"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_createdAt" tableName="people">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_name" tableName="people">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_people_rank" tableName="people">
			<column name="rank"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_code" tableName="positions">
			<column name="code"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_createdAt" tableName="positions">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_positions_name" tableName="positions">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_createdAt" tableName="reports">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_engagementDate" tableName="reports">
			<column name="engagementDate"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_releasedAt" tableName="reports">
			<column name="releasedAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_reports_updatedAt" tableName="reports">
			<column name="updatedAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_tags_createdAt" tableName="tags">
			<column name="createdAt"/>
		</createIndex>
		<createIndex
			indexName="IDX_tags_name" tableName="tags">
			<column name="name"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_category" tableName="tasks">
			<column name="category"/>
		</createIndex>
		<createIndex
			indexName="IDX_tasks_createdAt" tableName="tasks">
			<column name="createdAt"/>
		</createIndex>
		<!-- tasks.shortName already has a unique constraint/index -->
	</changeSet>

	<changeSet id="add-avatars-to-People" author="jose-west">
		<addColumn tableName="people">
			<column name="avatar" type="blob"/>
		</addColumn>
	</changeSet>

	<changeSet id="add-approvalSteps-type-column" author="maradragan">
		<!-- Create a new type column for approval steps and fill it for the existing approval steps -->
		<addColumn tableName="approvalSteps">
			<column name="type" type="int" />
		</addColumn>
		<sql>
			UPDATE "approvalSteps" SET type=1;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-approvalSteps-type-notnull-constraint" author="maradragan" dbms="mssql,postgresql">
		<addNotNullConstraint
			columnDataType="int"
			columnName="type"
			tableName="approvalSteps" />
	</changeSet>

	<changeSet id="move_future_to_draft" author="maradragan">
		<sql>
			UPDATE reports SET state=0 WHERE state=5;
		</sql>
		<rollback>
			<sql>
				UPDATE reports SET state=5 WHERE "engagementDate" > CURRENT_TIMESTAMP;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-endedAt-to-peoplePositions" author="mdragan">
		<addColumn tableName="peoplePositions">
			<column name="endedAt" type="datetime" />
		</addColumn>
		<sql dbms="mssql">
			ALTER TABLE peoplePositions ALTER COLUMN endedAt datetime2;
		</sql>
	</changeSet>

	<changeSet id="fill-endedAt-peoplePositions-column" author="mdragan">
		<comment>Populate the new endedAt column of the peoplePositions table.</comment>
		<sql dbms="mssql">
			UPDATE "peoplePositions" SET "endedAt" = (
				SELECT TOP(1) "createdAt"
				FROM "peoplePositions" next
				WHERE
					next."positionUuid" = "peoplePositions"."positionUuid" AND
					next."createdAt" > "peoplePositions"."createdAt"
				ORDER BY next."createdAt"
			);
		</sql>
		<sql dbms="postgresql">
			UPDATE "peoplePositions" SET "endedAt" = (
				SELECT "createdAt"
				FROM "peoplePositions" next
				WHERE
					next."positionUuid" = "peoplePositions"."positionUuid" AND
					next."createdAt" > "peoplePositions"."createdAt"
				ORDER BY next."createdAt"
				LIMIT 1
			);
		</sql>
		<rollback>
			UPDATE "peoplePositions" set "endedAt" = NULL;
		</rollback>
	</changeSet>

	<changeSet id="alter-fulltext-stoplist" author="gjvoosten" dbms="mssql" runInTransaction="false">
		<!--
		  Most columns in the full-text index (except for the reports columns,
		  and people.biography) do not contain English text; don't use a stoplist
		  for these. Note that we can have only one full-text index per table, so
		  people.biography no longer has a stoplist with this changeSet.
		-->
		<sql>
			ALTER FULLTEXT INDEX ON authorizationGroups SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON locations SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON organizations SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON people SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON positions SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON tags SET STOPLIST = OFF;
			ALTER FULLTEXT INDEX ON tasks SET STOPLIST = OFF;
			ALTER FULLTEXT CATALOG anet_ft_catalog REBUILD WITH ACCENT_SENSITIVITY = OFF;
		</sql>
		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-people-code" author="gjvoosten">
		<addColumn tableName="people">
			<column name="code" type="nvarchar(100)" />
		</addColumn>
	</changeSet>

	<changeSet id="add_task_responsible_organizations" author="gjvoosten">
		<!-- Add new m2m table -->
		<createTable tableName="taskTaskedOrganizations">
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="organizationUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- Add FK constraints and indexes -->
		<addForeignKeyConstraint baseColumnNames="taskUuid" baseTableName="taskTaskedOrganizations"
			constraintName="FK_taskTaskedOrganizations_task" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="organizationUuid" baseTableName="taskTaskedOrganizations"
			constraintName="FK_taskTaskedOrganizations_organization" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="organizations" />
		<createIndex
			indexName="IDX_taskTaskedOrganizations_taskUuid" tableName="taskTaskedOrganizations">
			<column name="taskUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_taskTaskedOrganizations_organizationUuid" tableName="taskTaskedOrganizations">
			<column name="organizationUuid"/>
		</createIndex>

		<!-- Migrate saved searches -->
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskedOrgUuid', JSON_VALUE(query, '$.responsibleOrgUuid'));
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', NULL);
		</sql>
		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
			UPDATE "savedSearches" SET query=JSONB_SET(query::jsonb, '{taskedOrgUuid}', query::jsonb->'responsibleOrgUuid', true);
			UPDATE "savedSearches" SET query=query::jsonb #- '{responsibleOrgUuid}';
		</sql>

		<!-- Migrate task responsible organizations -->
		<sql>
			INSERT INTO "taskTaskedOrganizations" ( "taskUuid", "organizationUuid")
				SELECT uuid, "organizationUuid" FROM tasks
				WHERE "organizationUuid" IS NOT NULL;
		</sql>

		<!-- Drop old index and FK constraint -->
		<dropIndex
			indexName="IDX_tasks_organizationUuid" tableName="tasks"/>
		<dropForeignKeyConstraint
			baseTableName="tasks" constraintName="FK_tasks_organization"/>

		<!-- Finally, drop old column -->
		<dropColumn tableName="tasks" columnName="organizationUuid"/>

		<rollback>
			<!-- Recreate old column -->
			<addColumn tableName="tasks">
				<column name="organizationUuid" type="${uuid_type}" />
			</addColumn>

			<!-- Recreate old FK constraint and index -->
			<addForeignKeyConstraint
				baseTableName="tasks" constraintName="FK_tasks_organization" baseColumnNames="organizationUuid"
				referencedTableName="organizations" referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION" />
			<createIndex
				indexName="IDX_tasks_organizationUuid" tableName="tasks">
				<column name="organizationUuid"/>
			</createIndex>

			<!-- Migrate back task responsible organizations; pick the first one (there might be more) -->
			<sql dbms="mssql">
				UPDATE tasks
				SET "organizationUuid" = (
					SELECT TOP(1) "organizationUuid" FROM "taskTaskedOrganizations"
					WHERE "taskUuid" = tasks.uuid
				);
			</sql>
			<sql dbms="postgresql">
				UPDATE tasks
				SET "organizationUuid" = (
					SELECT "organizationUuid" FROM "taskTaskedOrganizations"
					WHERE "taskUuid" = tasks.uuid
					LIMIT 1
				);
			</sql>

			<!-- Migrate back saved searches -->
			<!-- Requires at least SQL Server 2016: -->
			<sql dbms="mssql">
				UPDATE savedSearches SET query=JSON_MODIFY(query, '$.responsibleOrgUuid', JSON_VALUE(query, '$.taskedOrgUuid'));
				UPDATE savedSearches SET query=JSON_MODIFY(query, '$.taskedOrgUuid', NULL);
			</sql>
			<!-- Requires at least PostgreSQL 9.5: -->
			<sql dbms="postgresql">
				UPDATE "savedSearches" SET query=JSONB_SET(query::jsonb, '{responsibleOrgUuid}', query::jsonb->'taskedOrgUuid', true);
				UPDATE "savedSearches" SET query=query::jsonb #- '{taskedOrgUuid}';
			</sql>

			<!-- Finally, drop new m2m table (also drops FK constraints and indexes) -->
			<dropTable tableName="taskTaskedOrganizations" />
		</rollback>
	</changeSet>

	<changeSet id="add-postgresql-fulltext" author="gjvoosten" dbms="postgresql">
		<sql>
			<!-- Create text search configuration -->
			DROP TEXT SEARCH CONFIGURATION IF EXISTS ${fts_config_name};
			CREATE TEXT SEARCH CONFIGURATION ${fts_config_name} ( COPY = pg_catalog.english );
			ALTER TEXT SEARCH CONFIGURATION ${fts_config_name} ALTER MAPPING FOR hword, hword_part, word WITH unaccent, english_stem;

			<!-- Add generated full-text columns -->
			ALTER TABLE "authorizationGroups"
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".description, '')), ${fts_low})
				) STORED;

			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(organizations."identificationCode", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(organizations."shortName", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE notes
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(notes.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(people.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people.code, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."domainUsername", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."emailAddress", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people."phoneNumber", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(people.biography, '')), ${fts_low})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(positions.code, '')), ${fts_high})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(reports.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE tags
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tags.name, '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(tags.description, '')), ${fts_low})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tasks."shortName", '')), ${fts_high})
					|| setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Create full-text materialized views and indexes -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_authorizationGroups"(uuid, full_text) AS
				SELECT
					"authorizationGroups".uuid,
					"authorizationGroups".full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM "authorizationGroups"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'authorizationGroups'
					AND "noteRelatedObjects"."relatedObjectUuid" = "authorizationGroups".uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY "authorizationGroups".uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_authorizationGroups_uuid" ON "mv_fts_authorizationGroups"(uuid);
			CREATE INDEX "FT_mv_fts_authorizationGroups" ON "mv_fts_authorizationGroups" USING gin(full_text);
			CREATE INDEX "TR_authorizationGroups_uuid" ON "mv_fts_authorizationGroups" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
				SELECT
					reports.uuid,
					reports.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM reports
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
					AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY reports.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tags(uuid, full_text) AS
				SELECT
					tags.uuid,
					tags.full_text
				FROM tags
				GROUP BY tags.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tags" ON mv_fts_tags(uuid);
			CREATE INDEX "FT_mv_fts_tags" ON mv_fts_tags USING gin(full_text);
			CREATE INDEX "TR_tags_uuid" ON mv_fts_tags USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
				SELECT
					tasks.uuid,
					tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM tasks
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
					AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
		<rollback>
			<sql>
				<!-- Drop full-text materialized views (incl. indexes) -->
				DROP MATERIALIZED VIEW "mv_fts_authorizationGroups";
				DROP MATERIALIZED VIEW mv_fts_locations;
				DROP MATERIALIZED VIEW mv_fts_organizations;
				DROP MATERIALIZED VIEW mv_fts_people;
				DROP MATERIALIZED VIEW mv_fts_positions;
				DROP MATERIALIZED VIEW mv_fts_reports;
				DROP MATERIALIZED VIEW mv_fts_tags;
				DROP MATERIALIZED VIEW mv_fts_tasks;

				<!-- Drop generated full-text columns -->
				ALTER TABLE "authorizationGroups" DROP COLUMN full_text;
				ALTER TABLE locations DROP COLUMN full_text;
				ALTER TABLE organizations DROP COLUMN full_text;
				ALTER TABLE notes DROP COLUMN full_text;
				ALTER TABLE people DROP COLUMN full_text;
				ALTER TABLE positions DROP COLUMN full_text;
				ALTER TABLE reports DROP COLUMN full_text;
				ALTER TABLE tags DROP COLUMN full_text;
				ALTER TABLE tasks DROP COLUMN full_text;

				<!-- Drop text search configuration -->
				DROP TEXT SEARCH CONFIGURATION ${fts_config_name};
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-custom-fields-to-reports" author="maradragan">
		<addColumn tableName="reports">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-fields-to-people" author="maradragan">
		<addColumn tableName="people">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-custom-fields-to-tasks" author="maradragan">
		<addColumn tableName="tasks">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="drop-FK_approvalSteps_organization" author="gjvoosten" dbms="mssql,postgresql">
		<dropForeignKeyConstraint
			baseTableName="approvalSteps" constraintName="FK_approvalSteps_organization" />
	</changeSet>

	<changeSet id="drop-IDX_approvalSteps_advisorOrganizationUuid" author="gjvoosten">
		<dropIndex
			tableName="approvalSteps" indexName="IDX_approvalSteps_advisorOrganizationUuid" />
	</changeSet>

	<changeSet id="rename-approvalSteps-advisorOrganizationUuid" author="gjvoosten">
		 <renameColumn
			 tableName="approvalSteps"
			 oldColumnName="advisorOrganizationUuid"
			 newColumnName="relatedObjectUuid"
			 columnDataType="${uuid_type}" />
	 </changeSet>

	<changeSet id="add-IDX_approvalSteps_relatedObjectUuid" author="gjvoosten">
		<createIndex
			tableName="approvalSteps" indexName="IDX_approvalSteps_relatedObjectUuid">
			<column name="relatedObjectUuid" />
		</createIndex>
	</changeSet>

	<changeSet id="change-avatar-type" author="gjvoosten">
		<!-- This temporarily needs about twice the storage space for all avatars -->
		<addColumn tableName="people">
			<column name="b64_avatar" type="${long_text_type}" />
		</addColumn>
		<sql dbms="postgresql">
			UPDATE people SET b64_avatar = encode(lo_get(avatar), 'escape') WHERE avatar IS NOT NULL;
			SELECT lo_unlink(oid) FROM pg_largeobject_metadata;
		</sql>
		<sql dbms="mssql">
			UPDATE people SET b64_avatar = cast(avatar as varchar(max)) WHERE avatar IS NOT NULL;
		</sql>
		<dropColumn tableName="people" columnName="avatar" />
		<addColumn tableName="people">
			<column name="new_avatar" type="${blob_type}" />
		</addColumn>
		<sql dbms="postgresql">
			UPDATE people SET new_avatar = decode(b64_avatar, 'base64') WHERE b64_avatar IS NOT NULL;
		</sql>
		<sql dbms="mssql">
			UPDATE people SET new_avatar = cast(N'' AS xml).value('xs:base64Binary(sql:column("people.b64_avatar"))', 'varbinary(max)') WHERE b64_avatar IS NOT NULL;
		</sql>
		<dropColumn tableName="people" columnName="b64_avatar" />
		<renameColumn
			columnDataType="${blob_type}"
			oldColumnName="new_avatar"
			newColumnName="avatar"
			tableName="people" />
	</changeSet>

	<changeSet id="clean-postgresql-large-objects" author="gjvoosten" dbms="postgresql" runInTransaction="false">
		<sql>
			VACUUM FULL ANALYZE pg_largeobject;
		</sql>
	</changeSet>

	<changeSet id="add-approvalSteps-restrictedApproval" author="gjvoosten">
		<addColumn tableName="approvalSteps">
			<column name="restrictedApproval" type="boolean" defaultValue="false" />
		</addColumn>
	</changeSet>

	<changeSet id="alter-postgresql-fulltext" author="gjvoosten" dbms="postgresql">
		<sql>
			<!-- Drop full-text materialized views (incl. indexes) -->
			DROP MATERIALIZED VIEW "mv_fts_authorizationGroups";
			DROP MATERIALIZED VIEW mv_fts_locations;
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions;
			DROP MATERIALIZED VIEW mv_fts_reports;
			DROP MATERIALIZED VIEW mv_fts_tags;
			DROP MATERIALIZED VIEW mv_fts_tasks;

			<!-- Drop generated full-text columns -->
			ALTER TABLE "authorizationGroups" DROP COLUMN full_text;
			ALTER TABLE locations DROP COLUMN full_text;
			ALTER TABLE organizations DROP COLUMN full_text;
			ALTER TABLE notes DROP COLUMN full_text;
			ALTER TABLE people DROP COLUMN full_text;
			ALTER TABLE positions DROP COLUMN full_text;
			ALTER TABLE reports DROP COLUMN full_text;
			ALTER TABLE tags DROP COLUMN full_text;
			ALTER TABLE tasks DROP COLUMN full_text;

			<!-- Re-add generated full-text columns;
			     use 'anet' config only for columns containing English text,
			     use 'simple' config for all columns -->
			ALTER TABLE "authorizationGroups"
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".name, ''))
						  || to_tsvector('simple', coalesce("authorizationGroups".name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".description, ''))
						  || to_tsvector('simple', coalesce("authorizationGroups".description, '')), ${fts_low})
				) STORED;

			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
						  || to_tsvector('simple', coalesce(locations.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
						  || to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE notes
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(notes.text, ''))
						  || to_tsvector('simple', coalesce(notes.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."emailAddress", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
						  || to_tsvector('simple', coalesce(people.biography, '')), ${fts_low})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(positions.code, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, ''))
						  || to_tsvector('simple', coalesce(positions.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, ''))
						  || to_tsvector('simple', coalesce(reports.intent, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", ''))
						  || to_tsvector('simple', coalesce(reports."keyOutcomes", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", ''))
						  || to_tsvector('simple', coalesce(reports."nextSteps", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports.text, ''))
						  || to_tsvector('simple', coalesce(reports.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE tags
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tags.name, ''))
						  || to_tsvector('simple', coalesce(tags.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tags.description, ''))
						  || to_tsvector('simple', coalesce(tags.description, '')), ${fts_low})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
						  || to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Re-create full-text materialized views and indexes -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_authorizationGroups"(uuid, full_text) AS
				SELECT
					"authorizationGroups".uuid,
					"authorizationGroups".full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM "authorizationGroups"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'authorizationGroups'
					AND "noteRelatedObjects"."relatedObjectUuid" = "authorizationGroups".uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY "authorizationGroups".uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_authorizationGroups_uuid" ON "mv_fts_authorizationGroups"(uuid);
			CREATE INDEX "FT_mv_fts_authorizationGroups" ON "mv_fts_authorizationGroups" USING gin(full_text);
			CREATE INDEX "TR_authorizationGroups_uuid" ON "mv_fts_authorizationGroups" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
				SELECT
					reports.uuid,
					reports.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM reports
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
					AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY reports.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tags(uuid, full_text) AS
				SELECT
					tags.uuid,
					tags.full_text
				FROM tags
				GROUP BY tags.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tags" ON mv_fts_tags(uuid);
			CREATE INDEX "FT_mv_fts_tags" ON mv_fts_tags USING gin(full_text);
			CREATE INDEX "TR_tags_uuid" ON mv_fts_tags USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
				SELECT
					tasks.uuid,
					tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM tasks
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
					AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="update-task-assessment-questions" author="gjvoosten">
		<!-- Note: the demo data has at most 3 assessment definitions for any one task
		     and field installations have at most 2, so only update the first 3. -->

		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
		<![CDATA[
			-- change all &#34; to " inside 'questions'
			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[0].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[0].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[0].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[0].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[0].questions') LIKE '%&#34;%';

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[1].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[1].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[1].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[1].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[1].questions') LIKE '%&#34;%';

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[2].questions', REPLACE(JSON_VALUE(customFields, 'strict $.assessments[2].questions'), '&#34;', '"'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[2].questions') IS NOT NULL
			AND ISJSON(JSON_VALUE(customFields, 'strict $.assessments[2].questions')) = 0
			AND JSON_VALUE(customFields, 'strict $.assessments[2].questions') LIKE '%&#34;%';

			-- change all 'questions' from string to JSON
			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[0].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[0].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[0].questions') IS NOT NULL;

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[1].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[1].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[1].questions') IS NOT NULL;

			UPDATE tasks
			SET customFields = JSON_MODIFY(customFields, '$.assessments[2].questions', JSON_QUERY(JSON_VALUE(customFields, 'strict $.assessments[2].questions'), '$'))
			WHERE ISJSON(customFields) = 1
			AND JSON_VALUE(customFields, 'lax $.assessments[2].questions') IS NOT NULL;
		]]>
		</sql>

		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
		<![CDATA[
			-- create convenience function
			CREATE OR REPLACE FUNCTION is_valid_json(p_json text)
				RETURNS boolean
			AS
			'
			BEGIN
				IF p_json IS NULL THEN
					RETURN NULL;
				ELSE
					RETURN (p_json::json IS NOT NULL);
				END IF;
			EXCEPTION
				WHEN OTHERS THEN
					RETURN FALSE;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			-- change all &#34; to " inside 'questions'
			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 0, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 0, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 0, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 0, questions}' LIKE '%&#34;%';

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 1, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 1, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 1, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 1, questions}' LIKE '%&#34;%';

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 2, questions}', to_jsonb(replace("customFields"::jsonb#>>'{assessments, 2, questions}', '&#34;', '"')::text))
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 2, questions}') IS FALSE
			AND "customFields"::jsonb#>>'{assessments, 2, questions}' LIKE '%&#34;%';

			-- change all 'questions' from string to JSON
			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 0, questions}', ("customFields"::jsonb#>>'{assessments, 0, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 0, questions}') IS TRUE;

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 1, questions}', ("customFields"::jsonb#>>'{assessments, 1, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 1, questions}') IS TRUE;

			UPDATE tasks
			SET "customFields" = JSONB_SET("customFields"::jsonb, '{assessments, 2, questions}', ("customFields"::jsonb#>>'{assessments, 2, questions}')::text::jsonb)
			WHERE is_valid_json("customFields") IS TRUE
			AND is_valid_json("customFields"::jsonb#>>'{assessments, 2, questions}') IS TRUE;

			-- drop convenience function
			DROP FUNCTION IF EXISTS is_valid_json;
		]]>
		</sql>

		<!-- Rolling back is not useful -->
	</changeSet>

	<changeSet id="add-reportActions-planned" author="gjvoosten">
		<addColumn tableName="reportActions">
			<column name="planned" type="boolean" defaultValue="false">
				<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add-jobHistory-table" author="gjvoosten">
		<createTable tableName="jobHistory">
			<column name="jobName" type="nvarchar(100)">
				<constraints primaryKey="true" nullable="false"/>
			</column>
			<column name="lastRun" type="datetime">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="people-pendingVerification" author="VassilIordanov">
		<comment>We are going to use pendingVerification column instead of the NEW_USER value of the status column</comment>
		<sql dbms="mssql">
			UPDATE people SET "pendingVerification" = 0;
			UPDATE people SET status = 0, "pendingVerification" = 1 WHERE status = 2;
		</sql>
		<sql dbms="postgresql">
			UPDATE people SET "pendingVerification" = false;
			UPDATE people SET status = 0, "pendingVerification" = true WHERE status = 2;
		</sql>
	</changeSet>

	<changeSet id="set-read_committed_snapshot-on" author="gjvoosten" runInTransaction="false" runOnChange="true">
		<comment>Set READ_COMMITTED_SNAPSHOT to ON to prevent hangs due to locking</comment>
		<!-- Requires at least SQL Server 2012: -->
		<sql dbms="mssql">
                        ALTER DATABASE CURRENT SET READ_COMMITTED_SNAPSHOT ON WITH ROLLBACK IMMEDIATE;
		</sql>
	</changeSet>

	<changeSet id="change-periodStart-format" author="gjvoosten">
		<comment>Convert zone-specific timestamp to zone-agnostic date in yyyy-MM-dd format</comment>
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			UPDATE notes
			SET text = JSON_MODIFY(text, '$.__periodStart', FORMAT(CONVERT(datetime, JSON_VALUE(text, 'lax $.__periodStart'), 127) + 0.5, 'yyyy-MM-dd'))
			WHERE type = 3
			AND ISJSON(text) = 1
			AND JSON_VALUE(text, 'lax $.__periodStart') IS NOT NULL;
		</sql>
	</changeSet>
	<changeSet id="fix-semiannually-typo" author="gjvoosten">
		<comment>Fix typo in 'semiannually'</comment>
		<!-- Note: the demo data has at most 3 assessment definitions for any one task
		     and field installations have at most 2, so only update the first 3. -->

		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			UPDATE notes
			SET text = JSON_MODIFY(text, '$.__recurrence', 'semiannually')
			WHERE type = 3
			AND ISJSON(text) = 1
			AND JSON_VALUE(text, 'lax $.__recurrence') = 'semiannualy';

			UPDATE tasks
			SET "customFields" = JSON_MODIFY("customFields", '$.assessments[0].recurrence', 'semiannually')
			WHERE ISJSON("customFields") = 1
			AND JSON_VALUE("customFields", 'lax $.assessments[0].recurrence') = 'semiannualy';

			UPDATE tasks
			SET "customFields" = JSON_MODIFY("customFields", '$.assessments[1].recurrence', 'semiannually')
			WHERE ISJSON("customFields") = 1
			AND JSON_VALUE("customFields", 'lax $.assessments[1].recurrence') = 'semiannualy';

			UPDATE tasks
			SET "customFields" = JSON_MODIFY("customFields", '$.assessments[2].recurrence', 'semiannually')
			WHERE ISJSON("customFields") = 1
			AND JSON_VALUE("customFields", 'lax $.assessments[2].recurrence') = 'semiannualy';
		</sql>
	</changeSet>

	<changeSet id="add-reportPeople-attendee" author="gjvoosten">
		<addColumn tableName="reportPeople">
			<column name="isAttendee" type="boolean" defaultValue="true" />
		</addColumn>
		<!-- Set isAttendee flag to true for all previously written reports -->
		<sql dbms="postgresql">
			UPDATE "reportPeople"
			SET "isAttendee" = TRUE;
		</sql>
		<sql dbms="mssql">
			UPDATE "reportPeople"
			SET "isAttendee" = 1;
		</sql>
	</changeSet>

	<changeSet id="add-reportPeople-author" author="cemalettin-simsoft">
		<!-- Before, we saved report's author with reports.authorUuid -->
		<!-- since we need more authors we will save it with a flag in reportPeople.isAuthor -->
		<addColumn tableName="reportPeople">
			<column name="isAuthor" type="boolean" defaultValue="false" />
		</addColumn>
		<!-- Insert reportPeople rows for authors who were not attendees -->
		<sql dbms="postgresql">
			INSERT INTO "reportPeople" ("reportUuid", "personUuid", "isPrimary", "isAuthor", "isAttendee")
				SELECT
					r.uuid,
					r."authorUuid",
					FALSE,
					TRUE,
					FALSE
				FROM
					reports r
				WHERE NOT EXISTS (
					SELECT rp."reportUuid"
					FROM "reportPeople" rp
					WHERE rp."reportUuid" = r.uuid
					AND rp."personUuid" = r."authorUuid"
				);
		</sql>
		<sql dbms="mssql">
			INSERT INTO "reportPeople" ("reportUuid", "personUuid", "isPrimary", "isAuthor", "isAttendee")
				SELECT
					r.uuid,
					r."authorUuid",
					0,
					1,
					0
				FROM
					reports r
				WHERE NOT EXISTS (
					SELECT rp."reportUuid"
					FROM "reportPeople" rp
					WHERE rp."reportUuid" = r.uuid
					AND rp."personUuid" = r."authorUuid"
				);
		</sql>
		<!-- Set isAuthor flag to true for all authors of previously written reports -->
		<sql dbms="postgresql">
			UPDATE "reportPeople"
			SET "isAuthor" = TRUE
			WHERE "personUuid" = (SELECT "authorUuid" FROM reports WHERE uuid = "reportUuid");
		</sql>
		<sql dbms="mssql">
			UPDATE "reportPeople"
			SET "isAuthor" = 1
			WHERE "personUuid" = (SELECT "authorUuid" FROM reports WHERE uuid = "reportUuid");
		</sql>
		<!-- Now drop the obsolete authorUuid column -->
		<dropIndex tableName="reports" indexName="IDX_reports_authorUuid" />
		<dropForeignKeyConstraint baseTableName="reports" constraintName="FK_reports_author" />
		<dropColumn tableName="reports" columnName="authorUuid" />
	</changeSet>

	<changeSet id="add-custom-fields-to-positions" author="cemalettin-simsoft">
		<addColumn tableName="positions">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>
	<changeSet id="add-custom-fields-to-organizations" author="cemalettin-simsoft">
		<addColumn tableName="organizations">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>
	<changeSet id="add-custom-fields-to-locations" author="cemalettin-simsoft">
		<addColumn tableName="locations">
			<column name="customFields" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="set-planned-reportActions" author="gjvoosten">
		<!-- any report action linked to a planning step is itself planned -->
		<sql dbms="postgresql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = true
			WHERE "approvalStepUuid" IN (
				SELECT uuid
				FROM "approvalSteps"
				WHERE type = 0
			)
			AND "createdAt" >= '2021-01-01';
		]]>
		</sql>
		<sql dbms="mssql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = 1
			WHERE "approvalStepUuid" IN (
				SELECT uuid
				FROM "approvalSteps"
				WHERE type = 0
			)
			AND "createdAt" >= '2021-01-01';
		]]>
		</sql>

		<!-- any report submit action directly followed by a planned action is itself planned -->
		<sql dbms="postgresql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = true
			WHERE "createdAt" IN (
				SELECT ra2."createdAt"
				FROM "reportActions" ra
				LEFT JOIN LATERAL (
					SELECT ra2.*
					FROM "reportActions" ra2
					WHERE ra2."reportUuid" = ra."reportUuid"
					AND ra2."createdAt" < ra."createdAt"
					ORDER BY ra2."createdAt" DESC
					LIMIT 1
				) ra2 ON TRUE
				WHERE ra2.type = 2
				AND ra.planned = true
			)
			AND "createdAt" >= '2021-01-01';
		]]>
		</sql>
		<sql dbms="mssql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = 1
			WHERE "createdAt" IN (
				SELECT ra2."createdAt"
				FROM "reportActions" ra
				OUTER APPLY (
					SELECT TOP(1) ra2.*
					FROM "reportActions" ra2
					WHERE ra2."reportUuid" = ra."reportUuid"
					AND ra2."createdAt" < ra."createdAt"
					ORDER BY ra2."createdAt" DESC
				) ra2
				WHERE ra2.type = 2
				AND ra.planned = 1
			)
			AND "createdAt" >= '2021-01-01';
		]]>
		</sql>

		<!-- any report publish action directly preceded by a planned action is itself planned -->
		<sql dbms="postgresql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = true
			WHERE "createdAt" IN (
				SELECT ra2."createdAt"
				FROM "reportActions" ra
				LEFT JOIN LATERAL (
					SELECT ra2.*
					FROM "reportActions" ra2
					WHERE ra2."reportUuid" = ra."reportUuid"
					AND ra2."createdAt" > ra."createdAt"
					ORDER BY ra2."createdAt"
					LIMIT 1
				) ra2 ON TRUE
				WHERE ra2.type = 3
				AND ra.planned = true
			);
		]]>
		</sql>
		<sql dbms="mssql">
		<![CDATA[
			UPDATE "reportActions"
			SET planned = 1
			WHERE "createdAt" IN (
				SELECT ra2."createdAt"
				FROM "reportActions" ra
				OUTER APPLY (
					SELECT TOP(1) ra2.*
					FROM "reportActions" ra2
					WHERE ra2."reportUuid" = ra."reportUuid"
					AND ra2."createdAt" > ra."createdAt"
					ORDER BY ra2."createdAt"
				) ra2
				WHERE ra2.type = 3
				AND ra.planned = 1
			)
			AND "createdAt" >= '2021-01-01';
		]]>
		</sql>
	</changeSet>

	<changeSet id="alter-changeset-29-for-postgresql" author="gjvoosten" dbms="postgresql" runInTransaction="false" >
		<sql>
			<!-- Drop full-text materialized views (incl. indexes);
                             copied from changeset alter-postgresql-fulltext -->
			DROP MATERIALIZED VIEW mv_fts_locations;
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions; -- depends on organizations.full_text
			DROP MATERIALIZED VIEW mv_fts_tasks;

			<!-- Drop generated full-text columns;
                             copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE locations DROP COLUMN full_text;
			ALTER TABLE organizations DROP COLUMN full_text;
			ALTER TABLE people DROP COLUMN full_text;
			ALTER TABLE tasks DROP COLUMN full_text;

                        <!-- Make column lengths consistent with mssql (see changeset 29) -->
			ALTER TABLE locations ALTER COLUMN name TYPE varchar(512); -- was varchar(500)
			ALTER TABLE organizations ALTER COLUMN "longName" TYPE varchar(255); -- was text
			ALTER TABLE people ALTER COLUMN "domainUsername" TYPE varchar(512); -- was varchar(500)
			ALTER TABLE tasks ALTER COLUMN "shortName" TYPE varchar(255); -- was varchar(100)
			ALTER TABLE tasks ALTER COLUMN "longName" TYPE text; -- was varchar(255)

			<!-- Re-add generated full-text columns;
			     use 'anet' config only for columns containing English text,
			     use 'simple' config for all columns;
                             copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
						  || to_tsvector('simple', coalesce(locations.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
						  || to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."emailAddress", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
						  || to_tsvector('simple', coalesce(people.biography, '')), ${fts_low})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
						  || to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Re-create full-text materialized views and indexes;
                             copied from changeset alter-postgresql-fulltext -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
				SELECT
					tasks.uuid,
					tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM tasks
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
					AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

	<changeSet id="convert-tags-to-notes" author="VassilIordanov">
		<sql>
			INSERT INTO PEOPLE (uuid, name, status, role, "createdAt", "updatedAt")
				SELECT ${uuid_function}, 'ANET Importer', 1, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
				WHERE NOT EXISTS (SELECT uuid FROM people WHERE name = 'ANET Importer' AND role = 0);

                        -- Create one note for each tag;
                        -- since notes are only editable by their author (the ANET Importer in this case) or admin,
                        -- this is safe
			INSERT INTO notes (uuid, "authorUuid", type, text, "createdAt", "updatedAt")
				SELECT
					t.uuid,
					(SELECT uuid FROM people WHERE name = 'ANET Importer' AND role = 0),
					0,
					CONCAT('Previously tagged as ', t.name, ' - ',  t.description),
					t."createdAt",
					t."updatedAt"
				FROM
					tags t;

                        -- Link reports to the note containing their former tag
			INSERT INTO "noteRelatedObjects" ("noteUuid", "relatedObjectType", "relatedObjectUuid")
				SELECT
					rt."tagUuid",
					'reports',
					rt."reportUuid"
				FROM
					"reportTags" rt;
		</sql>
		<sql dbms="postgresql">
			DROP MATERIALIZED VIEW mv_fts_tags;
		</sql>
		<dropForeignKeyConstraint baseTableName="reportTags" constraintName="FK_reportTags_report" />
		<dropForeignKeyConstraint baseTableName="reportTags" constraintName="FK_reportTags_tag" />
		<dropTable tableName="reportTags" />
		<dropTable tableName="tags" />
		<!-- Remove tags from saved searches -->
		<!-- Requires at least SQL Server 2016: -->
		<sql dbms="mssql">
			-- Remove JSON field for the tagUuid
			UPDATE savedSearches SET query=JSON_MODIFY(query, '$.tagUuid', NULL);
		</sql>
		<!-- Requires at least PostgreSQL 9.5: -->
		<sql dbms="postgresql">
			-- Remove JSON field for the tagUuid
			UPDATE "savedSearches" SET query=query::jsonb #- '{tagUuid}';
		</sql>
	</changeSet>

	<changeSet id="delete-null-peoplePositions" author="gjvoosten">
		<sql>
			DELETE FROM "peoplePositions"
			WHERE "positionUuid" IS NULL
			AND "personUuid" IS NULL;
		</sql>
	</changeSet>

	<changeSet id="add-customSensitiveInformation-table" author="gjvoosten">
		<createTable tableName="customSensitiveInformation">
			<column name="uuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="customFieldName" type="${long_text_type}">
				<constraints nullable="false" />
			</column>
			<column name="customFieldValue" type="${long_text_type}" />
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>
	</changeSet>

	<changeSet id="add-type-to-location" author="bssimsoft">
		<addColumn tableName="locations">
			<column name="type" type="varchar(64)" />
		</addColumn>
	</changeSet>

	<changeSet id="update-locations-type" author="bssimsoft">
		<sql>
			-- Set type to PPA for locations linked with advisor positions
			UPDATE locations
			SET type = 'PPA'
			WHERE type IS NULL
			AND uuid IN (SELECT DISTINCT(p."locationUuid") FROM positions p WHERE p.type = 0);

			-- Set type to PPP for locations linked with principal positions
			UPDATE locations
			SET type = 'PPP'
			WHERE type IS NULL
			AND uuid IN (SELECT DISTINCT(p."locationUuid") FROM positions p WHERE p.type = 1);

			-- Set type to PA for locations that have both 'District' and 'Province' in their name
			UPDATE locations
			SET type = 'PA'
			WHERE type IS NULL
			AND name LIKE '%District%' AND name LIKE '%Province%';

			-- Set type to V for locations without coordinates
			UPDATE locations
			SET type = 'V'
			WHERE type IS NULL
			AND lat IS NULL AND lng IS NULL;

			-- Set all remaining locations to type PP
			UPDATE locations
			SET type = 'PP'
			WHERE type IS NULL;
		</sql>
	</changeSet>

	<changeSet id="set-locations-type-notnull-constraint" author="gjvoosten">
		<addNotNullConstraint
			columnDataType="varchar(64)"
			columnName="type"
			tableName="locations" />
	</changeSet>

	<changeSet id="add_subscriptions" author="gjvoosten">
		<createTable tableName="subscriptions">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="subscriberUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="subscribedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="subscribedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="subscriptions" constraintName="FK_subscriptions_subscriber" baseColumnNames="subscriberUuid"
			referencedTableName="positions" referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION" />
	</changeSet>

	<changeSet id="add-subscriptions-unique-constraints" author="gjvoosten" dbms="mssql,postgresql">
		<addUniqueConstraint
			tableName="subscriptions" constraintName="UQ_SubscriptionSubScriberSubscribedObject" columnNames="subscriberUuid, subscribedObjectType, subscribedObjectUuid" />
	</changeSet>

	<changeSet id="add_subscription_updates" author="gjvoosten">
		<createTable tableName="subscriptionUpdates">
			<column name="subscriptionUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="updatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="updatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="isNote" type="boolean" defaultValue="false" />
			<column name="createdAt" type="datetime" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="subscriptionUpdates" constraintName="FK_subscriptionUpdates_subscription" baseColumnNames="subscriptionUuid"
			referencedTableName="subscriptions" referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION" />
	</changeSet>

	<changeSet id="add-people-openIdSubject" author="gjvoosten">
		<!-- Store the Subject returned by the OpenID Provider (Keycloak); from the OIDC spec:
                     "It MUST NOT exceed 255 ASCII characters in length." -->
		<addColumn tableName="people">
			<column name="openIdSubject" type="nvarchar(255)" />
		</addColumn>
		<!-- Add some indexes to speed up queries used during authentication -->
		<createIndex
			tableName="people" indexName="IDX_people_openIdSubject">
			<column name="openIdSubject" />
		</createIndex>
		<createIndex
			tableName="people" indexName="IDX_people_domainUsername">
			<column name="domainUsername" />
		</createIndex>
		<createIndex
			tableName="people" indexName="IDX_people_emailAddress">
			<column name="emailAddress" />
		</createIndex>
	</changeSet>

	<!-- From this point on, mssql is no longer supported, so only postgresql migrations are needed -->

	<changeSet id="add-assessmentKey-to-notes" author="gjvoosten">
		<addColumn tableName="notes">
			<column name="assessmentKey" type="varchar(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="add-userActivities-table" author="gjvoosten">
		<createTable tableName="userActivities">
			<!-- Note: personUuid and organizationUuid are *not* a foreign key so they can still be deleted without deleting the activities -->
			<column name="personUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="organizationUuid" type="${uuid_type}">
				<constraints />
			</column>
			<column name="visitedAt" type="datetime">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			tableName="userActivities"
			columnNames="personUuid, organizationUuid, visitedAt"
			constraintName="uniqueUserActivities" />
	</changeSet>

	<changeSet id="delete-obsolete-peoplePositions" author="gjvoosten">
		<!-- Rows with either a NULL positionUuid or a NULL personUuid are no longer needed -->
		<sql>
			DELETE FROM "peoplePositions"
			WHERE "positionUuid" IS NULL
			OR "personUuid" IS NULL;
		</sql>
		<!-- Make sure rows with a NULL positionUuid or a NULL personUuid are no longer allowed -->
		<addNotNullConstraint tableName="peoplePositions" columnName="positionUuid" columnDataType="${uuid_type}" />
		<addNotNullConstraint tableName="peoplePositions" columnName="personUuid" columnDataType="${uuid_type}" />
	</changeSet>

	<changeSet id="add_organization_administrative_positions" author="nur.yilmaz">
		<createTable tableName="organizationAdministrativePositions">
			<column name="organizationUuid" type="${uuid_type}">
				<constraints nullable="false"/>
			</column>
			<column name="positionUuid" type="${uuid_type}">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addUniqueConstraint tableName="organizationAdministrativePositions" columnNames="organizationUuid, positionUuid" constraintName="UQ_uniqueOrganizationAdministrativePositions" />
		<addForeignKeyConstraint baseColumnNames="organizationUuid" baseTableName="organizationAdministrativePositions"
								 constraintName="FK_organizationAdministrativePositions_organization" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="uuid" referencedTableName="organizations" />
		<addForeignKeyConstraint baseColumnNames="positionUuid" baseTableName="organizationAdministrativePositions"
								 constraintName="FK_organizationAdministrativePositions_position" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="uuid" referencedTableName="positions" />
		<createIndex
				indexName="IDX_organizationAdministrativePositions_organizationUuid" tableName="organizationAdministrativePositions">
			<column name="organizationUuid"/>
		</createIndex>
		<createIndex
				indexName="IDX_organizationAdministrativePositions_positionUuid" tableName="organizationAdministrativePositions">
			<column name="positionUuid"/>
		</createIndex>
	</changeSet>

	<changeSet id="update-adminSettings" author="gjvoosten">
		<!-- update text setting to classification -->
		<update tableName="adminSettings">
			<column name="key" value="SECURITY_BANNER_CLASSIFICATION" />
			<where>key = 'SECURITY_BANNER_TEXT'</where>
		</update>
		<!-- add new releasability setting with an empty value -->
		<insert tableName="adminSettings">
			<column name="key" value="SECURITY_BANNER_RELEASABILITY" />
			<column name="value" value="" />
		</insert>
	</changeSet>

	<changeSet id="add-locationUuid-to-organizations" author="hyesilAnka">
		<addColumn tableName="organizations">
			<column name="locationUuid" type="${uuid_type}" />
		</addColumn>
		<createIndex
				tableName="organizations" indexName="IDX_organizations_locationUuid">
			<column name="locationUuid" />
		</createIndex>
		<addForeignKeyConstraint
				baseTableName="organizations" constraintName="FK_organizations_location" baseColumnNames="locationUuid"
				referencedTableName="locations" referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION" />
	</changeSet>

	<changeSet id="add-profile-to-organizations" author="cigdem.ersepciler">
		<!-- add profile field to organizations -->
		<addColumn tableName="organizations">
			<column name="profile" type="text"/>
		</addColumn>
	</changeSet>

	<changeSet id="alter-full_text-index-add-organizations_profile" author="gjvoosten" dbms="postgresql" runInTransaction="false" >
		<sql>
			<!-- Drop full-text materialized views (incl. indexes);
			     copied from changeset alter-postgresql-fulltext -->
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions;

			<!-- Drop generated full-text column from organizations;
			     copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE organizations DROP COLUMN full_text;

			<!-- Re-add generated full-text column to organization, now including profile;
			     use 'anet' config only for columns containing English text,
			     use 'simple' config for all columns;
			     copied mostly from changeset alter-postgresql-fulltext -->
			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
						  || to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations.profile, ''))
						  || to_tsvector('simple', coalesce(organizations.profile, '')), ${fts_low})
				) STORED;

			<!-- Re-create full-text materialized views and indexes;
			     copied from changeset alter-postgresql-fulltext -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

	<changeSet id="remove_change_records" author="cigdemers">
		<sql>
			DELETE FROM "noteRelatedObjects" nro
			USING notes n
			WHERE n.uuid = nro."noteUuid"
			AND n.type = 1;

			DELETE FROM notes n
			WHERE n.type = 1;
		</sql>
	</changeSet>

	<changeSet id="remove_partner_assessment" author="cigdemers">
		<sql>
			DELETE
			FROM "noteRelatedObjects" nro
			USING notes n
			WHERE n.uuid = nro."noteUuid"
			AND n.type = 2;

			DELETE FROM notes n
			WHERE n.type = 2;
		</sql>
	</changeSet>

	<changeSet id="update-anet-links-in-rich-text" author="gjvoosten" dbms="postgresql">
		<sql>
		<![CDATA[
			UPDATE locations
			SET "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE notes
			SET text=REGEXP_REPLACE(text, '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE organizations
			SET profile=REGEXP_REPLACE(profile, '${oldAnetLink}', '${newAnetLink}', 'ig'),
			    "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE people
			SET biography=REGEXP_REPLACE(biography, '${oldAnetLink}', '${newAnetLink}', 'ig'),
			    "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE positions
			SET "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE reports
			SET text=REGEXP_REPLACE(text, '${oldAnetLink}', '${newAnetLink}', 'ig'),
			    "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE "reportsSensitiveInformation"
			SET text=REGEXP_REPLACE(text, '${oldAnetLink}', '${newAnetLink}', 'ig');
			UPDATE tasks
			SET "customFields"=REGEXP_REPLACE("customFields", '${oldAnetLink}', '${newAnetLink}', 'ig');
		]]>
		</sql>
	</changeSet>

	<changeSet id="rename-customFieldRef1Uuid-in-tasks" author="gjvoosten">
		<dropIndex tableName="tasks" indexName="IDX_tasks_customFieldRef1Uuid" />
		<dropForeignKeyConstraint baseTableName="tasks" constraintName="FK_tasks_customFieldRef1" />
		<renameColumn
				columnDataType="${uuid_type}"
				oldColumnName="customFieldRef1Uuid"
				newColumnName="parentTaskUuid"
				tableName="tasks" />
		<addForeignKeyConstraint baseColumnNames="parentTaskUuid" baseTableName="tasks"
								 constraintName="FK_tasks_parentTask" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="uuid" referencedTableName="tasks" />
		<createIndex indexName="IDX_tasks_parentTaskUuid" tableName="tasks">
			<column name="parentTaskUuid" />
		</createIndex>
	</changeSet>

	<changeSet id="drop-obsolete-custom-fields-from-tasks" author="gjvoosten">
		<dropColumn tableName="tasks" columnName="customField" />
		<dropColumn tableName="tasks" columnName="customFieldEnum1" />
		<dropColumn tableName="tasks" columnName="customFieldEnum2" />
	</changeSet>

	<changeSet id="add-description-field-to-locations" author="cigdemers">
		<!-- add description field to locations -->
		<addColumn tableName="locations">
			<column name="description" type="text"/>
		</addColumn>
	</changeSet>

	<changeSet id="alter-full_text-index-add-locations_description" author="cigdemers" runInTransaction="false">
		<sql>
			<!-- Drop full-text materialized view (incl. indexes);
                             copied from changeset alter-postgresql-fulltext -->
			DROP MATERIALIZED VIEW mv_fts_locations;

			<!-- Drop generated full-text column from locations;
			     copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE locations DROP COLUMN full_text;

			<!-- Re-add generated full-text column to locations, now including description;
			     copied mostly from changeset alter-postgresql-fulltext -->
			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
						  || to_tsvector('simple', coalesce(locations.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.description, ''))
					      || to_tsvector('simple', coalesce(locations.description, '')), ${fts_low})
				) STORED;

			<!-- Re-create full-text materialized views and indexes;
			     copied from changeset alter-postgresql-fulltext -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
				SELECT
					locations.uuid,
					locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
				FROM locations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
					AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

	<changeSet id="add-description-to-tasks" author="cigdemers">
		<!-- add description field to tasks -->
		<addColumn tableName="tasks">
			<column name="description" type="text"/>
		</addColumn>
	</changeSet>

	<changeSet id="alter-full_text-index-add-tasks_description" author="cigdemers" runInTransaction="false">
		<sql>
			<!-- Drop full-text materialized view (incl. indexes);
                             copied from changeset alter-postgresql-fulltext -->
			DROP MATERIALIZED VIEW mv_fts_tasks;

			<!-- Drop generated full-text column from tasks;
			     copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE tasks DROP COLUMN full_text;

			<!-- Re-add generated full-text column to tasks, now including description;
			     copied mostly from changeset alter-postgresql-fulltext -->
			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
						setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
						setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
							  || to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high}) ||
						setweight(to_tsvector(${fts_config}, coalesce(tasks.description, ''))
							  || to_tsvector('simple', coalesce(tasks.description, '')), ${fts_low})
					) STORED;

			<!-- Re-create full-text materialized views and indexes;
			     copied from changeset alter-postgresql-fulltext -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
			SELECT
				tasks.uuid,
				tasks.full_text
				|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
			FROM tasks
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
				AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY tasks.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

	<changeSet id="alter-unique-tasks_shortName-constraint" author="gjvoosten">
		<dropUniqueConstraint tableName="tasks" constraintName="UQ_TaskShortName" />
		<sql>
			CREATE UNIQUE INDEX "UQ_TaskShortNameParentTaskUuid"
			ON tasks ("shortName", "parentTaskUuid")
			WHERE "parentTaskUuid" IS NOT NULL;

			CREATE UNIQUE INDEX "UQ_TaskShortNameNoParentTask"
			ON tasks ("shortName")
			WHERE "parentTaskUuid" IS NULL;
		</sql>
	</changeSet>

	<changeSet id="add-role-to-positions" author="hyesilAnka" >
		<addColumn tableName="positions" >
			<column name="role" type="int" defaultValue="0" >
				<constraints nullable="false"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="add-attachments-table" author="cigdemers">
		<createTable tableName="attachments">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="authorUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="fileName" type="${long_text_type}" />
			<column name="mimeType" type="${long_text_type}" />
			<column name="content" type="oid" />
			<column name="contentLength" type="bigint" />
			<column name="description" type="${long_text_type}" />
			<column name="classification" type="${long_text_type}" />
			<column name="createdAt" type="datetime" />
			<column name="updatedAt" type="datetime" />
		</createTable>

		<createIndex
			indexName="IDX_attachments_authorUuid" tableName="attachments">
			<column name="authorUuid"/>
		</createIndex>

		<addForeignKeyConstraint
			baseTableName="attachments" constraintName="FK_attachments_author" baseColumnNames="authorUuid"
			referencedTableName="people" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

		<createTable tableName="attachmentRelatedObjects">
			<column name="attachmentUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint
			baseTableName="attachmentRelatedObjects" constraintName="FK_attachmentRelatedObjects_attachment" baseColumnNames="attachmentUuid"
			referencedTableName="attachments" referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />

	</changeSet>

	<changeSet id="add-caption-column-to-attachments" author="mesut-simsoft" >
		<addColumn tableName="attachments" >
			<column name="caption" type="varchar(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="add-authorizationGroupRelatedObjects" author="gjvoosten">
		<createTable tableName="authorizationGroupRelatedObjects">
			<column name="authorizationGroupUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint
				baseTableName="authorizationGroupRelatedObjects"
				constraintName="FK_authorizationGroupRelatedObjects_authorizationGroup"
				baseColumnNames="authorizationGroupUuid"
				referencedTableName="authorizationGroups"
				referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION" />

		<!-- Migrate existing authorizationGroupPositions -->
		<sql>
			INSERT INTO "authorizationGroupRelatedObjects" ("authorizationGroupUuid", "relatedObjectType", "relatedObjectUuid")
			SELECT
				agp."authorizationGroupUuid",
				'positions',
				agp."positionUuid"
			FROM
				"authorizationGroupPositions" agp;
		</sql>

		<!-- Now drop authorizationGroupPositions -->
		<dropTable tableName="authorizationGroupPositions" />
	</changeSet>

	<changeSet id="migrate-people-avatar-to-attachment" author="gjvoosten">
		<sql>
			INSERT INTO attachments
					(uuid, "authorUuid", "fileName", "mimeType", content, "contentLength",
					description, classification, caption, "createdAt", "updatedAt")
				SELECT ${uuid_function}, uuid, 'avatar-' || uuid || '.png', 'image/png', lo_from_bytea(0, avatar), length(avatar),
					'Automatically migrated avatar of ' || name, NULL, name, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
				FROM people
				WHERE avatar IS NOT NULL;
			UPDATE people SET avatar = NULL;
			INSERT INTO "attachmentRelatedObjects" ("attachmentUuid", "relatedObjectType", "relatedObjectUuid")
				SELECT uuid, 'people', attachments."authorUuid"
				FROM attachments
				WHERE attachments."fileName" = 'avatar-' || attachments."authorUuid" || '.png';
		</sql>
		<dropColumn tableName="people" columnName="avatar" />
		<addColumn tableName="people">
			<column name="avatarUuid" type="${uuid_type}" />
		</addColumn>
		<addForeignKeyConstraint
			baseTableName="people"
			baseColumnNames="avatarUuid"
			constraintName="FK_people_attachment"
			referencedTableName="attachments"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION" />
		<sql>
			UPDATE people SET "avatarUuid" = (
				SELECT uuid
				FROM attachments
				WHERE people.uuid = attachments."authorUuid" AND attachments."fileName" = 'avatar-' || attachments."authorUuid" || '.png'
			);
		</sql>
	</changeSet>

	<changeSet id="add-unique-taskResponsiblePositions-constraint" author="gjvoosten">
		<addUniqueConstraint tableName="taskResponsiblePositions"
							 columnNames="taskUuid, positionUuid"
							 constraintName="UQ_TaskResponsiblePositions" />
	</changeSet>

	<changeSet id="add-unique-authorizationGroupRelatedObjects-constraint" author="gjvoosten">
		<addUniqueConstraint tableName="authorizationGroupRelatedObjects"
							 columnNames="authorizationGroupUuid, relatedObjectType, relatedObjectUuid"
							 constraintName="UQ_AuthorizationGroupRelatedObjects" />
	</changeSet>

	<changeSet id="add-unique-attachmentRelatedObjects-constraint" author="gjvoosten">
		<addUniqueConstraint tableName="attachmentRelatedObjects"
							 columnNames="attachmentUuid, relatedObjectType, relatedObjectUuid"
							 constraintName="UQ_AttachmentRelatedObjects" />
	</changeSet>

	<changeSet id="drop-advisor-principal-distinction" author="gjvoosten">
		<!-- add user field to people -->
		<addColumn tableName="people">
			<column name="user" type="boolean" defaultValue="false" />
		</addColumn>
		<!-- add isInterlocutor field to reportPeople -->
		<addColumn tableName="reportPeople">
			<column name="isInterlocutor" type="boolean" defaultValue="true" />
		</addColumn>

		<!-- update some types and assessment keys, set the user status of people,
		     and infer the interlocutor status of attendees -->
		<sql>
			UPDATE positions SET type = 0
				WHERE type = 1;
			UPDATE locations SET type = 'PP'
				WHERE type IN ('PPA', 'PPP');
			UPDATE notes SET "assessmentKey" = replace("assessmentKey", 'fields.principal', 'fields.regular')
				WHERE "assessmentKey" LIKE 'fields.principal%';
			UPDATE notes SET "assessmentKey" = replace("assessmentKey", 'principal', 'interlocutor')
				WHERE "assessmentKey" LIKE '%principal%';
			UPDATE "people" SET "user" = true
				WHERE role = 0
				AND (
					("openIdSubject" IS NOT NULL AND "openIdSubject" != '')
					OR ("domainUsername" IS NOT NULL AND "domainUsername" != '')
				);
			UPDATE "reportPeople" SET "isInterlocutor" = false
				WHERE "personUuid" in (SELECT uuid FROM people WHERE role = 0);
		</sql>

		<!-- drop obsolete columns -->
		<dropColumn tableName="organizations" columnName="type" />
		<dropColumn tableName="people" columnName="role" />

		<!-- rename principalOrg column -->
		<dropIndex tableName="reports" indexName="IDX_reports_principalOrganizationUuid" />
		<dropForeignKeyConstraint
			baseTableName="reports" constraintName="FK_reports_principalOrg" />
		<renameColumn
			columnDataType="${uuid_type}"
			oldColumnName="principalOrganizationUuid"
			newColumnName="interlocutorOrganizationUuid"
			tableName="reports" />
		<addForeignKeyConstraint baseColumnNames="interlocutorOrganizationUuid" baseTableName="reports"
			constraintName="FK_reports_interlocutorOrg" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="organizations" />
		<createIndex
			indexName="IDX_reports_interlocutorOrganizationUuid" tableName="reports">
			<column name="interlocutorOrganizationUuid"/>
		</createIndex>
	</changeSet>

	<changeSet id="add_authorizationGroup_administrative_positions" author="gjvoosten">
		<createTable tableName="authorizationGroupAdministrativePositions">
			<column name="authorizationGroupUuid" type="${uuid_type}">
				<constraints nullable="false"/>
			</column>
			<column name="positionUuid" type="${uuid_type}">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addUniqueConstraint
			tableName="authorizationGroupAdministrativePositions"
			columnNames="authorizationGroupUuid, positionUuid"
			constraintName="UQ_uniqueAuthorizationGroupAdministrativePositions"
		/>
		<addForeignKeyConstraint
			baseColumnNames="authorizationGroupUuid"
			baseTableName="authorizationGroupAdministrativePositions"
			constraintName="FK_authorizationGroupAdministrativePositions_authorizationGroup"
			referencedColumnNames="uuid"
			referencedTableName="authorizationGroups"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_authorizationGroupAdministrativePositions_position"
			baseColumnNames="positionUuid"
			baseTableName="authorizationGroupAdministrativePositions"
			referencedColumnNames="uuid"
			referencedTableName="positions"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<createIndex
			indexName="IDX_authorizationGroupAdministrativePositions_authorizationGroupUuid"
			tableName="authorizationGroupAdministrativePositions"
		>
			<column name="authorizationGroupUuid"/>
		</createIndex>
		<createIndex
			indexName="IDX_authorizationGroupAdministrativePositions_positionUuid"
			tableName="authorizationGroupAdministrativePositions"
		>
			<column name="positionUuid"/>
		</createIndex>
	</changeSet>

	<changeSet id="add_classification_to_reports" author="Chessray">
		<addColumn tableName="reports">
			<column name="classification" type="${long_text_type}" />
		</addColumn>
	</changeSet>

	<changeSet id="add-emailAddresses" author="gjvoosten">
		<createTable tableName="emailAddresses">
			<column name="network" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="address" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- Related objects can have at most one email address per network -->
		<addUniqueConstraint
			tableName="emailAddresses"
			columnNames="network, relatedObjectType, relatedObjectUuid"
			constraintName="UQ_EmailAddressNetworkRelatedObject"
		/>
	</changeSet>

	<changeSet id="alter-full_text-index-add-email_addresses" author="gjvoosten" runInTransaction="false" >
		<sql>
			<!-- Add generated full-text column to emailAddresses;
			     use 'simple' config for address column -->
			ALTER TABLE "emailAddresses"
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce("emailAddresses".address, '')), ${fts_low})
					|| setweight(to_tsvector('simple', translate(coalesce("emailAddresses".address, ''), '@', ' ')), ${fts_lower})
					|| setweight(to_tsvector('simple', translate(coalesce("emailAddresses".address, ''), '@.', '  ')), ${fts_lowest})
				) STORED;

			<!-- Drop full-text materialized views (incl. indexes);
			     copied from changeset alter-postgresql-fulltext -->
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions;

			<!-- Drop generated full-text column;
			     copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE people DROP COLUMN full_text;

			<!-- Re-add generated full-text column;
			     use 'anet' config only for columns containing English text,
			     use 'simple' config for all columns;
			     copied from changeset alter-postgresql-fulltext -->
			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
						  || to_tsvector('simple', coalesce(people.biography, '')), ${fts_low})
				) STORED;

			<!-- Re-create full-text materialized views and indexes;
			     add the emailAddresses, otherwise mostly
			     copied from changeset alter-postgresql-fulltext -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
				SELECT
					organizations.uuid,
					organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
				FROM organizations
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
					AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'organizations'
					AND "emailAddresses"."relatedObjectUuid" = organizations.uuid
				GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
				SELECT
					people.uuid,
					people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
				FROM people
				LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
					AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'people'
					AND "emailAddresses"."relatedObjectUuid" = people.uuid
				GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
				SELECT
					positions.uuid,
					positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
				FROM positions
				LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
				LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
				LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
					AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
				LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
				LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'positions'
					AND "emailAddresses"."relatedObjectUuid" = positions.uuid
				GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

	<changeSet id="drop-people-emailAddress" author="gjvoosten">
		<!-- Migrate existing people.emailAddress -->
		<sql>
			INSERT INTO "emailAddresses" ("network", "address", "relatedObjectType", "relatedObjectUuid")
			SELECT
				CASE WHEN p.user IS TRUE THEN 'NS' ELSE 'Internet' END,
				p."emailAddress",
				'people',
				p."uuid"
			FROM
				people p
			WHERE
				p."emailAddress" IS NOT NULL;
		</sql>

		<!-- Now drop people.emailAddress -->
		<dropColumn tableName="people" columnName="emailAddress" />
	</changeSet>

	<changeSet id="add-customFields-to-fulltext-index" author="chessray" runInTransaction="false">
		<sql>
			<!-- Drop full-text materialized views (incl. indexes) since we cannot just ALTER them;
			     copied from multiple changesets -->
			DROP MATERIALIZED VIEW mv_fts_locations;
			DROP MATERIALIZED VIEW mv_fts_organizations;
			DROP MATERIALIZED VIEW mv_fts_people;
			DROP MATERIALIZED VIEW mv_fts_positions;
			DROP MATERIALIZED VIEW mv_fts_reports;
			DROP MATERIALIZED VIEW mv_fts_tasks;

			<!-- Drop generated full-text columns;
			     copied from multiple changesets -->
			ALTER TABLE locations DROP COLUMN full_text;
			ALTER TABLE organizations DROP COLUMN full_text;
			ALTER TABLE people DROP COLUMN full_text;
			ALTER TABLE positions DROP COLUMN full_text;
			ALTER TABLE reports DROP COLUMN full_text;
			ALTER TABLE tasks DROP COLUMN full_text;

			<!-- Define functions for aggregating JSON values recursively, to be used in the full-text index -->
			CREATE OR REPLACE FUNCTION jsonb_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN CASE
					WHEN jsonb_typeof(p_json) = ''array'' THEN public.jsonb_array_value_agg(p_json, ignore_key)
					WHEN jsonb_typeof(p_json) = ''object'' THEN public.jsonb_object_value_agg(p_json, ignore_key)
					WHEN jsonb_typeof(p_json) = ''string''
						AND p_json #>> ''{}'' !~ ''^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{1,3}Z$''
						THEN coalesce(p_json #>> ''{}'', '''')
					ELSE ''''
				END;
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION jsonb_array_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN string_agg(public.jsonb_value_agg(value, ignore_key), '' '')
				FROM jsonb_array_elements(p_json);
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION jsonb_object_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN string_agg(public.jsonb_value_agg(value, ignore_key), '' '')
				FROM jsonb_each(p_json)
				WHERE key != ignore_key;
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			<!-- Re-add generated full-text columns, with the customFields column included-->
			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
							|| to_tsvector('simple', coalesce(locations.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.description, ''))
							|| to_tsvector('simple', coalesce(locations.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(locations."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(locations."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
							|| to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations.profile, ''))
							|| to_tsvector('simple', coalesce(organizations.profile, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(organizations."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(organizations."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE people
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
							|| to_tsvector('simple', coalesce(people.biography, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(people."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(people."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(positions.code, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, ''))
							|| to_tsvector('simple', coalesce(positions.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(positions."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(positions."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, ''))
							|| to_tsvector('simple', coalesce(reports.intent, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", ''))
							|| to_tsvector('simple', coalesce(reports."keyOutcomes", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", ''))
							|| to_tsvector('simple', coalesce(reports."nextSteps", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports.text, ''))
							|| to_tsvector('simple', coalesce(reports.text, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(reports."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(reports."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
							|| to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks.description, ''))
							|| to_tsvector('simple', coalesce(tasks.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(tasks."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(tasks."customFields"::jsonb)), ${fts_lower})
				) STORED;

			<!-- Re-create full-text materialized views and indexes;
			     copied from the last changeset where the respective view was created before -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
			SELECT
				locations.uuid,
				locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
			FROM locations
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
				AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
			SELECT
				organizations.uuid,
				organizations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
			FROM organizations
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
				AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
					LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'organizations'
				AND "emailAddresses"."relatedObjectUuid" = organizations.uuid
			GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
			SELECT
				people.uuid,
				people.full_text
					|| coalesce(tsvector_agg(positions.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
			FROM people
					LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
					LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
				AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
					LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'people'
				AND "emailAddresses"."relatedObjectUuid" = people.uuid
			GROUP BY people.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
			SELECT
				positions.uuid,
				positions.full_text
					|| coalesce(tsvector_agg(people.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.full_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".full_text), ''::tsvector)
			FROM positions
					LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
					LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
				AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
					LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'positions'
				AND "emailAddresses"."relatedObjectUuid" = positions.uuid
			GROUP BY positions.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
			SELECT
				reports.uuid,
				reports.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
			FROM reports
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
				AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY reports.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
			SELECT
				tasks.uuid,
				tasks.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
			FROM tasks
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
				AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY tasks.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="add_unlimited_exports_authorization_group_to_admin_settings" author="pacodelcastillolopez">
		<!-- add new unlimited exports authorization group with an empty value -->
		<insert tableName="adminSettings">
			<column name="key" value="UNLIMITED_EXPORTS_AUTHORIZATION_GROUP" />
		</insert>
	</changeSet>

	<changeSet id="add-app6-fields-to-organizations" author="gjvoosten">
		<addColumn tableName="organizations">
			<column name="app6context" type="varchar(255)" />
			<column name="app6standardIdentity" type="varchar(255)" />
			<column name="app6symbolSet" type="varchar(255)" />
			<column name="app6hq" type="varchar(255)" />
			<column name="app6amplifier" type="varchar(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="fill-app6-fields-for-organizations" author="gjvoosten">
		<sql>
			WITH
			RECURSIVE parent_orgs(uuid, parent_uuid) AS (
				SELECT
					uuid,
					uuid AS parent_uuid
				FROM organizations
				UNION ALL
				SELECT
					pt.uuid,
					bt."parentOrgUuid"
				FROM organizations bt
				INNER JOIN parent_orgs pt ON bt.uuid = pt.parent_uuid
			),
			tlp AS (
				SELECT DISTINCT
					por.uuid,
					por.parent_uuid
				FROM parent_orgs por
				LEFT JOIN organizations org ON org.uuid = por.parent_uuid
				WHERE por.parent_uuid IS NOT NULL
				AND org."parentOrgUuid" IS NULL
			),
			chu AS (
				SELECT DISTINCT
					org.uuid,
					BOOL_OR(peo."user") AS "user"
				FROM organizations org
				LEFT JOIN parent_orgs por ON por.parent_uuid = org.uuid
				LEFT JOIN positions pos ON pos."organizationUuid" = por.uuid
				LEFT JOIN people peo ON peo.uuid = pos."currentPersonUuid"
				GROUP BY org.uuid
			)
			UPDATE organizations
			SET
				"app6context" = sq."app6context",
				"app6standardIdentity" = sq."app6standardIdentity",
				"app6symbolSet" = sq."app6symbolSet"
			FROM (
				SELECT DISTINCT
					org.uuid,
					CASE
						WHEN org."parentOrgUuid" IS NULL THEN '0'
					END AS "app6context",
					CASE
						WHEN org."parentOrgUuid" IS NOT NULL THEN NULL
						WHEN chu."user" THEN '3'
					END AS "app6standardIdentity",
					CASE
						WHEN org."parentOrgUuid" IS NOT NULL THEN NULL
						WHEN chu."user" THEN '10'
					END AS "app6symbolSet"
				FROM organizations org
				LEFT JOIN positions pos ON pos."organizationUuid" = org.uuid
				LEFT JOIN tlp ON tlp.uuid = org.uuid
				LEFT JOIN chu ON chu.uuid = tlp.parent_uuid
			) sq
			WHERE organizations.uuid = sq.uuid;
		</sql>
		<rollback>
			<sql>
				UPDATE organizations
				SET
					"app6context" = NULL,
					"app6standardIdentity" = NULL,
					"app6symbolSet" = NULL
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-country-fields-to-locations" author="gjvoosten">
		<addColumn tableName="locations">
			<column name="digram" type="varchar(2)" />
			<column name="trigram" type="varchar(3)" />
		</addColumn>
	</changeSet>

	<changeSet id="insert-countries-into-locations" author="gjvoosten">
		<sql>
			INSERT INTO locations (uuid, type, status, name, digram, trigram) VALUES
				(${uuid_function}, 'PAC', 0, 'Afghanistan', 'AF', 'AFG'),
				(${uuid_function}, 'PAC', 0, 'Albania', 'AL', 'ALB'),
				(${uuid_function}, 'PAC', 0, 'Algeria', 'AG', 'DZA'),
				(${uuid_function}, 'PAC', 0, 'American Samoa', 'SS', 'ASM'),
				(${uuid_function}, 'PAC', 0, 'Andorra', 'AN', 'AND'),
				(${uuid_function}, 'PAC', 0, 'Angola', 'AO', 'AGO'),
				(${uuid_function}, 'PAC', 0, 'Anguilla', 'AV', 'AIA'),
				(${uuid_function}, 'PAC', 0, 'Antarctica', 'AY', 'ATA'),
				(${uuid_function}, 'PAC', 0, 'Antigua and Barbuda', 'AC', 'ATG'),
				(${uuid_function}, 'PAC', 0, 'Argentina', 'AR', 'ARG'),
				(${uuid_function}, 'PAC', 0, 'Armenia', 'AM', 'ARM'),
				(${uuid_function}, 'PAC', 0, 'Aruba', 'AA', 'ABW'),
				(${uuid_function}, 'PAC', 0, 'Ashmore and Cartier Islands', 'AT', 'ACI'),
				(${uuid_function}, 'PAC', 0, 'Australia', 'AS', 'AUS'),
				(${uuid_function}, 'PAC', 0, 'Austria', 'AU', 'AUT'),
				(${uuid_function}, 'PAC', 0, 'Azerbaijan', 'AJ', 'AZE'),
				(${uuid_function}, 'PAC', 0, 'Bahrain', 'BA', 'BHR'),
				(${uuid_function}, 'PAC', 0, 'Bangladesh', 'BD', 'BGD'),
				(${uuid_function}, 'PAC', 0, 'Barbados', 'BB', 'BRB'),
				(${uuid_function}, 'PAC', 0, 'Belarus', 'BO', 'BLR'),
				(${uuid_function}, 'PAC', 0, 'Belgium', 'BE', 'BEL'),
				(${uuid_function}, 'PAC', 0, 'Belize', 'BH', 'BLZ'),
				(${uuid_function}, 'PAC', 0, 'Benin', 'BN', 'BEN'),
				(${uuid_function}, 'PAC', 0, 'Bermuda', 'BM', 'BMU'),
				(${uuid_function}, 'PAC', 0, 'Bhutan', 'BT', 'BTN'),
				(${uuid_function}, 'PAC', 0, 'Bolivia', 'BL', 'BOL'),
				(${uuid_function}, 'PAC', 0, 'Bosnia-Herzegovina', 'BK', 'BIH'),
				(${uuid_function}, 'PAC', 0, 'Botswana', 'BC', 'BWA'),
				(${uuid_function}, 'PAC', 0, 'Bouvet Island', 'BV', 'BVT'),
				(${uuid_function}, 'PAC', 0, 'Brazil', 'BR', 'BRA'),
				(${uuid_function}, 'PAC', 0, 'British Indian Ocean Territory', 'IO', 'IOT'),
				(${uuid_function}, 'PAC', 0, 'British Virgin Islands', 'VS', 'VGB'),
				(${uuid_function}, 'PAC', 0, 'Brunei', 'BX', 'BRN'),
				(${uuid_function}, 'PAC', 0, 'Bulgaria', 'BG', 'BGR'),
				(${uuid_function}, 'PAC', 0, 'Burkina Faso', 'UV', 'BFA'),
				(${uuid_function}, 'PAC', 0, 'Burundi', 'BY', 'BDI'),
				(${uuid_function}, 'PAC', 0, 'Cambodia', 'CB', 'KHM'),
				(${uuid_function}, 'PAC', 0, 'Cameroon', 'CM', 'CMR'),
				(${uuid_function}, 'PAC', 0, 'Canada', 'CA', 'CAN'),
				(${uuid_function}, 'PAC', 0, 'Cape Verde', 'CV', 'CPV'),
				(${uuid_function}, 'PAC', 0, 'Cayman Islands', 'CJ', 'CYM'),
				(${uuid_function}, 'PAC', 0, 'Central African Republic', 'CT', 'CAF'),
				(${uuid_function}, 'PAC', 0, 'Chad', 'CD', 'TCD'),
				(${uuid_function}, 'PAC', 0, 'Chile', 'CI', 'CHL'),
				(${uuid_function}, 'PAC', 0, 'Christmas Island', 'KT', 'CXR'),
				(${uuid_function}, 'PAC', 0, 'Cocos (Keeling) Islands', 'CK', 'CCK'),
				(${uuid_function}, 'PAC', 0, 'Colombia', 'CO', 'COL'),
				(${uuid_function}, 'PAC', 0, 'Comoros', 'CN', 'COM'),
				(${uuid_function}, 'PAC', 0, 'Cook Islands', 'CW', 'COK'),
				(${uuid_function}, 'PAC', 0, 'Coral Sea Islands', 'CR', 'CSI'),
				(${uuid_function}, 'PAC', 0, 'Costa Rica', 'CS', 'CRI'),
				(${uuid_function}, 'PAC', 0, 'Cte d''Ivoire', 'IV', 'CIV'),
				(${uuid_function}, 'PAC', 0, 'Croatia', 'HR', 'HRV'),
				(${uuid_function}, 'PAC', 0, 'Cuba', 'CU', 'CUB'),
				(${uuid_function}, 'PAC', 0, 'Cyprus', 'CY', 'CYP'),
				(${uuid_function}, 'PAC', 0, 'Czech Republic', 'CZ', 'CZE'),
				(${uuid_function}, 'PAC', 0, 'Democratic People''s Republic of Korea', 'KN', 'PRK'),
				(${uuid_function}, 'PAC', 0, 'Democratic Republic of the Congo', 'CD', 'COD'),
				(${uuid_function}, 'PAC', 0, 'Denmark', 'DA', 'DNK'),
				(${uuid_function}, 'PAC', 0, 'Djibouti', 'DJ', 'DJI'),
				(${uuid_function}, 'PAC', 0, 'Dominica', 'DO', 'DMA'),
				(${uuid_function}, 'PAC', 0, 'Dominican Republic', 'DR', 'DOM'),
				(${uuid_function}, 'PAC', 1, 'East Germany', 'GC', 'n/a'),
				(${uuid_function}, 'PAC', 0, 'Ecuador', 'EC', 'ECU'),
				(${uuid_function}, 'PAC', 0, 'Egypt', 'EG', 'EGY'),
				(${uuid_function}, 'PAC', 0, 'El Salvador', 'SV', 'SLV'),
				(${uuid_function}, 'PAC', 0, 'Equatorial Guinea', 'EK', 'GNQ'),
				(${uuid_function}, 'PAC', 0, 'Eritrea', 'ER', 'ERI'),
				(${uuid_function}, 'PAC', 0, 'Estonia', 'EN', 'EST'),
				(${uuid_function}, 'PAC', 0, 'Ethiopia', 'ET', 'ETH'),
				(${uuid_function}, 'PAC', 0, 'Falkland Islands', 'FK', 'FLK'),
				(${uuid_function}, 'PAC', 0, 'Faroe Islands', 'FO', 'FRO'),
				(${uuid_function}, 'PAC', 0, 'Federated States of Micronesia', 'FM', 'FSM'),
				(${uuid_function}, 'PAC', 0, 'Fiji', 'FJ', 'FJI'),
				(${uuid_function}, 'PAC', 0, 'Finland', 'FI', 'FIN'),
				(${uuid_function}, 'PAC', 0, 'France', 'FR', 'FRA'),
				(${uuid_function}, 'PAC', 0, 'French Guiana', 'FG', 'GUF'),
				(${uuid_function}, 'PAC', 0, 'French Polynesia', 'FP', 'PYF'),
				(${uuid_function}, 'PAC', 0, 'French Southern Territories', 'FS', 'ATF'),
				(${uuid_function}, 'PAC', 0, 'Gabon', 'GA', 'GAB'),
				(${uuid_function}, 'PAC', 0, 'Georgia', 'GG', 'GEO'),
				(${uuid_function}, 'PAC', 0, 'Germany', 'DE', 'DEU'),
				(${uuid_function}, 'PAC', 0, 'Ghana', 'GH', 'GHA'),
				(${uuid_function}, 'PAC', 0, 'Gibraltar', 'GI', 'GIB'),
				(${uuid_function}, 'PAC', 0, 'Greece', 'GR', 'GRC'),
				(${uuid_function}, 'PAC', 0, 'Greenland', 'GL', 'GRL'),
				(${uuid_function}, 'PAC', 0, 'Grenada', 'GJ', 'GRD'),
				(${uuid_function}, 'PAC', 0, 'Guadeloupe', 'GP', 'GLP'),
				(${uuid_function}, 'PAC', 0, 'Guam', 'GQ', 'GUM'),
				(${uuid_function}, 'PAC', 0, 'Guatemala', 'GT', 'GTM'),
				(${uuid_function}, 'PAC', 0, 'Guinea-Bissau', 'PU', 'GNB'),
				(${uuid_function}, 'PAC', 0, 'Guinea', 'GV', 'GIN'),
				(${uuid_function}, 'PAC', 0, 'Guyana', 'GY', 'GUY'),
				(${uuid_function}, 'PAC', 0, 'Haiti', 'HA', 'HTI'),
				(${uuid_function}, 'PAC', 0, 'Heard and McDonald Islands', 'HM', 'HMD'),
				(${uuid_function}, 'PAC', 0, 'Honduras', 'HO', 'HND'),
				(${uuid_function}, 'PAC', 0, 'Hong Kong', 'HK', 'HKG'),
				(${uuid_function}, 'PAC', 0, 'Howland Island', 'HQ', 'HQI'),
				(${uuid_function}, 'PAC', 0, 'Hungary', 'HU', 'HUN'),
				(${uuid_function}, 'PAC', 0, 'Iceland', 'IC', 'ISL'),
				(${uuid_function}, 'PAC', 0, 'India', 'IN', 'IND'),
				(${uuid_function}, 'PAC', 0, 'Indonesia', 'ID', 'IDN'),
				(${uuid_function}, 'PAC', 0, 'Iran', 'IR', 'IRN'),
				(${uuid_function}, 'PAC', 0, 'Iraq', 'IZ', 'IRQ'),
				(${uuid_function}, 'PAC', 0, 'Ireland', 'EI', 'IRL'),
				(${uuid_function}, 'PAC', 0, 'Israel', 'IS', 'ISR'),
				(${uuid_function}, 'PAC', 0, 'Italy', 'IT', 'ITA'),
				(${uuid_function}, 'PAC', 0, 'Jamaica', 'JM', 'JAM'),
				(${uuid_function}, 'PAC', 0, 'Jan Mayen Island', 'JN', 'JNM'),
				(${uuid_function}, 'PAC', 0, 'Japan', 'JA', 'JPN'),
				(${uuid_function}, 'PAC', 0, 'Johnston Atoll', 'JQ', 'JQA'),
				(${uuid_function}, 'PAC', 0, 'Jordan', 'JO', 'JOR'),
				(${uuid_function}, 'PAC', 0, 'Kazakhstan', 'KZ', 'KAZ'),
				(${uuid_function}, 'PAC', 0, 'Kenya', 'KE', 'KEN'),
				(${uuid_function}, 'PAC', 0, 'Kiribati', 'KR', 'KIR'),
				(${uuid_function}, 'PAC', 0, 'Kosovo Albanian', NULL, 'KOA'),
				(${uuid_function}, 'PAC', 0, 'Kosovo Bosniak', NULL, 'KOB'),
				(${uuid_function}, 'PAC', 0, 'Kosovo Gorani', NULL, 'KOG'),
				(${uuid_function}, 'PAC', 0, 'Kosovo Serbian', NULL, 'KOS'),
				(${uuid_function}, 'PAC', 0, 'Kosovo Turks', NULL, 'KOT'),
				(${uuid_function}, 'PAC', 0, 'Kuwait', 'KU', 'KWT'),
				(${uuid_function}, 'PAC', 0, 'Kyrgyzstan', 'KG', 'KGZ'),
				(${uuid_function}, 'PAC', 0, 'Laos', 'LA', 'LAO'),
				(${uuid_function}, 'PAC', 0, 'Latvia', 'LG', 'LVA'),
				(${uuid_function}, 'PAC', 0, 'Lebanon', 'LE', 'LBN'),
				(${uuid_function}, 'PAC', 0, 'Lesotho', 'LT', 'LSO'),
				(${uuid_function}, 'PAC', 0, 'Liberia', 'LI', 'LBR'),
				(${uuid_function}, 'PAC', 0, 'Libya', 'LY', 'LBY'),
				(${uuid_function}, 'PAC', 0, 'Liechtenstein', 'LS', 'LIE'),
				(${uuid_function}, 'PAC', 0, 'Lithuania', 'LH', 'LTU'),
				(${uuid_function}, 'PAC', 0, 'Luxembourg', 'LU', 'LUX'),
				(${uuid_function}, 'PAC', 0, 'Macau', 'MC', 'MAC'),
				(${uuid_function}, 'PAC', 0, 'Madagascar', 'MA', 'MDG'),
				(${uuid_function}, 'PAC', 0, 'Malawi', 'MI', 'MWI'),
				(${uuid_function}, 'PAC', 0, 'Malaysia', 'MY', 'MYS'),
				(${uuid_function}, 'PAC', 0, 'Mali', 'ML', 'MLI'),
				(${uuid_function}, 'PAC', 0, 'Malta', 'MT', 'MLT'),
				(${uuid_function}, 'PAC', 0, 'Marshall Islands', 'RM', 'MHL'),
				(${uuid_function}, 'PAC', 0, 'Martinique', 'MB', 'MTQ'),
				(${uuid_function}, 'PAC', 0, 'Mauritania', 'MR', 'MRT'),
				(${uuid_function}, 'PAC', 0, 'Mauritius', 'MP', 'MUS'),
				(${uuid_function}, 'PAC', 0, 'Mayotte', 'YT', NULL),
				(${uuid_function}, 'PAC', 0, 'Mexico', 'MX', 'MEX'),
				(${uuid_function}, 'PAC', 0, 'Monaco', 'MN', 'MCO'),
				(${uuid_function}, 'PAC', 0, 'Mongolia', 'MG', 'MNG'),
				(${uuid_function}, 'PAC', 0, 'Montenegro', 'ME', 'MNE'),
				(${uuid_function}, 'PAC', 0, 'Montserrat', 'MH', 'MSR'),
				(${uuid_function}, 'PAC', 0, 'Morocco', 'MO', 'MAR'),
				(${uuid_function}, 'PAC', 0, 'Mozambique', 'MZ', 'MOZ'),
				(${uuid_function}, 'PAC', 0, 'Myanmar', 'MM', 'MMR'),
				(${uuid_function}, 'PAC', 0, 'Namibia', 'WA', 'NAM'),
				(${uuid_function}, 'PAC', 0, 'Nauru', 'NR', 'NRU'),
				(${uuid_function}, 'PAC', 0, 'Nepal', 'NP', 'NPL'),
				(${uuid_function}, 'PAC', 1, 'Netherlands Antilles', 'NA', 'ANT'),
				(${uuid_function}, 'PAC', 0, 'Netherlands', 'NL', 'NLD'),
				(${uuid_function}, 'PAC', 0, 'New Caledonia', 'NC', 'NCL'),
				(${uuid_function}, 'PAC', 0, 'New Zealand', 'NZ', 'NZL'),
				(${uuid_function}, 'PAC', 0, 'Nicaragua', 'NU', 'NIC'),
				(${uuid_function}, 'PAC', 0, 'Nigeria', 'NG', 'NGA'),
				(${uuid_function}, 'PAC', 0, 'Niger', 'NE', 'NER'),
				(${uuid_function}, 'PAC', 0, 'Niue', 'NU', 'NIU'),
				(${uuid_function}, 'PAC', 0, 'Norfolk Island', 'NF', 'NFK'),
				(${uuid_function}, 'PAC', 0, 'Northern Mariana Islands', 'CQ', 'MNP'),
				(${uuid_function}, 'PAC', 0, 'North Macedonia', 'MK', 'MKD'),
				(${uuid_function}, 'PAC', 0, 'Norway', 'NO', 'NOR'),
				(${uuid_function}, 'PAC', 0, 'Oman', 'MU', 'OMN'),
				(${uuid_function}, 'PAC', 0, 'Pakistan', 'PK', 'PAK'),
				(${uuid_function}, 'PAC', 0, 'Palau', 'PS', 'PLW'),
				(${uuid_function}, 'PAC', 0, 'Palestinian Territory', 'PS', 'PSE'),
				(${uuid_function}, 'PAC', 0, 'Panama', 'PM', 'PAN'),
				(${uuid_function}, 'PAC', 0, 'Papua New Guinea', 'PP', 'PNG'),
				(${uuid_function}, 'PAC', 0, 'Paracel Islands', 'PF', 'PFI'),
				(${uuid_function}, 'PAC', 0, 'Paraguay', 'PA', 'PRY'),
				(${uuid_function}, 'PAC', 0, 'People''s Republic of China', 'CH', 'CHN'),
				(${uuid_function}, 'PAC', 0, 'Peru', 'PE', 'PER'),
				(${uuid_function}, 'PAC', 0, 'Philippines', 'RP', 'PHL'),
				(${uuid_function}, 'PAC', 0, 'Pitcairn Islands', 'PN', 'PCN'),
				(${uuid_function}, 'PAC', 0, 'Poland', 'PL', 'POL'),
				(${uuid_function}, 'PAC', 0, 'Portugal', 'PT', 'PRT'),
				(${uuid_function}, 'PAC', 0, 'Puerto Rico', 'RQ', 'PRI'),
				(${uuid_function}, 'PAC', 0, 'Qatar', 'QA', 'QAT'),
				(${uuid_function}, 'PAC', 0, 'Republic of China (Taiwan)', 'TW', 'TWN'),
				(${uuid_function}, 'PAC', 0, 'Republic of Korea', 'KS', 'KOR'),
				(${uuid_function}, 'PAC', 0, 'Republic of Moldova', 'MD', 'MDA'),
				(${uuid_function}, 'PAC', 0, 'Republic of the Congo', 'CF', 'COG'),
				(${uuid_function}, 'PAC', 0, 'Runion', 'RE', 'REU'),
				(${uuid_function}, 'PAC', 0, 'Roma Ashkali Egyptian', NULL, 'RAE'),
				(${uuid_function}, 'PAC', 0, 'Romania', 'RO', 'ROU'),
				(${uuid_function}, 'PAC', 0, 'Russia', 'RU', 'RUS'),
				(${uuid_function}, 'PAC', 0, 'Rwanda', 'RW', 'RWA'),
				(${uuid_function}, 'PAC', 0, 'Saint Helena', 'SH', 'SHN'),
				(${uuid_function}, 'PAC', 0, 'Saint Kitts and Nevis', 'SC', 'KNA'),
				(${uuid_function}, 'PAC', 0, 'Saint Lucia', 'ST', 'LCA'),
				(${uuid_function}, 'PAC', 0, 'Saint Pierre and Miquelon', 'SB', 'SPM'),
				(${uuid_function}, 'PAC', 0, 'Saint Vincent and the Grenadines', 'VC', 'VCT'),
				(${uuid_function}, 'PAC', 0, 'Samoa', 'SS', 'WSM'),
				(${uuid_function}, 'PAC', 0, 'San Marino', 'SM', 'SMR'),
				(${uuid_function}, 'PAC', 0, 'So Tom and Prncipe', 'TP', 'STP'),
				(${uuid_function}, 'PAC', 0, 'Saudi Arabia', 'SA', 'SAU'),
				(${uuid_function}, 'PAC', 0, 'Senegal', 'SG', 'SEN'),
				(${uuid_function}, 'PAC', 0, 'Serbia and Montenegro', NULL, 'SCG'),
				(${uuid_function}, 'PAC', 0, 'Serbia', 'RS', 'SRB'),
				(${uuid_function}, 'PAC', 0, 'Seychelles', 'SE', 'SYC'),
				(${uuid_function}, 'PAC', 0, 'Sierra Leone', 'SL', 'SLE'),
				(${uuid_function}, 'PAC', 0, 'Singapore', 'SN', 'SGP'),
				(${uuid_function}, 'PAC', 0, 'Slovakia', 'LO', 'SVK'),
				(${uuid_function}, 'PAC', 0, 'Slovenia', 'SI', 'SVN'),
				(${uuid_function}, 'PAC', 0, 'Solomon Islands', 'BP', 'SLB'),
				(${uuid_function}, 'PAC', 0, 'Somalia', 'SO', 'SOM'),
				(${uuid_function}, 'PAC', 0, 'South Africa', 'SF', 'ZAF'),
				(${uuid_function}, 'PAC', 0, 'South Georgia and South Sandwich Islands', 'SX', 'SGS'),
				(${uuid_function}, 'PAC', 0, 'South Sudan', 'SS', 'SSD'),
				(${uuid_function}, 'PAC', 0, 'Spain', 'ES', 'ESP'),
				(${uuid_function}, 'PAC', 0, 'Sri Lanka', 'CE', 'LKA'),
				(${uuid_function}, 'PAC', 0, 'Sudan', 'SU', 'SDN'),
				(${uuid_function}, 'PAC', 0, 'Suriname', 'NS', 'SUR'),
				(${uuid_function}, 'PAC', 0, 'Svalbard and Jan Mayen Islands', 'SJ', 'SJM'),
				(${uuid_function}, 'PAC', 0, 'Swaziland', 'WZ', 'SWZ'),
				(${uuid_function}, 'PAC', 0, 'Sweden', 'SW', 'SWE'),
				(${uuid_function}, 'PAC', 0, 'Switzerland', 'SZ', 'CHE'),
				(${uuid_function}, 'PAC', 0, 'Syria', 'SY', 'SYR'),
				(${uuid_function}, 'PAC', 0, 'Tajikistan', 'TI', 'TJK'),
				(${uuid_function}, 'PAC', 0, 'Tanzania', 'TZ', 'TZA'),
				(${uuid_function}, 'PAC', 0, 'Thailand', 'TH', 'THA'),
				(${uuid_function}, 'PAC', 0, 'The Bahamas', 'BF', 'BHS'),
				(${uuid_function}, 'PAC', 0, 'The Gambia', 'GM', 'GMB'),
				(${uuid_function}, 'PAC', 0, 'The Maldives', 'MV', 'MDV'),
				(${uuid_function}, 'PAC', 0, 'Timor-Leste', 'TL', 'TLS'),
				(${uuid_function}, 'PAC', 0, 'Togo', 'TO', 'TGO'),
				(${uuid_function}, 'PAC', 0, 'Tokelau', 'TK', 'TKL'),
				(${uuid_function}, 'PAC', 0, 'Tonga', 'TN', 'TON'),
				(${uuid_function}, 'PAC', 0, 'Trinidad and Tobago', 'TD', 'TTO'),
				(${uuid_function}, 'PAC', 0, 'Tunisia', 'TS', 'TUN'),
				(${uuid_function}, 'PAC', 0, 'Trkiye', 'TU', 'TUR'),
				(${uuid_function}, 'PAC', 0, 'Turkmenistan', 'TX', 'TKM'),
				(${uuid_function}, 'PAC', 0, 'Turks and Caicos Islands', 'TK', 'TCA'),
				(${uuid_function}, 'PAC', 0, 'Tuvalu', 'TV', 'TUV'),
				(${uuid_function}, 'PAC', 0, 'Uganda', 'UG', 'UGA'),
				(${uuid_function}, 'PAC', 0, 'Ukraine', 'UA', 'UKR'),
				(${uuid_function}, 'PAC', 1, 'Union of Soviet Socialist Republics', 'UR', 'n/a'),
				(${uuid_function}, 'PAC', 0, 'United Arab Emirates', 'TC', 'ARE'),
				(${uuid_function}, 'PAC', 0, 'United Kingdom (Great Britain and Northern Ireland)', 'GB', 'GBR'),
				(${uuid_function}, 'PAC', 0, 'United States', 'US', 'USA'),
				(${uuid_function}, 'PAC', 0, 'Uruguay', 'UY', 'URY'),
				(${uuid_function}, 'PAC', 0, 'U.S. Minor Outlying Islands', 'IQ', 'UMI'),
				(${uuid_function}, 'PAC', 0, 'U.S. Virgin Islands', 'VI', 'VIR'),
				(${uuid_function}, 'PAC', 0, 'Uzbekistan', 'UZ', 'UZB'),
				(${uuid_function}, 'PAC', 0, 'Vanuatu', 'NH', 'VUT'),
				(${uuid_function}, 'PAC', 0, 'Vatican City (Holy See)', 'VT', 'VAT'),
				(${uuid_function}, 'PAC', 0, 'Venezuela', 'VE', 'VEN'),
				(${uuid_function}, 'PAC', 0, 'Vietnam', 'VN', 'VNM'),
				(${uuid_function}, 'PAC', 0, 'Wallis and Futuna Islands', 'WF', 'WLF'),
				(${uuid_function}, 'PAC', 0, 'Western Sahara', 'WI', 'ESH'),
				(${uuid_function}, 'PAC', 0, 'Yemen', 'YE', 'YEM'),
				(${uuid_function}, 'PAC', 0, 'Yugoslavia (Federal Republic of)', 'YU', 'YUG'),
				(${uuid_function}, 'PAC', 0, 'Zambia', 'ZA', 'ZMB'),
				(${uuid_function}, 'PAC', 0, 'Zimbabwe', 'ZI', 'ZWE'),
				-- Not an offical country, but used when nothing else seems to fit
				(${uuid_function}, 'PAC', 0, 'Unknown', NULL, NULL);
		</sql>
		<rollback>
			<sql>
				DELETE FROM locations
				WHERE type = 'PAC';
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="add-countryUuid-to-people" author="gjvoosten">
		<addColumn tableName="people">
			<column name="countryUuid" type="${uuid_type}" />
		</addColumn>
		<addForeignKeyConstraint
			constraintName="FK_people_country"
			baseTableName="people"
			baseColumnNames="countryUuid"
			referencedTableName="locations"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="link-people-to-countries" author="gjvoosten">
		<sql>
			-- Exact match
			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND l.name = people.country;

			-- Exact match with trigram prefix
			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND people.country = l.trigram || ' - ' || l.name;

			-- Some hard-coded exceptions
			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'Albania,' -- typo in some dictionaries
			AND l.type = 'PAC'
			AND l.name = 'Albania';

			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'Macedonia' -- old name
			AND l.type = 'PAC'
			AND l.name = 'North Macedonia';

			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'Turkey' -- old name
			AND l.type = 'PAC'
			AND l.name = 'Trkiye';

			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'TUR - Turkey' -- old name with prefix
			AND l.type = 'PAC'
			AND l.name = 'Trkiye';

			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'United Kingdom' -- shorter name
			AND l.type = 'PAC'
			AND l.name = 'United Kingdom (Great Britain and Northern Ireland)';

			UPDATE people
			SET "countryUuid" = l.uuid,
			    country = NULL -- we have an exact match
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country = 'United States of America' -- longer name
			AND l.type = 'PAC'
			AND l.name = 'United States';

			-- Some heuristics (keep the old country for reference!):
			-- prefix match
			UPDATE people
			SET "countryUuid" = l.uuid
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND l.name LIKE people.country || '%';

			-- suffix match
			UPDATE people
			SET "countryUuid" = l.uuid
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND l.name LIKE '%' || people.country;

			-- infix match
			UPDATE people
			SET "countryUuid" = l.uuid
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND l.name LIKE '%' || people.country || '%';

			-- Finally, set unmatched ones to Unknown
			UPDATE people
			SET "countryUuid" = l.uuid
			FROM locations l
			WHERE people."countryUuid" IS NULL
			AND people.country IS NOT NULL
			AND l.type = 'PAC'
			AND l.name = 'Unknown';
		</sql>
		<rollback>
			<sql>
				UPDATE people
				SET "countryUuid" = NULL,
				    country = l.name
				FROM locations l
				WHERE people."countryUuid" = l.uuid
				AND people.country IS NULL;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="rename-old-people-country-column" author="gjvooosten">
		<renameColumn tableName="people" oldColumnName="country" newColumnName="obsoleteCountry" />
	</changeSet>

	<changeSet id="add-ngrams-to-locations-fulltext-index" author="gjvoosten" runInTransaction="false">
		<sql>
			<!-- Drop full-text materialized view (incl. index) since we cannot just ALTER it -->
			DROP MATERIALIZED VIEW mv_fts_locations;

			<!-- Drop generated full-text column -->
			ALTER TABLE locations DROP COLUMN full_text;

			<!-- Re-add generated full-text column, with the digram and trigram columns included-->
			ALTER TABLE locations
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
							|| to_tsvector('simple', coalesce(locations.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.digram, ''))
							|| to_tsvector('simple', coalesce(locations.digram, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.trigram, ''))
							|| to_tsvector('simple', coalesce(locations.trigram, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.description, ''))
							|| to_tsvector('simple', coalesce(locations.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(locations."customFields"::jsonb))
							|| to_tsvector('simple', jsonb_value_agg(locations."customFields"::jsonb)), ${fts_lower})
				) STORED;

			<!-- Re-create full-text materialized view and index -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
			SELECT
				locations.uuid,
				locations.full_text
					|| coalesce(tsvector_agg(notes.full_text), ''::tsvector)
			FROM locations
					LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
				AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
					LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY locations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="add-attachments-to-full_text-index" author="gjvoosten" runInTransaction="false">
		<sql>
			<!-- Add generated full-text column -->
			ALTER TABLE attachments
				ADD COLUMN full_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(attachments.caption, ''))
						  || to_tsvector('simple', coalesce(attachments.caption, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(attachments."fileName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(attachments.description, ''))
						  || to_tsvector('simple', coalesce(attachments.description, '')), ${fts_low})
				) STORED;

			<!-- Create full-text materialized views and indexes -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_attachments(uuid, full_text) AS
				SELECT
					attachments.uuid,
					attachments.full_text
				FROM attachments
				GROUP BY attachments.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_attachments_uuid" ON mv_fts_attachments(uuid);
			CREATE INDEX "FT_mv_fts_attachments" ON mv_fts_attachments USING gin(full_text);
			CREATE INDEX "TR_attachments_uuid" ON mv_fts_attachments USING gin(uuid gin_trgm_ops);
		</sql>
		<rollback>
			<sql>
				DROP MATERIALIZED VIEW mv_fts_attachments;
				ALTER TABLE attachments DROP COLUMN full_text;
			</sql>
		</rollback>
	</changeSet>

	<changeSet id="remove-undefined-from-classification" author="gjvoosten">
		<sql>
			UPDATE reports
			SET classification = NULL
			WHERE classification = 'undefined';

			UPDATE attachments
			SET classification = NULL
			WHERE classification = 'undefined';
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="update-jsonb-aggregation-functions" author="gjvoosten" runInTransaction="false">
		<sql>
			<!-- Update the function for aggregating JSON values to also handle empty values -->
			CREATE OR REPLACE FUNCTION jsonb_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN CASE
					WHEN jsonb_typeof(p_json) = ''array'' THEN coalesce(public.jsonb_array_value_agg(p_json, ignore_key), '''')
					WHEN jsonb_typeof(p_json) = ''object'' THEN coalesce(public.jsonb_object_value_agg(p_json, ignore_key), '''')
					WHEN jsonb_typeof(p_json) = ''string''
						AND p_json #>> ''{}'' !~ ''^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{1,3}Z$''
						THEN coalesce(p_json #>> ''{}'', '''')
					ELSE ''''
				END;
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			<!-- Forcefully update all computed full_text columns for tables that have a customFields column -->
			UPDATE locations SET "customFields" = "customFields";
			UPDATE organizations SET "customFields" = "customFields";
			UPDATE people SET "customFields" = "customFields";
			UPDATE positions SET "customFields" = "customFields";
			UPDATE reports SET "customFields" = "customFields";
			UPDATE tasks SET "customFields" = "customFields";
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="add-mergedEntities" author="gjvoosten">
		<createTable tableName="mergedEntities">
			<column name="oldUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="newUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="datetime" />
		</createTable>

		<!-- Entities can be merged only once -->
		<addUniqueConstraint
			tableName="mergedEntities"
			columnNames="oldUuid, newUuid"
			constraintName="UQ_MergedEntitiesOldUuidNewUuid"
		/>
	</changeSet>

	<changeSet id="add-locations-to-locations-m2m" author="gjvoosten">
		<createTable tableName="locationRelationships">
			<column name="parentLocationUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="childLocationUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
				tableName="locationRelationships"
				columnNames="parentLocationUuid, childLocationUuid"
				constraintName="UQ_uniqueLocationRelationships"
		/>
		<addForeignKeyConstraint
				constraintName="FK_locationRelationships_parentLocation"
				baseTableName="locationRelationships"
				baseColumnNames="parentLocationUuid"
				referencedTableName="locations"
				referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
				constraintName="FK_locationRelationships_childLocation"
				baseTableName="locationRelationships"
				baseColumnNames="childLocationUuid"
				referencedTableName="locations"
				referencedColumnNames="uuid"
				onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<createIndex
				indexName="IDX_locationRelationships_parentLocationUuid"
				tableName="locationRelationships"
		>
			<column name="parentLocationUuid" />
		</createIndex>
		<createIndex
				indexName="IDX_locationRelationships_childLocationUuid"
				tableName="locationRelationships"
		>
			<column name="childLocationUuid" />
		</createIndex>
	</changeSet>

	<changeSet id="update-task-assessmentKey" author="gjvoosten">
		<sql>
			UPDATE notes
			SET "assessmentKey" = regexp_replace("assessmentKey", '\.topLevel\.', '.')
			WHERE "assessmentKey" LIKE 'fields.task.topLevel.assessments.%';

			UPDATE notes
			SET "assessmentKey" = regexp_replace("assessmentKey", '\.subLevel\.', '.')
			WHERE "assessmentKey" LIKE 'fields.task.subLevel.assessments.%';
		</sql>
		<!-- Rolling back is not useful anymore -->
	</changeSet>

	<changeSet id="add-tasks-selectable" author="gjvoosten">
		<addColumn tableName="tasks">
			<column name="selectable" type="boolean" defaultValue="true" />
		</addColumn>

		<sql>
			<!-- For backwards compatibility, set the top-level tasks to non-selectable -->
			UPDATE tasks
			SET selectable = FALSE
			WHERE "parentTaskUuid" IS NULL;
		</sql>
	</changeSet>

	<changeSet id="migrate-custom-security-marking-to-report-classification" author="midmarch">
		<sql>
			<!-- Migrate report.customFields.securityMarking to report.classification -->
			UPDATE reports
			SET classification = "customFields"::jsonb->>'securityMarking';

			<!-- Replace report.classification empty strings with NULL -->
			UPDATE reports
			SET classification = NULL
			WHERE classification = '';
		</sql>
	</changeSet>

	<changeSet id="add-errorMessage-to-pendingEmails" author="chessray">
		<addColumn tableName="pendingEmails">
			<column name="errorMessage" type="text"/>
		</addColumn>
	</changeSet>

	<changeSet id="add-entityAvatars-table" author="fdelcastillo">
		<createTable tableName="entityAvatars">
			<!-- The next two columns combined act as a generic foreign key reference to a (table name, uuid)-tuple -->
			<column name="relatedObjectType" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="relatedObjectUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="attachmentUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="applyCrop" type="boolean">
				<constraints nullable="false" />
			</column>
			<column name="cropLeft" type="number" />
			<column name="cropTop" type="number" />
			<column name="cropWidth" type="number" />
			<column name="cropHeight" type="number" />
		</createTable>
		<addUniqueConstraint
			tableName="entityAvatars"
			columnNames="relatedObjectType, relatedObjectUuid"
			constraintName="UQ_uniqueEntityAvatars"
		/>
		<addForeignKeyConstraint
			baseColumnNames="attachmentUuid" baseTableName="entityAvatars"
			constraintName="fk_entityAvatars_attachment" onDelete="CASCADE" onUpdate="NO ACTION"
			referencedColumnNames="uuid" referencedTableName="attachments"
		/>
	</changeSet>

	<changeSet id="migrate-old-people-avatars" author="gjvoosten">
		<sql>
			INSERT INTO "entityAvatars" (
				"relatedObjectType",
				"relatedObjectUuid",
				"attachmentUuid",
				"applyCrop",
				"cropLeft",
				"cropTop",
				"cropWidth",
				"cropHeight"
			)
			SELECT
				'people',
				p.uuid,
				p."avatarUuid",
				FALSE,
				0,
				0,
				0,
				0
			FROM people p
			WHERE p."avatarUuid" IS NOT NULL;
		</sql>
		<dropColumn tableName="people" columnName="avatarUuid" />
	</changeSet>

	<changeSet id="add-constraints-to-customSensitiveInformation" author="gjvoosten">
		<addPrimaryKey
			tableName="customSensitiveInformation"
			columnNames="uuid"
			constraintName="PK_customSensitiveInformation"
		/>
		<addUniqueConstraint
			tableName="customSensitiveInformation"
			columnNames="customFieldName, relatedObjectType, relatedObjectUuid"
			constraintName="UQ_CustomSensitiveInformationCustomFieldNameRelatedObject"
		/>
	</changeSet>

	<changeSet id="add-description-field-to-positions" author="gjvoosten">
		<addColumn tableName="positions">
			<column name="description" type="text"/>
		</addColumn>
	</changeSet>

	<changeSet id="add-eventSeries-table" author="fdelcastillo">
		<createTable tableName="eventSeries">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="status" type="int">
				<constraints nullable="false" />
			</column>
			<column name="ownerOrgUuid" type="${uuid_type}" />
			<column name="hostOrgUuid" type="${uuid_type}" />
			<column name="adminOrgUuid" type="${uuid_type}" />
			<column name="name" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="description" type="text"/>
			<column name="updatedAt" type="timestamp" />
		</createTable>
		<addForeignKeyConstraint
			constraintName="FK_eventSeries_ownerOrganization"
			baseTableName="eventSeries"
			baseColumnNames="ownerOrgUuid"
			referencedTableName="organizations"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventSeries_hostOrganization"
			baseTableName="eventSeries"
			baseColumnNames="hostOrgUuid"
			referencedTableName="organizations"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventSeries_adminOrganization"
			baseTableName="eventSeries"
			baseColumnNames="adminOrgUuid"
			referencedTableName="organizations"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-event-table" author="fdelcastillo">
		<createTable tableName="events">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="status" type="int">
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="startDate" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="endDate" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="ownerOrgUuid" type="${uuid_type}" />
			<column name="hostOrgUuid" type="${uuid_type}" />
			<column name="adminOrgUuid" type="${uuid_type}" />
			<column name="type" type="text"/>
			<column name="description" type="text"/>
			<column name="eventSeriesUuid" type="${uuid_type}" />
			<column name="locationUuid" type="${uuid_type}" />
			<column name="outcomes" type="text" />
			<column name="createdAt" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="updatedAt" type="timestamp" />
		</createTable>
		<addForeignKeyConstraint
			constraintName="FK_events_ownerOrganization"
			baseTableName="events"
			baseColumnNames="ownerOrgUuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
			referencedColumnNames="uuid"
			referencedTableName="organizations"
		/>
		<addForeignKeyConstraint
			constraintName="FK_events_hostOrganization"
			baseTableName="events"
			baseColumnNames="hostOrgUuid"
			referencedTableName="organizations"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_events_adminOrganization"
			baseTableName="events"
			baseColumnNames="adminOrgUuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
			referencedColumnNames="uuid"
			referencedTableName="organizations"
		/>
		<addForeignKeyConstraint
			constraintName="FK_events_eventSeries"
			baseTableName="events"
			baseColumnNames="eventSeriesUuid"
			referencedTableName="eventSeries"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_events_location"
			baseTableName="events"
			baseColumnNames="locationUuid"
			referencedTableName="locations"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-event-to-report-table" author="fdelcastillo">
		<addColumn tableName="reports">
			<column name="eventUuid" type="${uuid_type}" />
		</addColumn>
		<addForeignKeyConstraint
			constraintName="FK_reports_event"
			baseTableName="reports"
			baseColumnNames="eventUuid"
			referencedTableName="events"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-event-tasks-table" author="fdelcastillo">
		<createTable tableName="eventTasks">
			<column name="eventUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="taskUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			constraintName="UQ_EventTasksEventTask"
			tableName="eventTasks"
			columnNames="eventUuid, taskUuid"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventTasks_task"
			baseTableName="eventTasks"
			baseColumnNames="taskUuid"
			referencedTableName="tasks"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventTasks_event"
			baseTableName="eventTasks"
			baseColumnNames="eventUuid"
			referencedTableName="events"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-event-organizations-table" author="fdelcastillo">
		<createTable tableName="eventOrganizations">
			<column name="eventUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="organizationUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			constraintName="UQ_EventOrganizationsEventOrganization"
			tableName="eventOrganizations"
			columnNames="eventUuid, organizationUuid"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventOrganizations_organization"
			baseTableName="eventOrganizations"
			baseColumnNames="organizationUuid"
			referencedTableName="organizations"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventOrganizations_event"
			baseTableName="eventOrganizations"
			baseColumnNames="eventUuid"
			referencedTableName="events"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-event-people-table" author="fdelcastillo">
		<createTable tableName="eventPeople">
			<column name="eventUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
			<column name="personUuid" type="${uuid_type}">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			constraintName="UQ_EventPeopleEventPerson"
			tableName="eventPeople"
			columnNames="eventUuid, personUuid"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventPeople_person"
			baseTableName="eventPeople"
			baseColumnNames="personUuid"
			referencedTableName="people"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
		<addForeignKeyConstraint
			constraintName="FK_eventPeople_event"
			baseTableName="eventPeople"
			baseColumnNames="eventUuid"
			referencedTableName="events"
			referencedColumnNames="uuid"
			onDelete="NO ACTION" onUpdate="NO ACTION"
		/>
	</changeSet>

	<changeSet id="add-accessTokens-table" author="gjvoosten">
		<createTable tableName="accessTokens">
			<column name="uuid" type="${uuid_type}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="text" />
			<column name="tokenHash" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="createdAt" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="expiresAt" type="timestamp">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addUniqueConstraint
			tableName="accessTokens"
			columnNames="tokenHash"
			constraintName="UQ_AccessTokensTokenHash"
		/>
	</changeSet>

	<changeSet id="remove-adminSettings-classification" author="gjvoosten">
		<delete tableName="adminSettings">
			<where>key = 'SECURITY_BANNER_CLASSIFICATION'</where>
		</delete>
		<delete tableName="adminSettings">
			<where>key = 'SECURITY_BANNER_RELEASABILITY'</where>
		</delete>
		<delete tableName="adminSettings">
			<where>key = 'SECURITY_BANNER_COLOR'</where>
		</delete>
	</changeSet>

	<changeSet id="add-martImportedReports-table" author="fdelcastillo">
		<createTable tableName="martImportedReports">
			<column name="sequence" type="bigint" />
			<column name="personUuid" type="${uuid_type}" />
			<column name="reportUuid" type="${uuid_type}" />
			<column name="success" type="boolean" />
			<column name="submittedAt" type="datetime" />
			<column name="receivedAt" type="datetime" />
			<column name="errors" type="text" />
		</createTable>
		<addForeignKeyConstraint
			constraintName="fk_martImportedReports_person"
			baseTableName="martImportedReports"
			baseColumnNames="personUuid"
			referencedTableName="people"
			referencedColumnNames="uuid"
			onDelete="CASCADE" onUpdate="NO ACTION"
		/>
	</changeSet>

	<!-- Keep this change set as the last one in the change log;
	     it will be re-run whenever it changes. -->
	<changeSet id="set-up-full-text-search" runOnChange="true" author="gjvoosten">
		<sql>
			<!--
			  Fully self-contained migration for the complete full-text indexing set-up;
			  can be run multiple times, and will be run every time it changes (runOnchange).
			-->

			<!-- Drop materialized views -->
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_attachments;
			DROP MATERIALIZED VIEW IF EXISTS "mv_fts_authorizationGroups";
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_events;
			DROP MATERIALIZED VIEW IF EXISTS "mv_fts_eventSeries";
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_locations;
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_organizations;
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_people;
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_positions;
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_reports;
			DROP MATERIALIZED VIEW IF EXISTS mv_fts_tasks;

			<!-- Drop materialized views for links -->
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_attachments;
			<!-- note: authorizationGroups currently have no links -->
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_events;
			DROP MATERIALIZED VIEW IF EXISTS "mv_lts_eventSeries";
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_locations;
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_organizations;
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_people;
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_positions;
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_reports;
			DROP MATERIALIZED VIEW IF EXISTS mv_lts_tasks;

			<!-- Drop full_text columns -->
			ALTER TABLE attachments DROP COLUMN IF EXISTS full_text;
			ALTER TABLE events DROP COLUMN IF EXISTS full_text;
			ALTER TABLE "eventSeries" DROP COLUMN IF EXISTS full_text;
			ALTER TABLE "authorizationGroups" DROP COLUMN IF EXISTS full_text;
			ALTER TABLE "emailAddresses" DROP COLUMN IF EXISTS full_text;
			ALTER TABLE locations DROP COLUMN IF EXISTS full_text;
			ALTER TABLE notes DROP COLUMN IF EXISTS full_text;
			ALTER TABLE organizations DROP COLUMN IF EXISTS full_text;
			ALTER TABLE people DROP COLUMN IF EXISTS full_text;
			ALTER TABLE positions DROP COLUMN IF EXISTS full_text;
			ALTER TABLE reports DROP COLUMN IF EXISTS full_text;
			ALTER TABLE tasks DROP COLUMN IF EXISTS full_text;

			<!-- Drop core_text columns -->
			ALTER TABLE attachments DROP COLUMN IF EXISTS core_text;
			ALTER TABLE "authorizationGroups" DROP COLUMN IF EXISTS core_text;
			ALTER TABLE "emailAddresses" DROP COLUMN IF EXISTS core_text;
			ALTER TABLE events DROP COLUMN IF EXISTS core_text;
			ALTER TABLE "eventSeries" DROP COLUMN IF EXISTS core_text;
			ALTER TABLE locations DROP COLUMN IF EXISTS core_text;
			ALTER TABLE notes DROP COLUMN IF EXISTS core_text;
			ALTER TABLE organizations DROP COLUMN IF EXISTS core_text;
			ALTER TABLE people DROP COLUMN IF EXISTS core_text;
			ALTER TABLE positions DROP COLUMN IF EXISTS core_text;
			ALTER TABLE reports DROP COLUMN IF EXISTS core_text;
			ALTER TABLE tasks DROP COLUMN IF EXISTS core_text;

			<!-- Drop more_text columns -->
			ALTER TABLE attachments DROP COLUMN IF EXISTS more_text;
			ALTER TABLE "authorizationGroups" DROP COLUMN IF EXISTS more_text;
			ALTER TABLE events DROP COLUMN IF EXISTS more_text;
			ALTER TABLE "eventSeries" DROP COLUMN IF EXISTS more_text;
			ALTER TABLE locations DROP COLUMN IF EXISTS more_text;
			ALTER TABLE organizations DROP COLUMN IF EXISTS more_text;
			ALTER TABLE people DROP COLUMN IF EXISTS more_text;
			ALTER TABLE positions DROP COLUMN IF EXISTS more_text;
			ALTER TABLE reports DROP COLUMN IF EXISTS more_text;
			ALTER TABLE tasks DROP COLUMN IF EXISTS more_text;

			<!-- Drop functions for aggregating JSON values recursively -->
			DROP FUNCTION IF EXISTS jsonb_array_value_agg;
			DROP FUNCTION IF EXISTS jsonb_object_value_agg;
			DROP FUNCTION IF EXISTS jsonb_value_agg;

			<!-- Drop functions used for the materialized view for links -->
			DROP FUNCTION IF EXISTS get_core_text;
			DROP FUNCTION IF EXISTS get_rt_referenced_objects;
			DROP FUNCTION IF EXISTS get_cf_referenced_objects;

			<!-- Define functions for aggregating JSON values recursively -->
			CREATE OR REPLACE FUNCTION jsonb_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN CASE
					WHEN jsonb_typeof(p_json) = ''array'' THEN coalesce(public.jsonb_array_value_agg(p_json, ignore_key), '''')
					WHEN jsonb_typeof(p_json) = ''object'' THEN coalesce(public.jsonb_object_value_agg(p_json, ignore_key), '''')
					WHEN jsonb_typeof(p_json) = ''string''
						AND p_json #>> ''{}'' !~ ''^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{1,3}Z$''
						THEN coalesce(p_json #>> ''{}'', '''')
					ELSE ''''
				END;
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION jsonb_array_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN string_agg(public.jsonb_value_agg(value, ignore_key), '' '')
				FROM jsonb_array_elements(p_json);
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION jsonb_object_value_agg(p_json jsonb, ignore_key text default 'invisibleCustomFields')
				RETURNS text
			AS
			'
			BEGIN
				RETURN string_agg(public.jsonb_value_agg(value, ignore_key), '' '')
				FROM jsonb_each(p_json)
				WHERE key != ignore_key;
			EXCEPTION
				WHEN OTHERS THEN
				RETURN NULL;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			<!-- Create functions used for the materialized view for links -->
			CREATE OR REPLACE FUNCTION get_core_text(object_table text, object_uuid ${uuid_type})
				RETURNS tsvector
			AS
			'
			DECLARE
				result tsvector;
			BEGIN
				IF object_table IS NULL OR object_uuid IS NULL THEN
					return NULL;
				END IF;
				EXECUTE format(
					''SELECT core_text FROM public.%I WHERE uuid = $1'',
					object_table
				)
				INTO result
				USING object_uuid;
				RETURN result;
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION get_rt_referenced_objects(table_name text, column_name text)
				RETURNS table(uuid varchar(36), object_table text, object_uuid text)
			AS
			'
			BEGIN
				RETURN QUERY EXECUTE format(
					''WITH links AS ('' ||
					''  SELECT uuid, regexp_matches(%I, ''''"urn:anet:(attachments|authorizationGroups|events|eventSeries|locations|organizations|people|positions|reports|tasks):([^"]*)"'''', ''''g'''') AS arr FROM public.%I'' ||
					'')'' ||
					''  SELECT uuid, arr[1], arr[2] FROM links'',
					column_name, table_name
				);
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			CREATE OR REPLACE FUNCTION get_cf_referenced_objects(table_name text, column_name text)
				RETURNS table(uuid varchar(36), object_table text, object_uuid text)
			AS
			'
			BEGIN
				RETURN QUERY EXECUTE format(
					''WITH links AS ('' ||
					''  SELECT uuid, regexp_matches(%I, ''''\\"urn:anet:(attachments|authorizationGroups|events|eventSeries|locations|organizations|people|positions|reports|tasks):([^\\]*)\\"|{"type":"(Attachment|AuthorizationGroup|Event|EventSeries|Location|Organization|Person|Position|Report|Task)","uuid":"([^"]*)"}'''', ''''g'''') AS arr FROM public.%I'' ||
					'')'' ||
					''  SELECT uuid,'' ||
					''  CASE WHEN arr[1] IS NOT NULL THEN arr[1] ELSE'' ||
					''    CASE'' ||
					''      WHEN arr[3] = ''''Attachment'''' THEN ''''attachments'''' '' ||
					''      WHEN arr[3] = ''''AuthorizationGroup'''' THEN ''''authorizationGroups'''' '' ||
					''      WHEN arr[3] = ''''Event'''' THEN ''''events'''' '' ||
					''      WHEN arr[3] = ''''EventSeries'''' THEN ''''eventSeries'''' '' ||
					''      WHEN arr[3] = ''''Location'''' THEN ''''locations'''' '' ||
					''      WHEN arr[3] = ''''Organization'''' THEN ''''organizations'''' '' ||
					''      WHEN arr[3] = ''''Person'''' THEN ''''people'''' '' ||
					''      WHEN arr[3] = ''''Position'''' THEN ''''positions'''' '' ||
					''      WHEN arr[3] = ''''Report'''' THEN ''''reports'''' '' ||
					''      WHEN arr[3] = ''''Task'''' THEN ''''tasks'''' '' ||
					''    END'' ||
					''  END,'' ||
					''  CASE WHEN arr[2] IS NOT NULL THEN arr[2] ELSE arr[4] END'' ||
					''  FROM links'',
					column_name, table_name
				);
			END;
			'
			LANGUAGE plpgsql
			IMMUTABLE;

			<!-- Add generated core_text columns -->
			ALTER TABLE attachments
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(attachments.caption, ''))
						|| to_tsvector('simple', coalesce(attachments.caption, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(attachments."fileName", '')), ${fts_high})
				) STORED;

			ALTER TABLE "authorizationGroups"
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".name, ''))
						|| to_tsvector('simple', coalesce("authorizationGroups".name, '')), ${fts_high})
				) STORED;

			ALTER TABLE "emailAddresses"
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce("emailAddresses".address, '')), ${fts_low}) ||
					setweight(to_tsvector('simple', translate(coalesce("emailAddresses".address, ''), '@', ' ')), ${fts_lower}) ||
					setweight(to_tsvector('simple', translate(coalesce("emailAddresses".address, ''), '@.', '  ')), ${fts_lower})
				) STORED;

			ALTER TABLE events
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(events.name, ''))
						|| to_tsvector('simple', coalesce(events.name, '')), ${fts_high})
					) STORED;

			ALTER TABLE "eventSeries"
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("eventSeries".name, ''))
						|| to_tsvector('simple', coalesce("eventSeries".name, '')), ${fts_high})
					) STORED;

			ALTER TABLE locations
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.name, ''))
						|| to_tsvector('simple', coalesce(locations.name, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.digram, ''))
						|| to_tsvector('simple', coalesce(locations.digram, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, coalesce(locations.trigram, ''))
						|| to_tsvector('simple', coalesce(locations.trigram, '')), ${fts_low})
				) STORED;

			ALTER TABLE notes
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(notes.text, ''))
						|| to_tsvector('simple', coalesce(notes.text, '')), ${fts_low})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(organizations."identificationCode", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(organizations."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(organizations."longName", ''))
						|| to_tsvector('simple', coalesce(organizations."longName", '')), ${fts_low})
				) STORED;

			ALTER TABLE people
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people.name, '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people.code, '')), ${fts_high})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(positions.code, '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(positions.name, ''))
						|| to_tsvector('simple', coalesce(positions.name, '')), ${fts_high})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports.intent, ''))
						|| to_tsvector('simple', coalesce(reports.intent, '')), ${fts_high})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN core_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(tasks."shortName", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(tasks."longName", ''))
						|| to_tsvector('simple', coalesce(tasks."longName", '')), ${fts_high})
				) STORED;

			<!-- Add generated more_text columns -->
			ALTER TABLE attachments
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(attachments.description, ''))
						|| to_tsvector('simple', coalesce(attachments.description, '')), ${fts_low})
				) STORED;

			ALTER TABLE "authorizationGroups"
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("authorizationGroups".description, ''))
						|| to_tsvector('simple', coalesce("authorizationGroups".description, '')), ${fts_low})
				) STORED;

			ALTER TABLE events
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(events.description, ''))
						|| to_tsvector('simple', coalesce(events.description, '')), ${fts_low})
					) STORED;

			ALTER TABLE "eventSeries"
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce("eventSeries".description, ''))
						|| to_tsvector('simple', coalesce("eventSeries".description, '')), ${fts_low})
					) STORED;

			ALTER TABLE locations
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(locations.description, ''))
						|| to_tsvector('simple', coalesce(locations.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(locations."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(locations."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE organizations
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(organizations.profile, ''))
						|| to_tsvector('simple', coalesce(organizations.profile, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(organizations."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(organizations."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE people
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector('simple', coalesce(people."domainUsername", '')), ${fts_high}) ||
					setweight(to_tsvector('simple', coalesce(people."phoneNumber", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(people.biography, ''))
						|| to_tsvector('simple', coalesce(people.biography, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(people."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(people."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE positions
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(positions.description, ''))
						|| to_tsvector('simple', coalesce(positions.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(positions."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(positions."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE reports
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(reports."keyOutcomes", ''))
						|| to_tsvector('simple', coalesce(reports."keyOutcomes", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports."nextSteps", ''))
						|| to_tsvector('simple', coalesce(reports."nextSteps", '')), ${fts_high}) ||
					setweight(to_tsvector(${fts_config}, coalesce(reports.text, ''))
						|| to_tsvector('simple', coalesce(reports.text, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(reports."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(reports."customFields"::jsonb)), ${fts_lower})
				) STORED;

			ALTER TABLE tasks
				ADD COLUMN more_text tsvector GENERATED ALWAYS AS (
					setweight(to_tsvector(${fts_config}, coalesce(tasks.description, ''))
						|| to_tsvector('simple', coalesce(tasks.description, '')), ${fts_low}) ||
					setweight(to_tsvector(${fts_config}, jsonb_value_agg(tasks."customFields"::jsonb))
						|| to_tsvector('simple', jsonb_value_agg(tasks."customFields"::jsonb)), ${fts_lower})
				) STORED;

			<!-- Create materialized views for links -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_attachments(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('attachments', 'description')
			)
			SELECT
				attachments.uuid,
				setweight(coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector), ${fts_low})
			FROM attachments
			LEFT JOIN rt_links ON rt_links.uuid = attachments.uuid
			GROUP BY attachments.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_attachments_uuid" ON mv_lts_attachments(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_events(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('events', 'description')
			)
			SELECT
				events.uuid,
				setweight(coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector), ${fts_low})
			FROM events
			LEFT JOIN rt_links ON rt_links.uuid = events.uuid
			GROUP BY events.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_events_uuid" ON mv_lts_events(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_lts_eventSeries"(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('eventSeries', 'description')
			)
			SELECT
				"eventSeries".uuid,
				setweight(coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector), ${fts_low})
			FROM "eventSeries"
			LEFT JOIN rt_links ON rt_links.uuid = "eventSeries".uuid
			GROUP BY "eventSeries".uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_eventSeries_uuid" ON "mv_lts_eventSeries"(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_locations(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('locations', 'description')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('locations', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					locations.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM locations
				LEFT JOIN rt_links ON rt_links.uuid = locations.uuid
				GROUP BY locations.uuid
			UNION ALL
				SELECT
					locations.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM locations
				LEFT JOIN cf_links ON cf_links.uuid = locations.uuid
				GROUP BY locations.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_locations_uuid" ON mv_lts_locations(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_organizations(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('organizations', 'profile')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('organizations', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					organizations.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM organizations
				LEFT JOIN rt_links ON rt_links.uuid = organizations.uuid
				GROUP BY organizations.uuid
			UNION ALL
				SELECT
					organizations.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM organizations
				LEFT JOIN cf_links ON cf_links.uuid = organizations.uuid
				GROUP BY organizations.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_organizations_uuid" ON mv_lts_organizations(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_people(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('people', 'biography')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('people', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					people.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM people
				LEFT JOIN rt_links ON rt_links.uuid = people.uuid
				GROUP BY people.uuid
			UNION ALL
				SELECT
					people.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM people
				LEFT JOIN cf_links ON cf_links.uuid = people.uuid
				GROUP BY people.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_people_uuid" ON mv_lts_people(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_positions(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('positions', 'description')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('positions', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					positions.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM positions
				LEFT JOIN rt_links ON rt_links.uuid = positions.uuid
				GROUP BY positions.uuid
			UNION ALL
				SELECT
					positions.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM positions
				LEFT JOIN cf_links ON cf_links.uuid = positions.uuid
				GROUP BY positions.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_positions_uuid" ON mv_lts_positions(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_reports(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('reports', 'text')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('reports', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					reports.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM reports
				LEFT JOIN rt_links ON rt_links.uuid = reports.uuid
				GROUP BY reports.uuid
			UNION ALL
				SELECT
					reports.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM reports
				LEFT JOIN cf_links ON cf_links.uuid = reports.uuid
				GROUP BY reports.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_reports_uuid" ON mv_lts_reports(uuid);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_lts_tasks(uuid, link_text) AS
			WITH rt_links AS (
				SELECT * FROM get_rt_referenced_objects('tasks', 'description')
			),
			cf_links AS (
				SELECT * FROM get_cf_referenced_objects('tasks', 'customFields')
			)
			SELECT
				links.uuid,
				setweight(coalesce(tsvector_agg(links.agg), ''::tsvector), ${fts_low})
			FROM (
				SELECT
					tasks.uuid,
					coalesce(tsvector_agg(get_core_text(rt_links.object_table, rt_links.object_uuid)), ''::tsvector) AS agg
				FROM tasks
				LEFT JOIN rt_links ON rt_links.uuid = tasks.uuid
				GROUP BY tasks.uuid
			UNION ALL
				SELECT
					tasks.uuid,
					coalesce(tsvector_agg(get_core_text(cf_links.object_table, cf_links.object_uuid)), ''::tsvector) AS agg
				FROM tasks
				LEFT JOIN cf_links ON cf_links.uuid = tasks.uuid
				GROUP BY tasks.uuid
			) AS links
			GROUP BY links.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_lts_tasks" ON mv_lts_tasks(uuid);

			<!-- Create materialized views and indexes for full-text search -->
			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_attachments(uuid, full_text) AS
			SELECT
				attachments.uuid,
				attachments.core_text || attachments.more_text
					|| coalesce(tsvector_agg(mv_lts_attachments.link_text), ''::tsvector)
			FROM attachments
			LEFT JOIN mv_lts_attachments ON attachments.uuid = mv_lts_attachments.uuid
			GROUP BY attachments.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_attachments_uuid" ON mv_fts_attachments(uuid);
			CREATE INDEX "FT_mv_fts_attachments" ON mv_fts_attachments USING gin(full_text);
			CREATE INDEX "TR_attachments_uuid" ON mv_fts_attachments USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_authorizationGroups"(uuid, full_text) AS
			SELECT
				"authorizationGroups".uuid,
				"authorizationGroups".core_text || "authorizationGroups".more_text
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
			FROM "authorizationGroups"
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'authorizationGroups'
				AND "noteRelatedObjects"."relatedObjectUuid" = "authorizationGroups".uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY "authorizationGroups".uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_authorizationGroups_uuid" ON "mv_fts_authorizationGroups"(uuid);
			CREATE INDEX "FT_mv_fts_authorizationGroups" ON "mv_fts_authorizationGroups" USING gin(full_text);
			CREATE INDEX "TR_authorizationGroups_uuid" ON "mv_fts_authorizationGroups" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_events(uuid, full_text) AS
			SELECT
				events.uuid,
				events.core_text || events.more_text
					|| coalesce(tsvector_agg(mv_lts_events.link_text), ''::tsvector)
			FROM events
			LEFT JOIN mv_lts_events ON events.uuid = mv_lts_events.uuid
			GROUP BY events.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_events_uuid" ON mv_fts_events(uuid);
			CREATE INDEX "FT_mv_fts_events" ON mv_fts_events USING gin(full_text);
			CREATE INDEX "TR_events_uuid" ON mv_fts_events USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_fts_eventSeries"(uuid, full_text) AS
			SELECT
				"eventSeries".uuid,
				"eventSeries".core_text || "eventSeries".more_text
					|| coalesce(tsvector_agg("mv_lts_eventSeries".link_text), ''::tsvector)
			FROM "eventSeries"
			LEFT JOIN "mv_lts_eventSeries" ON "eventSeries".uuid = "mv_lts_eventSeries".uuid
			GROUP BY "eventSeries".uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_eventSeries_uuid" ON "mv_fts_eventSeries"(uuid);
			CREATE INDEX "FT_mv_fts_eventSeries" ON "mv_fts_eventSeries" USING gin(full_text);
			CREATE INDEX "TR_eventSeries_uuid" ON "mv_fts_eventSeries" USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_locations(uuid, full_text) AS
			SELECT
				locations.uuid,
				locations.core_text || locations.more_text
					|| coalesce(tsvector_agg(mv_lts_locations.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
			FROM locations
			LEFT JOIN mv_lts_locations ON locations.uuid = mv_lts_locations.uuid
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'locations'
				AND "noteRelatedObjects"."relatedObjectUuid" = locations.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY locations.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_locations_uuid" ON mv_fts_locations(uuid);
			CREATE INDEX "FT_mv_fts_locations" ON mv_fts_locations USING gin(full_text);
			CREATE INDEX "TR_locations_uuid" ON mv_fts_locations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_organizations(uuid, full_text) AS
			SELECT
				organizations.uuid,
				organizations.core_text || organizations.more_text
					|| coalesce(tsvector_agg(mv_lts_organizations.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".core_text), ''::tsvector)
			FROM organizations
			LEFT JOIN mv_lts_organizations ON organizations.uuid = mv_lts_organizations.uuid
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'organizations'
				AND "noteRelatedObjects"."relatedObjectUuid" = organizations.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'organizations'
				AND "emailAddresses"."relatedObjectUuid" = organizations.uuid
			GROUP BY organizations.uuid
				WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_organizations_uuid" ON mv_fts_organizations(uuid);
			CREATE INDEX "FT_mv_fts_organizations" ON mv_fts_organizations USING gin(full_text);
			CREATE INDEX "TR_organizations_uuid" ON mv_fts_organizations USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_people(uuid, full_text) AS
			SELECT
				people.uuid,
				people.core_text || people.more_text
					|| coalesce(tsvector_agg(mv_lts_people.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(positions.core_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.core_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".core_text), ''::tsvector)
			FROM people
			LEFT JOIN mv_lts_people ON people.uuid = mv_lts_people.uuid
			LEFT JOIN positions ON positions."currentPersonUuid" = people.uuid
			LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'people'
				AND "noteRelatedObjects"."relatedObjectUuid" = people.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'people'
				AND "emailAddresses"."relatedObjectUuid" = people.uuid
			GROUP BY people.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_people_uuid" ON mv_fts_people(uuid);
			CREATE INDEX "FT_mv_fts_people" ON mv_fts_people USING gin(full_text);
			CREATE INDEX "TR_people_uuid" ON mv_fts_people USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_positions(uuid, full_text) AS
			SELECT
				positions.uuid,
				positions.core_text || positions.more_text
					|| coalesce(tsvector_agg(mv_lts_positions.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(people.core_text), ''::tsvector)
					|| coalesce(tsvector_agg(organizations.core_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
					|| coalesce(tsvector_agg("emailAddresses".core_text), ''::tsvector)
			FROM positions
			LEFT JOIN mv_lts_positions ON positions.uuid = mv_lts_positions.uuid
			LEFT JOIN people ON people.uuid = positions."currentPersonUuid"
			LEFT JOIN organizations ON organizations.uuid = positions."organizationUuid"
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'positions'
				AND "noteRelatedObjects"."relatedObjectUuid" = positions.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			LEFT JOIN "emailAddresses" ON "emailAddresses"."relatedObjectType" = 'positions'
				AND "emailAddresses"."relatedObjectUuid" = positions.uuid
			GROUP BY positions.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_positions" ON mv_fts_positions(uuid);
			CREATE INDEX "FT_mv_fts_positions" ON mv_fts_positions USING gin(full_text);
			CREATE INDEX "TR_positions_uuid" ON mv_fts_positions USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_reports(uuid, full_text) AS
			SELECT
				reports.uuid,
				reports.core_text || reports.more_text
					|| coalesce(tsvector_agg(mv_lts_reports.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
			FROM reports
			LEFT JOIN mv_lts_reports ON reports.uuid = mv_lts_reports.uuid
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'reports'
				AND "noteRelatedObjects"."relatedObjectUuid" = reports.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY reports.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_reports_uuid" ON mv_fts_reports(uuid);
			CREATE INDEX "FT_mv_fts_reports" ON mv_fts_reports USING gin(full_text);
			CREATE INDEX "TR_reports_uuid" ON mv_fts_reports USING gin(uuid gin_trgm_ops);

			CREATE MATERIALIZED VIEW IF NOT EXISTS mv_fts_tasks(uuid, full_text) AS
			SELECT
				tasks.uuid,
				tasks.core_text || tasks.more_text
					|| coalesce(tsvector_agg(mv_lts_tasks.link_text), ''::tsvector)
					|| coalesce(tsvector_agg(notes.core_text), ''::tsvector)
			FROM tasks
			LEFT JOIN mv_lts_tasks ON tasks.uuid = mv_lts_tasks.uuid
			LEFT JOIN "noteRelatedObjects" ON "noteRelatedObjects"."relatedObjectType" = 'tasks'
				AND "noteRelatedObjects"."relatedObjectUuid" = tasks.uuid
			LEFT JOIN notes ON notes.uuid = "noteRelatedObjects"."noteUuid"
			GROUP BY tasks.uuid
			WITH DATA;
			CREATE UNIQUE INDEX "UQ_mv_fts_tasks" ON mv_fts_tasks(uuid);
			CREATE INDEX "FT_mv_fts_tasks" ON mv_fts_tasks USING gin(full_text);
			CREATE INDEX "TR_tasks_uuid" ON mv_fts_tasks USING gin(uuid gin_trgm_ops);
		</sql>
	</changeSet>

</databaseChangeLog>
